<!doctype html>
<html lang="tr" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ã–ÄŸrenci Takip Sistemi</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/recharts@2.10.3/dist/Recharts.js"></script>
  <script src="https://unpkg.com/react-calendar-heatmap@1.10.0/dist/react-calendar-heatmap.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/react-calendar-heatmap@1.10.0/dist/react-calendar-heatmap.css">
  <script>
    window.__APP_CONFIG = {
      SUPABASE_URL: 'https://mnwxfknxkwwurrevmlri.supabase.co',
      SUPABASE_ANON_KEY: 'sb_publishable_qci3p2BNw3oqVNwd4Fhq9A_pgwOZrpc',
      APP_TITLE: 'Ã–ÄŸrenci Takip Sistemi',
      LOGIN_PASSWORD: '1234'
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Plus Jakarta Sans', sans-serif; }
    html, body, #root { height: 100%; width: 100%; margin: 0; padding: 0; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px -12px rgba(59, 130, 246, 0.15); }
    .nav-link { position: relative; transition: color 0.2s; }
    .nav-link::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 0; height: 2px; background: #3B82F6; transition: width 0.3s; border-radius: 2px; }
    .nav-link:hover::after, .nav-link.active::after { width: 100%; }
    .slide-up { animation: slideUp 0.5s ease-out forwards; opacity: 0; }
    @keyframes slideUp { to { opacity: 1; transform: translateY(0); } from { opacity: 0; transform: translateY(20px); } }
    .modal-backdrop { animation: backdropIn 0.2s ease-out; }
    @keyframes backdropIn { from { opacity: 0; } to { opacity: 1; } }
    .toast-enter { animation: toastIn 0.3s ease-out; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); border-color: #3B82F6; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .heatmap-container { overflow-x: auto; }
    .react-calendar-heatmap text { font-size: 9px; fill: #64748B; }
    .react-calendar-heatmap .color-empty { fill: #ebedf0; }
    .react-calendar-heatmap .color-low { fill: #7bc96f; }
    .react-calendar-heatmap .color-mid { fill: #239a3b; }
    .react-calendar-heatmap .color-high { fill: #196127; }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full">
  <div id="root" class="h-full"></div>
  <script type="text/babel">
const { useState, useEffect, useCallback, useMemo } = React;

const Icons = {
  GraduationCap: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.08a1 1 0 0 0 0 1.832l8.57 3.908a2 2 0 0 0 1.66 0z"/><path d="M22 10v6"/><path d="M6 12.5V16a6 3 0 0 0 12 0v-3.5"/></svg>,
  Users: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
  BookOpen: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M12 7v14"/><path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"/></svg>,
  FileText: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>,
  BarChart3: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M3 3v16a2 2 0 0 0 2 2h16"/><path d="M7 16h8"/><path d="M7 11h12"/><path d="M7 6h3"/></svg>,
  LayoutDashboard: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
  Plus: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
  Trash2: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
  X: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
  Check: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M20 6 9 17l-5-5"/></svg>,
  Edit: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg>,
  Menu: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
};

const studentColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];

const defaultConfig = {
  app_title: (window.__APP_CONFIG && window.__APP_CONFIG.APP_TITLE) || 'Ã–ÄŸrenci Takip Sistemi',
  welcome_title: 'HoÅŸ Geldiniz ðŸ‘‹',
  welcome_subtitle: 'LÃ¼tfen menÃ¼den bir bÃ¶lÃ¼m seÃ§in',
  background_color: '#F8FAFC',
  surface_color: '#FFFFFF',
  text_color: '#1E293B',
  primary_action_color: '#3B82F6',
  secondary_action_color: '#64748B',
  font_family: 'Plus Jakarta Sans',
  font_size: 16,
};

let allData = [];
let dataChangeListeners = [];
function subscribeData(fn) { dataChangeListeners.push(fn); return () => { dataChangeListeners = dataChangeListeners.filter(f => f !== fn); }; }
function notifyDataChange(d) { allData = d; dataChangeListeners.forEach(fn => fn(d)); }
window.notifyDataChange = notifyDataChange;

function useAppData() {
  const [data, setData] = useState(allData);
  useEffect(() => subscribeData(setData), []);
  const students = useMemo(() => data.filter(d => d.type === 'student'), [data]);
  const studies = useMemo(() => data.filter(d => d.type === 'study'), [data]);
  const exams = useMemo(() => data.filter(d => d.type === 'exam'), [data]);
  const definedExams = useMemo(() => data.filter(d => d.type === 'defined_exam'), [data]);
  const quickStudies = useMemo(() => data.filter(d => d.type === 'quick_study'), [data]);
  return { students, studies, exams, definedExams, quickStudies, allData: data };
}

let appConfig = { ...defaultConfig };
let configListeners = [];
function subscribeConfig(fn) { configListeners.push(fn); return () => { configListeners = configListeners.filter(f => f !== fn); }; }
function notifyConfigChange(c) { appConfig = c; configListeners.forEach(fn => fn({...c})); }
function useConfig() {
  const [cfg, setCfg] = useState(appConfig);
  useEffect(() => subscribeConfig(setCfg), []);
  return cfg;
}

function useRouter() {
  const [route, setRoute] = useState('home');
  const navigate = useCallback((r) => setRoute(r), []);
  return { route, navigate };
}

function Toast({ message, type, onClose }) {
  useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
  const bg = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
  return (
    <div className={`fixed top-4 right-4 z-50 toast-enter ${bg} text-white px-5 py-3 rounded-xl shadow-lg flex items-center gap-2`}>
      {type === 'success' ? <Icons.Check size={18}/> : null}
      <span className="text-sm font-medium">{message}</span>
      <button onClick={onClose} className="ml-2 hover:opacity-70"><Icons.X size={16}/></button>
    </div>
  );
}

function ConfirmModal({ message, onConfirm, onCancel }) {
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
      <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 fade-in">
        <p className="text-gray-800 font-medium mb-5">{message}</p>
        <div className="flex gap-3 justify-end">
          <button onClick={onCancel} className="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-100 font-medium text-sm transition-colors">Ä°ptal</button>
          <button onClick={onConfirm} className="px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600 font-medium text-sm transition-colors">Sil</button>
        </div>
      </div>
    </div>
  );
}

function Spinner({ size = 'md' }) {
  const s = size === 'sm' ? 'w-4 h-4' : size === 'lg' ? 'w-8 h-8' : 'w-5 h-5';
  return <div className={`${s} border-2 border-blue-200 border-t-blue-500 rounded-full animate-spin`}></div>;
}

function Header({ route, navigate, config, onLogout }) {
  const [mobileOpen, setMobileOpen] = useState(false);
  const links = [
    { id: 'ogrenciler', label: 'Ã–ÄŸrenciler', icon: Icons.Users },
    { id: 'gunluk-calisma', label: 'GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma', icon: Icons.BookOpen },
    { id: 'deneme-girisi', label: 'Deneme GiriÅŸi', icon: Icons.FileText },
    { id: 'analiz', label: 'Analiz', icon: Icons.BarChart3 },
    { id: 'dashboard', label: 'Dashboard', icon: Icons.LayoutDashboard },
  ];
  return (
    <header className="sticky top-0 z-40 border-b" style={{ background: config.surface_color, borderColor: '#E2E8F0' }}>
      <div className="max-w-7xl mx-auto px-4 sm:px-6">
        <div className="flex items-center justify-between h-16">
          <button onClick={() => navigate('home')} className="flex items-center gap-2.5 group">
            <div className="w-9 h-9 rounded-xl flex items-center justify-center" style={{background: config.primary_action_color}}>
              <Icons.GraduationCap size={20} className="text-white"/>
            </div>
            <span className="font-bold text-base hidden sm:block" style={{color: config.text_color}}>{config.app_title}</span>
          </button>
          <nav className="hidden md:flex items-center gap-1">
            {links.map(l => (
              <button key={l.id} onClick={() => navigate(l.id)}
                className={`nav-link px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1.5 transition-colors ${route === l.id ? 'active text-blue-600 bg-blue-50' : ''}`}
                style={{ color: route === l.id ? config.primary_action_color : config.secondary_action_color }}>
                <l.icon size={16}/> {l.label}
              </button>
            ))}
          </nav>
          <div className="flex items-center gap-2">
            <button onClick={onLogout} className="hidden sm:flex px-4 py-2 rounded-lg text-sm font-semibold transition-all items-center gap-1.5 hover:bg-red-50" style={{color: config.secondary_action_color}}>
              ðŸšª Ã‡Ä±kÄ±ÅŸ
            </button>
            <button onClick={() => setMobileOpen(!mobileOpen)} className="md:hidden p-2 rounded-lg hover:bg-gray-100">
              <Icons.Menu size={22} className="text-gray-600"/>
            </button>
          </div>
        </div>
      </div>
      {mobileOpen && (
        <div className="md:hidden border-t border-gray-100 fade-in" style={{background: config.surface_color}}>
          <nav className="px-4 py-3 flex flex-col gap-1">
            {links.map(l => (
              <button key={l.id} onClick={() => { navigate(l.id); setMobileOpen(false); }}
                className={`px-3 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${route === l.id ? 'bg-blue-50' : 'hover:bg-gray-50'}`}
                style={{ color: route === l.id ? config.primary_action_color : config.secondary_action_color }}>
                <l.icon size={16}/> {l.label}
              </button>
            ))}
            <button onClick={() => { onLogout(); setMobileOpen(false); }} className="px-3 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors hover:bg-red-50" style={{color: config.secondary_action_color}}>
              ðŸšª Ã‡Ä±kÄ±ÅŸ
            </button>
          </nav>
        </div>
      )}
    </header>
  );
}

function HomePage({ navigate, config }) {
  const { students, studies, exams } = useAppData();
  const examCount = exams.length;
  const cards = [
    { id: 'ogrenciler', title: 'Ã–ÄŸrenciler', desc: 'Ã–ÄŸrenci kayÄ±tlarÄ±nÄ± yÃ¶netin', icon: Icons.Users, count: students.length, color: '#3B82F6', bg: '#EFF6FF' },
    { id: 'gunluk-calisma', title: 'GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma', desc: 'Ã‡alÄ±ÅŸma kayÄ±tlarÄ±nÄ± takip edin', icon: Icons.BookOpen, count: studies.length, color: '#10B981', bg: '#ECFDF5' },
    { id: 'deneme-girisi', title: 'Deneme GiriÅŸi', desc: 'Deneme sonuÃ§larÄ±nÄ± kaydedin', icon: Icons.FileText, count: examCount, color: '#F59E0B', bg: '#FFFBEB' },
    { id: 'analiz', title: 'Analiz', desc: 'Performans analizlerini gÃ¶rÃ¼n', icon: Icons.BarChart3, count: null, color: '#8B5CF6', bg: '#F5F3FF' },
    { id: 'dashboard', title: 'Dashboard', desc: 'Genel bakÄ±ÅŸ ve Ã¶zet', icon: Icons.LayoutDashboard, count: null, color: '#EC4899', bg: '#FDF2F8' },
  ];
  return (
    <div className="max-w-5xl mx-auto px-4 py-10 fade-in">
      <div className="text-center mb-10">
        <h1 className="text-3xl sm:text-4xl font-extrabold mb-3" style={{color: config.text_color}}>{config.welcome_title}</h1>
        <p className="text-base sm:text-lg" style={{color: config.secondary_action_color}}>{config.welcome_subtitle}</p>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
        {cards.map((c, i) => (
          <button key={c.id} onClick={() => navigate(c.id)}
            className="card-hover rounded-2xl p-6 text-left border border-gray-100 slide-up"
            style={{ background: config.surface_color, animationDelay: `${i * 0.08}s` }}>
            <div className="flex items-start justify-between mb-4">
              <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{background: c.bg}}>
                <c.icon size={24} style={{color: c.color}}/>
              </div>
              {c.count !== null && (
                <span className="text-xs font-bold px-2.5 py-1 rounded-full" style={{background: c.bg, color: c.color}}>{c.count}</span>
              )}
            </div>
            <h3 className="font-bold text-base mb-1" style={{color: config.text_color}}>{c.title}</h3>
            <p className="text-sm" style={{color: config.secondary_action_color}}>{c.desc}</p>
          </button>
        ))}
      </div>
    </div>
  );
}

function StudentsPage({ config, onSelectStudent }) {
  const { students, exams } = useAppData();
  const [showForm, setShowForm] = useState(false);
  const [loading, setLoading] = useState(false);
  const [toast, setToast] = useState(null);
  const [editingStudent, setEditingStudent] = useState(null);
  const [form, setForm] = useState({ fullName: '', sinif: '8A', okulNo: '' });

  const resetForm = () => { setForm({ fullName: '', sinif: '8A', okulNo: '' }); setEditingStudent(null); };

  const splitName = (full) => {
    const parts = full.trim().split(/\s+/);
    const name = parts.shift() || '';
    const surname = parts.join(' ');
    return { name, surname };
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!form.fullName.trim() || !form.sinif || !form.okulNo.trim()) {
      setToast({ msg: 'LÃ¼tfen tÃ¼m alanlarÄ± doldurun', type: 'error' });
      return;
    }
    if (students.length >= 999 && !editingStudent) {
      setToast({ msg: 'Maksimum kayÄ±t limitine ulaÅŸÄ±ldÄ± (999)', type: 'error' });
      return;
    }

    const { name, surname } = splitName(form.fullName);
    setLoading(true);
    const payload = {
      type: 'student',
      ad_soyad: form.fullName.trim(),
      sinif: form.sinif,
      okul_numarasi: form.okulNo.trim(),
      student_name: name,
      student_surname: surname,
      student_number: form.okulNo.trim(),
      kayit_tarihi: new Date().toISOString().split('T')[0],
      created_at: new Date().toISOString(),
    };
    const result = editingStudent
      ? await window.dataSdk.update({ ...editingStudent, ...payload })
      : await window.dataSdk.create(payload);
    setLoading(false);

    if (result.isOk) {
      setToast({ msg: editingStudent ? 'Ã–ÄŸrenci gÃ¼ncellendi!' : 'Ã–ÄŸrenci eklendi!', type: 'success' });
      setShowForm(false);
      resetForm();
    } else {
      setToast({ msg: 'Hata oluÅŸtu', type: 'error' });
    }
  };

  const startEdit = (s) => {
    setForm({
      fullName: s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim(),
      sinif: s.sinif || '8A',
      okulNo: s.okul_numarasi || s.student_number || ''
    });
    setEditingStudent(s);
    setShowForm(true);
  };

  const getStudentSummary = (s) => {
    const studentExams = exams.filter(e => e.student_id === s.__backendId);
    if (studentExams.length === 0) return 'HenÃ¼z deneme yok';
    const sorted = [...studentExams].sort((a, b) => new Date(b.exam_date || b.created_at) - new Date(a.exam_date || a.created_at));
    const last = sorted[0];
    return `${studentExams.length} deneme â€¢ Son deneme: ${parseFloat(last.exam_total_net || 0).toFixed(1)} net`;
  };

  return (
    <div className="max-w-6xl mx-auto px-4 py-8 fade-in">
      {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)}/>}

      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-extrabold" style={{color: config.text_color}}>Ã–ÄŸrenciler</h1>
          <p className="text-sm mt-1" style={{color: config.secondary_action_color}}>{students.length} Ã¶ÄŸrenci kayÄ±tlÄ±</p>
        </div>
        <button onClick={() => { resetForm(); setShowForm(true); }}
          className="flex items-center gap-2 px-5 py-2.5 rounded-xl text-white text-sm font-semibold transition-all hover:shadow-lg"
          style={{ background: config.primary_action_color }}>
          <Icons.Plus size={18}/> Ã–ÄŸrenci Ekle
        </button>
      </div>

      {showForm && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 fade-in">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold" style={{color: config.text_color}}>
                {editingStudent ? 'Ã–ÄŸrenciyi DÃ¼zenle' : 'Yeni Ã–ÄŸrenci Ekle'}
              </h2>
              <button onClick={() => { setShowForm(false); resetForm(); }} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Ad Soyad *</label>
                <input value={form.fullName} onChange={(e) => setForm({...form, fullName: e.target.value})}
                  className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium" placeholder="Ã–rn: Ahmet YÄ±lmaz"/>
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>SÄ±nÄ±f *</label>
                  <select value={form.sinif} onChange={(e) => setForm({...form, sinif: e.target.value})}
                    className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium">
                    {['8A','8B','8C','8D','8E','8F'].map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Okul NumarasÄ± *</label>
                  <input value={form.okulNo} onChange={(e) => setForm({...form, okulNo: e.target.value})}
                    className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium" placeholder="Ã–rn: 1254"/>
                </div>
              </div>
              <div className="flex gap-3 justify-end pt-2">
                <button type="button" onClick={() => { setShowForm(false); resetForm(); }}
                  className="px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold">Ä°ptal</button>
                <button type="submit" disabled={loading}
                  className="px-5 py-2 rounded-lg text-white text-sm font-semibold transition-all hover:shadow-lg"
                  style={{ background: config.primary_action_color }}>
                  {loading ? 'Kaydediliyor...' : 'Kaydet'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {students.length === 0 ? (
        <div className="text-center py-12 rounded-2xl border-2 border-dashed border-gray-300">
          <p className="text-lg font-medium" style={{ color: config.secondary_action_color }}>HenÃ¼z Ã¶ÄŸrenci yok</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          {students.map((s, idx) => (
            <button key={s.__backendId} onClick={() => onSelectStudent(s.__backendId)}
              className="rounded-2xl border border-gray-100 p-6 text-left card-hover transition-all"
              style={{background: config.surface_color}}>
              <div className="flex items-start justify-between mb-4">
                <div className="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-lg" style={{background: studentColors[idx % studentColors.length]}}>
                  {((s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim() || '?')[0] || '?').toUpperCase()}
                </div>
                <div className="text-xs px-2 py-1 rounded-full" style={{ background: '#F1F5F9', color: config.secondary_action_color }}>
                  {s.sinif || 'SÄ±nÄ±f?'}
                </div>
              </div>
              <h3 className="text-lg font-bold mb-1" style={{color: config.text_color}}>
                {s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim()}
              </h3>
              <p className="text-sm" style={{color: config.secondary_action_color}}>
                {s.sinif || 'SÄ±nÄ±f?'} â€¢ No: {s.okul_numarasi || s.student_number || '-'}
              </p>
              <p className="text-xs mt-3" style={{color: config.secondary_action_color}}>
                {getStudentSummary(s)}
              </p>
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

function StudentDetailPage({ config, studentId, onBack }) {
  const { students, exams, quickStudies } = useAppData();
  const [detailModal, setDetailModal] = useState(null);
  const [editModal, setEditModal] = useState(false);
  const [confirmDel, setConfirmDel] = useState(false);
  const [showAllExams, setShowAllExams] = useState(false);
  const [showAllStudies, setShowAllStudies] = useState(false);
  const [showWeekDetail, setShowWeekDetail] = useState(null);
  const [selectedStudyIds, setSelectedStudyIds] = useState([]);
  const [editingStudy, setEditingStudy] = useState(null);
  const [saving, setSaving] = useState(false);
  const [form, setForm] = useState({ fullName: '', sinif: '8A', okulNo: '' });
  const [lessonRange, setLessonRange] = useState(30);
  const weekdays = ['Paz', 'Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt'];
  const monthNames = ['Ocak','Åžubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
  const start = new Date(yearStart);
  const end = new Date(yearEnd);
  const days = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    const dateStr = toDateKey(d);
    days.push({
      date: new Date(d),
      dateStr,
      count: dailyTotalsMap[dateStr] || 0
    });
  }
  const weeks = [];
  let week = new Array(7).fill(null);
  days.forEach(day => {
    const dayOfWeek = day.date.getDay();
    week[dayOfWeek] = day;
    if (dayOfWeek === 6) {
      weeks.push(week);
      week = new Array(7).fill(null);
    }
  });
  if (week.some(Boolean)) weeks.push(week);
  const monthPositions = {};
  weeks.forEach((w, idx) => {
    const firstDay = w.find(d => d && d.date.getDate() === 1);
    if (firstDay) {
      monthPositions[idx] = monthNames[firstDay.date.getMonth()];
    }
  });
  const {
    ResponsiveContainer,
    LineChart,
    CartesianGrid,
    XAxis,
    YAxis,
    Tooltip,
    Line,
    BarChart,
    Bar,
    PieChart,
    Pie
  } = window.Recharts || {};

  const student = students.find(s => s.__backendId === studentId);
  if (!student) {
    return (
      <div className="max-w-6xl mx-auto px-4 py-8">
        <button onClick={onBack} className="px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold">Geri</button>
        <div className="mt-6 text-center text-sm" style={{ color: config.secondary_action_color }}>Ã–ÄŸrenci bulunamadÄ±</div>
      </div>
    );
  }

  const displayName = student.ad_soyad || `${student.student_name || ''} ${student.student_surname || ''}`.trim();
  const displayClass = student.sinif || 'SÄ±nÄ±f?';
  const displayNo = student.okul_numarasi || student.student_number || '-';

  const studentExams = exams
    .filter(e => e.student_id === studentId)
    .sort((a, b) => new Date(a.exam_date || a.created_at) - new Date(b.exam_date || b.created_at));

  const totalExams = studentExams.length;
  const totalNetSum = studentExams.reduce((sum, e) => sum + parseFloat(e.exam_total_net || 0), 0);
  const avgNet = totalExams ? (totalNetSum / totalExams).toFixed(2) : '0.00';
  const maxNet = totalExams ? Math.max(...studentExams.map(e => parseFloat(e.exam_total_net || 0))).toFixed(2) : '0.00';
  const minNet = totalExams ? Math.min(...studentExams.map(e => parseFloat(e.exam_total_net || 0))).toFixed(2) : '0.00';
  const lastNet = totalExams ? parseFloat(studentExams[studentExams.length - 1].exam_total_net || 0).toFixed(2) : '0.00';

  const recentExams = studentExams.slice(-10);
  const netSeries = recentExams.map((e) => ({
    date: (e.exam_date || e.created_at || '').toString().split('T')[0],
    total: parseFloat(e.exam_total_net || 0),
    name: e.exam_name || ''
  }));

  const subjects = ['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din'];
  const subjectLabels = {
    turkce: 'TÃ¼rkÃ§e',
    matematik: 'Matematik',
    fen: 'Fen',
    inkilap: 'Sosyal',
    ingilizce: 'Ä°ngilizce',
    din: 'Din'
  };
  const subjectSeries = subjects.map(key => {
    const series = recentExams.slice(-6).map(e => {
      let subj = {};
      try {
        subj = typeof e.exam_subjects === 'string' ? JSON.parse(e.exam_subjects) : e.exam_subjects || {};
      } catch {}
      if (subj[key]) {
        return parseFloat((parseFloat(subj[key].dogru || 0) - (parseFloat(subj[key].yanlis || 0) / 3)).toFixed(2));
      }
      return 0;
    });
    return { key, name: subjectLabels[key], series };
  });

  const lastExams = [...studentExams].reverse().slice(0, 10);

  const studentQuick = (quickStudies || []).filter(q => q.student_id === studentId);
  const today = new Date();
  const yearStart = new Date(today.getFullYear(), 0, 1);
  const yearEnd = new Date(today.getFullYear(), 11, 31);
  const toLocalDate = (d) => {
    if (!d) return null;
    if (typeof d === 'string') {
      const m = d.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return new Date(parseInt(m[1], 10), parseInt(m[2], 10) - 1, parseInt(m[3], 10));
    }
    const dt = new Date(d);
    if (Number.isNaN(dt.getTime())) return null;
    return dt;
  };
  const toDateKey = (d) => {
    if (!d) return '';
    if (typeof d === 'string') {
      const m = d.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;
    }
    const dt = toLocalDate(d);
    if (!dt) return '';
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  };
  const dailyTotalsMap = {};
  studentQuick.forEach(q => {
    const dateKey = q.study_date ? toDateKey(q.study_date) : '';
    if (!dateKey) return;
    const total = [
      q.tur_d, q.tur_y, q.tur_b,
      q.mat_d, q.mat_y, q.mat_b,
      q.fen_d, q.fen_y, q.fen_b,
      q.ink_d, q.ink_y, q.ink_b,
      q.din_d, q.din_y, q.din_b,
      q.ing_d, q.ing_y, q.ing_b,
    ].reduce((s, v) => s + (parseInt(v || 0, 10)), 0);
    dailyTotalsMap[dateKey] = (dailyTotalsMap[dateKey] || 0) + total;
  });
  const subjectKeys = [
    { key: 'tur', label: 'TÃ¼rkÃ§e', color: '#e74c3c' },
    { key: 'mat', label: 'Matematik', color: '#3498db' },
    { key: 'fen', label: 'Fen', color: '#2ecc71' },
    { key: 'ink', label: 'Sosyal', color: '#f39c12' },
    { key: 'ing', label: 'Ä°ngilizce', color: '#9b59b6' },
    { key: 'din', label: 'Din', color: '#16a34a' },
  ];
  const dailySubjectMap = {};
  studentQuick.forEach(q => {
    const dateKey = q.study_date ? toDateKey(q.study_date) : '';
    if (!dateKey) return;
    if (!dailySubjectMap[dateKey]) dailySubjectMap[dateKey] = { tur: 0, mat: 0, fen: 0, ink: 0, ing: 0, din: 0 };
    dailySubjectMap[dateKey].tur += (q.tur_d || 0) + (q.tur_y || 0) + (q.tur_b || 0);
    dailySubjectMap[dateKey].mat += (q.mat_d || 0) + (q.mat_y || 0) + (q.mat_b || 0);
    dailySubjectMap[dateKey].fen += (q.fen_d || 0) + (q.fen_y || 0) + (q.fen_b || 0);
    dailySubjectMap[dateKey].ink += (q.ink_d || 0) + (q.ink_y || 0) + (q.ink_b || 0);
    dailySubjectMap[dateKey].ing += (q.ing_d || 0) + (q.ing_y || 0) + (q.ing_b || 0);
    dailySubjectMap[dateKey].din += (q.din_d || 0) + (q.din_y || 0) + (q.din_b || 0);
  });
  const heatmapValues = Object.entries(dailyTotalsMap).map(([date, count]) => ({ date, count }));
  const startOfWeek = (d) => {
    const date = new Date(d);
    const day = date.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    date.setDate(date.getDate() + diff);
    date.setHours(0, 0, 0, 0);
    return date;
  };
  const weeklyStats = [];
  for (let i = 0; i < 4; i++) {
    const end = new Date(startOfWeek(today));
    end.setDate(end.getDate() - (i * 7));
    const start = new Date(end);
    const label = i === 0 ? 'Bu hafta' : i === 1 ? 'GeÃ§en hafta' : `${i} hafta Ã¶nce`;
    let daysWorked = 0;
    const days = [];
    for (let d = new Date(start); d < new Date(start.getTime() + 7 * 24 * 60 * 60 * 1000); d.setDate(d.getDate() + 1)) {
      const key = toDateKey(d);
      const worked = (dailyTotalsMap[key] || 0) > 0;
      if (worked) daysWorked += 1;
      days.push({ date: new Date(d), worked });
    }
    const pct = ((daysWorked / 7) * 100).toFixed(1);
    const emoji = daysWorked === 7 ? 'ðŸ”¥' : daysWorked >= 5 ? 'ðŸ’ª' : daysWorked >= 3 ? 'ðŸ‘' : daysWorked >= 1 ? 'âš ï¸' : 'âŒ';
    weeklyStats.push({ label, daysWorked, pct, emoji, days });
  }

  const handleEditOpen = () => {
    setForm({
      fullName: displayName,
      sinif: displayClass,
      okulNo: displayNo === '-' ? '' : displayNo
    });
    setEditModal(true);
  };

  const handleUpdate = async (e) => {
    e.preventDefault();
    if (!form.fullName.trim() || !form.sinif || !form.okulNo.trim()) return;
    const parts = form.fullName.trim().split(/\s+/);
    const name = parts.shift() || '';
    const surname = parts.join(' ');
    setSaving(true);
    const result = await window.dataSdk.update({
      ...student,
      type: 'student',
      ad_soyad: form.fullName.trim(),
      sinif: form.sinif,
      okul_numarasi: form.okulNo.trim(),
      student_name: name,
      student_surname: surname,
      student_number: form.okulNo.trim(),
    });
    setSaving(false);
    if (result.isOk) setEditModal(false);
  };

  const handleDelete = async () => {
    setSaving(true);
    const result = await window.dataSdk.delete(student);
    setSaving(false);
    setConfirmDel(false);
    if (result.isOk) onBack();
  };

  return (
    <div className="max-w-6xl mx-auto px-4 py-8 fade-in">
      <div className="flex items-center justify-between mb-6">
        <button onClick={onBack} className="px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold">Geri</button>
        <div className="flex gap-2">
          <button onClick={handleEditOpen} className="px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold">DÃ¼zenle</button>
          <button onClick={() => setConfirmDel(true)} className="px-4 py-2 rounded-lg bg-red-500 text-white text-sm font-semibold">Sil</button>
        </div>
      </div>

      <div className="rounded-2xl p-6 border border-gray-100 mb-6" style={{ background: config.surface_color }}>
        <h1 className="text-2xl font-bold mb-2" style={{ color: config.text_color }}>{displayName}</h1>
        <p className="text-sm" style={{ color: config.secondary_action_color }}>{displayClass} â€¢ No: {displayNo}</p>
      </div>

      <div className="mb-8">
        <h2 className="text-xl font-bold mb-4" style={{ color: config.text_color }}>Deneme Analizi</h2>
        <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
          {[
            { label: 'Toplam Deneme', value: totalExams },
            { label: 'Ortalama Net', value: avgNet },
            { label: 'En YÃ¼ksek Net', value: maxNet },
            { label: 'En DÃ¼ÅŸÃ¼k Net', value: minNet },
            { label: 'Son Deneme', value: lastNet },
          ].map((card, i) => (
            <div key={i} className="rounded-xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
              <p className="text-xs font-semibold mb-1" style={{ color: config.secondary_action_color }}>{card.label}</p>
              <p className="text-2xl font-bold" style={{ color: config.text_color }}>{card.value}</p>
            </div>
          ))}
        </div>

        {totalExams === 0 ? (
          <div className="text-center py-10 rounded-xl border border-dashed" style={{ color: config.secondary_action_color }}>HenÃ¼z deneme verisi girilmemiÅŸ</div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="rounded-2xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
              <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>Net Ä°lerleme (Son 10 Deneme)</h3>
              {netSeries.length === 0 ? (
                <div className="text-center py-10 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z veri yok</div>
              ) : (
                <svg width="100%" height="260" viewBox="0 0 500 260" preserveAspectRatio="xMidYMid meet">
                  {[0, 1, 2, 3, 4].map(i => (
                    <line key={`h-${i}`} x1="40" y1={30 + i * 50} x2="480" y2={30 + i * 50} stroke="#E2E8F0" strokeWidth="1" />
                  ))}
                  <line x1="40" y1="30" x2="40" y2="230" stroke="#94A3B8" strokeWidth="2" />
                  <line x1="40" y1="230" x2="480" y2="230" stroke="#94A3B8" strokeWidth="2" />
                  {netSeries.length > 1 && (
                    <polyline
                      points={netSeries.map((d, i) => {
                        const x = 40 + (i / (netSeries.length - 1)) * 440;
                        const max = Math.max(...netSeries.map(e => e.total), 1);
                        const y = 230 - (d.total / max) * 180;
                        return `${x},${y}`;
                      }).join(' ')}
                      fill="none"
                      stroke="#3B82F6"
                      strokeWidth="3"
                    />
                  )}
                  {netSeries.map((d, i) => {
                    const x = 40 + (i / (netSeries.length - 1 || 1)) * 440;
                    const max = Math.max(...netSeries.map(e => e.total), 1);
                    const y = 230 - (d.total / max) * 180;
                    return (
                      <g key={i}>
                        <circle cx={x} cy={y} r="4" fill="#3B82F6" />
                        <text x={x} y={y - 8} textAnchor="middle" fontSize="10" fill={config.text_color}>{d.total.toFixed(1)}</text>
                        {d.name ? (
                          <text x={x} y={245} textAnchor="middle" fontSize="9" fill={config.secondary_action_color}>
                            {d.name.slice(0, 6)}
                          </text>
                        ) : null}
                      </g>
                    );
                  })}
                </svg>
              )}
            </div>
            <div className="rounded-2xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
              <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>Son Denemeler</h3>
              {recentExams.length === 0 ? (
                <div className="text-center py-10 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z veri yok</div>
              ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div className="rounded-xl p-3 border border-gray-100" style={{ background: '#F1F5F9' }}>
                    <div className="text-xs font-semibold" style={{ color: config.text_color }}>Ortalama Net</div>
                    <div className="text-[10px]" style={{ color: config.secondary_action_color }}>Son {recentExams.length} deneme</div>
                    <div className="mt-2 text-lg font-bold" style={{ color: '#0F172A' }}>
                      {avgNet}
                    </div>
                  </div>
                  <button onClick={() => setShowAllExams(true)} className="rounded-xl p-3 border border-gray-100 text-left hover:shadow-md transition" style={{ background: '#EFF6FF' }}>
                    <div className="text-xs font-semibold" style={{ color: config.text_color }}>TÃ¼m Denemeler</div>
                    <div className="text-[10px]" style={{ color: config.secondary_action_color }}>TÄ±klayarak listele</div>
                    <div className="mt-2 text-lg font-bold" style={{ color: '#1D4ED8' }}>
                      {studentExams.length}
                    </div>
                  </button>
                  <button onClick={() => setShowAllStudies(true)} className="rounded-xl p-3 border border-gray-100 text-left hover:shadow-md transition" style={{ background: '#ECFDF5' }}>
                    <div className="text-xs font-semibold" style={{ color: config.text_color }}>GÃ¼nlÃ¼k Ã‡alÄ±ÅŸmalar</div>
                    <div className="text-[10px]" style={{ color: config.secondary_action_color }}>TÄ±klayarak listele</div>
                    <div className="mt-2 text-lg font-bold" style={{ color: '#059669' }}>
                      {studentQuick.length}
                    </div>
                  </button>
                  {recentExams.slice(-6).reverse().map((e, i) => (
                    <div key={e.__backendId} className="rounded-xl p-3 border border-gray-100" style={{ background: ['#EFF6FF','#ECFDF5','#FEF3C7','#FCE7F3','#F3E8FF','#FFF7ED'][i % 6] }}>
                      <div className="text-xs font-semibold" style={{ color: config.text_color }}>{(e.exam_name || 'Deneme').slice(0, 20)}</div>
                      <div className="text-[10px]" style={{ color: config.secondary_action_color }}>
                        {new Date(e.exam_date || e.created_at).toLocaleDateString('tr-TR')}
                      </div>
                      <div className="mt-2 text-lg font-bold" style={{ color: '#0F172A' }}>
                        {parseFloat(e.exam_total_net || 0).toFixed(1)} net
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

      </div>

      <div className="mb-8">
        <h2 className="text-xl font-bold mb-4" style={{ color: config.text_color }}>Ders Ders Deneme Analizi (Son 6)</h2>
        {subjectSeries.length === 0 ? (
          <div className="text-center py-10 rounded-xl border border-dashed" style={{ color: config.secondary_action_color }}>HenÃ¼z deneme verisi girilmemiÅŸ</div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {subjectSeries.map(s => (
              <div key={s.key} className="rounded-2xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
                <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>{s.name}</h3>
                <svg width="100%" height="200" viewBox="0 0 500 200" preserveAspectRatio="xMidYMid meet">
                  {[0, 1, 2, 3].map(i => (
                    <line key={`h-${i}`} x1="40" y1={30 + i * 40} x2="480" y2={30 + i * 40} stroke="#E2E8F0" strokeWidth="1" />
                  ))}
                  <line x1="40" y1="30" x2="40" y2="170" stroke="#94A3B8" strokeWidth="2" />
                  <line x1="40" y1="170" x2="480" y2="170" stroke="#94A3B8" strokeWidth="2" />
                  {s.series.length > 1 && (
                    <polyline
                      points={s.series.map((v, i) => {
                        const x = 40 + (i / (s.series.length - 1)) * 440;
                        const max = Math.max(...s.series, 1);
                        const y = 170 - (v / max) * 120;
                        return `${x},${y}`;
                      }).join(' ')}
                      fill="none"
                      stroke="#10B981"
                      strokeWidth="3"
                    />
                  )}
                  {s.series.map((v, i) => {
                    const x = 40 + (i / (s.series.length - 1 || 1)) * 440;
                    const max = Math.max(...s.series, 1);
                    const y = 170 - (v / max) * 120;
                    const name = recentExams.slice(-6)[i]?.exam_name || '';
                    return (
                      <g key={i}>
                        <circle cx={x} cy={y} r="4" fill="#10B981" />
                        <text x={x} y={y - 8} textAnchor="middle" fontSize="10" fill={config.text_color}>{v.toFixed(1)}</text>
                        {name ? (
                          <text x={x} y={185} textAnchor="middle" fontSize="9" fill={config.secondary_action_color}>
                            {name.slice(0, 8)}
                          </text>
                        ) : null}
                      </g>
                    );
                  })}
                </svg>
              </div>
            ))}
          </div>
        )}
      </div>

      <div className="mb-8">
        <h2 className="text-xl font-bold mb-4" style={{ color: config.text_color }}>GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma Analizi</h2>
        <div className="rounded-2xl p-4 border border-gray-100 mb-6 heatmap-container" style={{ background: config.surface_color }}>
          <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>ðŸ“… Ã‡alÄ±ÅŸma Takvimi</h3>
          {heatmapValues.length === 0 ? (
            <div className="text-center py-8 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z Ã§alÄ±ÅŸma verisi girilmemiÅŸ</div>
          ) : (
            <div className="flex items-start gap-3">
              <div className="flex flex-col gap-1 pt-5 text-[10px]" style={{ color: config.secondary_action_color }}>
                {weekdays.map((d, i) => (
                  <div key={i} style={{ height: 12, lineHeight: '12px' }}>{d}</div>
                ))}
              </div>
              <div>
                <div className="flex gap-2 text-[10px] mb-1" style={{ color: config.secondary_action_color }}>
                  {weeks.map((_, idx) => (
                    <div key={idx} style={{ width: 12 }}>{monthPositions[idx] || ''}</div>
                  ))}
                </div>
                <div className="flex gap-2">
                  {weeks.map((w, wi) => (
                    <div key={wi} className="flex flex-col gap-1">
                      {w.map((day, di) => {
                        const count = day ? day.count : 0;
                        const color = count >= 100 ? '#196127' : count >= 50 ? '#239a3b' : count >= 1 ? '#7bc96f' : '#ebedf0';
                        const title = day
                          ? `${day.date.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' })} - ${count} soru`
                          : '';
                        return (
                          <div key={di} title={title} style={{ width: 12, height: 12, background: color, borderRadius: 2 }} />
                        );
                      })}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
          <div className="flex items-center gap-2 text-xs mt-3" style={{ color: config.secondary_action_color }}>
            <span>0</span>
            <span className="w-3 h-3 rounded-sm" style={{ background: '#ebedf0' }}></span>
            <span className="w-3 h-3 rounded-sm" style={{ background: '#7bc96f' }}></span>
            <span className="w-3 h-3 rounded-sm" style={{ background: '#239a3b' }}></span>
            <span className="w-3 h-3 rounded-sm" style={{ background: '#196127' }}></span>
            <span>100+</span>
          </div>
        </div>

        <div className="rounded-2xl p-4 border border-gray-100 mb-6" style={{ background: config.surface_color }}>
          <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>ðŸ“Š HaftalÄ±k SÃ¼reklilik Skoru</h3>
          <div className="space-y-2">
            {weeklyStats.map((w, i) => (
              <button key={i} onClick={() => setShowWeekDetail(w)} className="w-full text-left flex items-center justify-between px-3 py-2 rounded-lg hover:shadow-sm transition" style={{ background: '#F8FAFC' }}>
                <div className="text-sm" style={{ color: config.text_color }}>
                  {w.label}: {w.daysWorked}/7 gÃ¼n Ã§alÄ±ÅŸtÄ±n! {w.emoji}
                </div>
                <div className="text-sm font-bold" style={{ color: config.primary_action_color }}>
                  %{w.pct}
                </div>
              </button>
            ))}
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="rounded-2xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
            <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>ðŸ“ˆ 30 GÃ¼nlÃ¼k Soru Ã‡Ã¶zÃ¼m Trendi</h3>
            {Object.keys(dailyTotalsMap).length === 0 ? (
              <div className="text-center py-10 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z veri yok</div>
            ) : (
              (() => {
                const days30 = [];
                const avgWindow = [];
                const start = new Date();
                start.setDate(start.getDate() - 29);
                for (let i = 0; i < 30; i++) {
                  const d = new Date(start);
                  d.setDate(start.getDate() + i);
                  const key = toDateKey(d);
                  const total = dailyTotalsMap[key] || 0;
                  days30.push({ date: d, total, key });
                  avgWindow.push(total);
                }
                const avg = avgWindow.reduce((s, v) => s + v, 0) / (avgWindow.length || 1);
                const max = Math.max(...days30.map(d => d.total), avg, 1);
                return (
                  <svg width="100%" height="240" viewBox="0 0 520 240" preserveAspectRatio="xMidYMid meet">
                    {[0, 1, 2, 3, 4].map(i => (
                      <line key={`h-${i}`} x1="40" y1={20 + i * 45} x2="500" y2={20 + i * 45} stroke="#E2E8F0" strokeWidth="1" />
                    ))}
                    <line x1="40" y1="20" x2="40" y2="200" stroke="#94A3B8" strokeWidth="2" />
                    <line x1="40" y1="200" x2="500" y2="200" stroke="#94A3B8" strokeWidth="2" />
                    {(() => {
                      const avgY = 200 - (avg / max) * 160;
                      return (
                        <>
                          <line x1="40" y1={avgY} x2="500" y2={avgY} stroke="#64748B" strokeWidth="1" strokeDasharray="4 4" />
                          <text x="4" y={avgY - 2} textAnchor="start" fontSize="10" fill="#64748B">Ort: {avg.toFixed(1)}</text>
                        </>
                      );
                    })()}
                    <defs>
                      <linearGradient id="trendFill" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stopColor="#10B981" stopOpacity="0.25" />
                        <stop offset="100%" stopColor="#EF4444" stopOpacity="0.1" />
                      </linearGradient>
                    </defs>
                    <polyline
                      points={days30.map((d, i) => {
                        const x = 40 + (i / 29) * 460;
                        const y = 200 - (d.total / max) * 160;
                        return `${x},${y}`;
                      }).join(' ')}
                      fill="none"
                      stroke="#3B82F6"
                      strokeWidth="2.5"
                    />
                    {days30.map((d, i) => {
                      const x = 40 + (i / 29) * 460;
                      const y = 200 - (d.total / max) * 160;
                      const color = d.total >= avg ? '#10B981' : '#EF4444';
                      const title = d.date.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', weekday: 'long' }) + ` - ${d.total} soru`;
                      return (
                        <g key={d.key} style={{ pointerEvents: 'all' }}>
                          <title>{title}</title>
                          <circle cx={x} cy={y} r="8" fill="transparent" />
                          <circle cx={x} cy={y} r="3.5" fill={color} />
                          {i % 5 === 0 ? (
                            <text x={x} y={220} textAnchor="middle" fontSize="9" fill={config.secondary_action_color}>
                              {d.date.getDate()}/{d.date.getMonth() + 1}
                            </text>
                          ) : null}
                          {i % 5 === 0 ? (
                            <text x={x} y={y - 6} textAnchor="middle" fontSize="8" fill={config.text_color}>{d.total}</text>
                          ) : null}
                        </g>
                      );
                    })}
                  </svg>
                );
              })()
            )}
          </div>

          <div className="rounded-2xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
            <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>ðŸ“Š HaftalÄ±k KarÅŸÄ±laÅŸtÄ±rma</h3>
            {Object.keys(dailyTotalsMap).length === 0 ? (
              <div className="text-center py-10 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z veri yok</div>
            ) : (
              (() => {
                const weeks = [];
                for (let i = 5; i >= 0; i--) {
                  const end = new Date(startOfWeek(today));
                  end.setDate(end.getDate() - (i * 7));
                  const start = new Date(end);
                  let total = 0;
                  for (let d = new Date(start); d < new Date(start.getTime() + 7 * 24 * 60 * 60 * 1000); d.setDate(d.getDate() + 1)) {
                    const key = toDateKey(d);
                    total += dailyTotalsMap[key] || 0;
                  }
                  weeks.push({ label: `${6 - i}. Hafta`, total });
                }
                const max = Math.max(...weeks.map(w => w.total), 1);
                return (
                  <svg width="100%" height="240" viewBox="0 0 520 240" preserveAspectRatio="xMidYMid meet">
                    {[0, 1, 2, 3, 4].map(i => (
                      <line key={`h-${i}`} x1="40" y1={20 + i * 45} x2="500" y2={20 + i * 45} stroke="#E2E8F0" strokeWidth="1" />
                    ))}
                    <line x1="40" y1="20" x2="40" y2="200" stroke="#94A3B8" strokeWidth="2" />
                    <line x1="40" y1="200" x2="500" y2="200" stroke="#94A3B8" strokeWidth="2" />
                    {weeks.map((w, i) => {
                      const x = 60 + i * 70;
                      const h = (w.total / max) * 160;
                      return (
                        <g key={w.label}>
                          <rect x={x} y={200 - h} width="40" height={h} fill="#3B82F6" rx="4" />
                          <text x={x + 20} y={200 - h - 6} textAnchor="middle" fontSize="10" fill={config.text_color}>{w.total}</text>
                          <text x={x + 20} y={220} textAnchor="middle" fontSize="9" fill={config.secondary_action_color}>{w.label}</text>
                        </g>
                      );
                    })}
                  </svg>
                );
              })()
            )}
          </div>
        </div>

        <div className="rounded-2xl p-4 border border-gray-100 mt-6" style={{ background: config.surface_color }}>
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-sm font-semibold" style={{ color: config.text_color }}>ðŸŽ¯ Ders BazlÄ± Analiz</h3>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setLessonRange(7)}
                className={`px-3 py-1 rounded-full text-xs font-semibold border ${lessonRange === 7 ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-200'}`}
              >
                Son 7 gÃ¼n
              </button>
              <button
                onClick={() => setLessonRange(30)}
                className={`px-3 py-1 rounded-full text-xs font-semibold border ${lessonRange === 30 ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-200'}`}
              >
                Son 30 gÃ¼n
              </button>
            </div>
          </div>

          {Object.keys(dailySubjectMap).length === 0 ? (
            <div className="text-center py-8 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z Ã§alÄ±ÅŸma verisi girilmemiÅŸ</div>
          ) : (
            (() => {
              const rangeDays = lessonRange;
              const end = new Date();
              const start = new Date();
              start.setDate(end.getDate() - (rangeDays - 1));
              const days = [];
              for (let i = 0; i < rangeDays; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                const key = toDateKey(d);
                const subj = dailySubjectMap[key] || { tur: 0, mat: 0, fen: 0, ink: 0, ing: 0, din: 0 };
                const total = Object.values(subj).reduce((s, v) => s + v, 0);
                days.push({ date: d, key, subj, total });
              }
              const totalsBySubject = subjectKeys.reduce((acc, s) => {
                acc[s.key] = days.reduce((t, d) => t + (d.subj[s.key] || 0), 0);
                return acc;
              }, {});
              const totalAll = Object.values(totalsBySubject).reduce((s, v) => s + v, 0);
              const maxDay = Math.max(...days.map(d => d.total), 1);
              const maxAvg = Math.max(...Object.values(totalsBySubject).map(v => v / (rangeDays || 1)), 1);
              return (
                <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                  <div className="rounded-2xl p-4 border border-gray-100" style={{ background: '#F8FAFC' }}>
                    <h4 className="text-xs font-semibold mb-3" style={{ color: config.text_color }}>ðŸ“Š Ders DaÄŸÄ±lÄ±mÄ± (YÄ±ÄŸÄ±lmÄ±ÅŸ Bar)</h4>
                    <svg width="100%" height="260" viewBox="0 0 560 260" preserveAspectRatio="xMidYMid meet">
                      {[0, 1, 2, 3, 4].map(i => (
                        <line key={`h-${i}`} x1="40" y1={30 + i * 45} x2="540" y2={30 + i * 45} stroke="#E2E8F0" strokeWidth="1" />
                      ))}
                      <line x1="40" y1="30" x2="40" y2="230" stroke="#94A3B8" strokeWidth="2" />
                      <line x1="40" y1="230" x2="540" y2="230" stroke="#94A3B8" strokeWidth="2" />
                      {days.map((d, i) => {
                        const x = 50 + (i / (days.length - 1 || 1)) * 470;
                        const barW = days.length > 20 ? 10 : 14;
                        let yCursor = 230;
                        return (
                          <g key={d.key}>
                            <title>{d.date.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', weekday: 'long' })} - {d.total} soru</title>
                            {subjectKeys.map(s => {
                              const val = d.subj[s.key] || 0;
                              const h = (val / maxDay) * 180;
                              yCursor -= h;
                              return h > 0 ? (
                                <rect key={s.key} x={x} y={yCursor} width={barW} height={h} fill={s.color} rx="2" />
                              ) : null;
                            })}
                            {(i % 5 === 0 || days.length <= 10) ? (
                              <text x={x + barW / 2} y={245} textAnchor="middle" fontSize="9" fill={config.secondary_action_color}>
                                {d.date.getDate()}/{d.date.getMonth() + 1}
                              </text>
                            ) : null}
                          </g>
                        );
                      })}
                    </svg>
                    <div className="flex flex-wrap gap-3 mt-2 text-[11px]" style={{ color: config.secondary_action_color }}>
                      {subjectKeys.map(s => (
                        <div key={s.key} className="flex items-center gap-1">
                          <span className="w-3 h-3 rounded-sm inline-block" style={{ background: s.color }}></span>
                          <span>{s.label}</span>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="grid grid-cols-1 gap-6">
                    <div className="rounded-2xl p-4 border border-gray-100" style={{ background: '#F8FAFC' }}>
                      <h4 className="text-xs font-semibold mb-3" style={{ color: config.text_color }}>ðŸŸ£ Ders BazlÄ± Toplam Soru (Donut)</h4>
                      {totalAll === 0 ? (
                        <div className="text-center py-10 text-sm" style={{ color: config.secondary_action_color }}>SeÃ§ilen aralÄ±kta veri yok</div>
                      ) : (
                        <div className="flex items-center gap-6">
                          <svg width="220" height="220" viewBox="0 0 220 220">
                            <g transform="translate(110,110)">
                              {(() => {
                                let acc = 0;
                                const r = 80;
                                const inner = 48;
                                return subjectKeys.map(s => {
                                  const v = totalsBySubject[s.key] || 0;
                                  const pct = v / totalAll;
                                  const startAngle = acc * 2 * Math.PI;
                                  const endAngle = (acc + pct) * 2 * Math.PI;
                                  acc += pct;
                                  if (v === 0) return null;
                                  const x1 = r * Math.cos(startAngle);
                                  const y1 = r * Math.sin(startAngle);
                                  const x2 = r * Math.cos(endAngle);
                                  const y2 = r * Math.sin(endAngle);
                                  const large = pct > 0.5 ? 1 : 0;
                                  const path = [
                                    `M ${x1} ${y1}`,
                                    `A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`,
                                    `L ${inner * Math.cos(endAngle)} ${inner * Math.sin(endAngle)}`,
                                    `A ${inner} ${inner} 0 ${large} 0 ${inner * Math.cos(startAngle)} ${inner * Math.sin(startAngle)}`,
                                    'Z'
                                  ].join(' ');
                                  return <path key={s.key} d={path} fill={s.color} />;
                                });
                              })()}
                              <circle r="44" fill="white" />
                              <text textAnchor="middle" y="-2" fontSize="12" fill={config.secondary_action_color}>Toplam</text>
                              <text textAnchor="middle" y="16" fontSize="18" fontWeight="700" fill={config.text_color}>{totalAll}</text>
                            </g>
                          </svg>
                          <div className="space-y-2 text-xs">
                            {subjectKeys.map(s => {
                              const v = totalsBySubject[s.key] || 0;
                              const pct = totalAll ? ((v / totalAll) * 100).toFixed(1) : '0.0';
                              return (
                                <div key={s.key} className="flex items-center justify-between gap-3">
                                  <div className="flex items-center gap-2">
                                    <span className="w-3 h-3 rounded-sm inline-block" style={{ background: s.color }}></span>
                                    <span>{s.label}</span>
                                  </div>
                                  <div className="font-semibold" style={{ color: config.text_color }}>{v} ({pct}%)</div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}
                    </div>

                    <div className="rounded-2xl p-4 border border-gray-100" style={{ background: '#F8FAFC' }}>
                      <h4 className="text-xs font-semibold mb-3" style={{ color: config.text_color }}>ðŸ“ˆ Ders BaÅŸÄ±na GÃ¼nlÃ¼k Ortalama</h4>
                      <svg width="100%" height="240" viewBox="0 0 520 240" preserveAspectRatio="xMidYMid meet">
                        {subjectKeys.map((s, i) => {
                          const avg = (totalsBySubject[s.key] || 0) / (rangeDays || 1);
                          const barW = (avg / maxAvg) * 380;
                          const y = 20 + i * 35;
                          return (
                            <g key={s.key}>
                              <text x="10" y={y + 12} fontSize="10" fill={config.secondary_action_color}>{s.label}</text>
                              <rect x="110" y={y} width={barW} height="18" fill={s.color} rx="6" />
                              <text x={110 + barW + 6} y={y + 13} fontSize="10" fill={config.text_color}>
                                {avg.toFixed(1)} soru/gÃ¼n
                              </text>
                            </g>
                          );
                        })}
                      </svg>
                    </div>
                  </div>
                </div>
              );
            })()
          )}
        </div>
      </div>

      {detailModal && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 fade-in" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>{detailModal.exam_name}</h3>
              <button onClick={() => setDetailModal(null)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <div className="text-sm mb-4" style={{ color: config.secondary_action_color }}>
              {new Date(detailModal.exam_date || detailModal.created_at).toLocaleDateString('tr-TR')}
            </div>
            <div className="space-y-2">
              {subjects.map(key => {
                let subj = {};
                try { subj = typeof detailModal.exam_subjects === 'string' ? JSON.parse(detailModal.exam_subjects) : detailModal.exam_subjects || {}; } catch {}
                const s = subj[key];
                if (!s) return null;
                const net = (parseFloat(s.dogru || 0) - (parseFloat(s.yanlis || 0) / 3)).toFixed(2);
                return (
                  <div key={key} className="flex justify-between text-sm">
                    <span>{subjectLabels[key]}</span>
                    <span className="font-semibold">{net}</span>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}

      {showAllExams && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-2xl w-full mx-4 fade-in max-h-[80vh] overflow-y-auto" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>TÃ¼m Denemeler</h3>
              <button onClick={() => setShowAllExams(false)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            {studentExams.length === 0 ? (
              <div className="text-center py-8" style={{ color: config.secondary_action_color }}>HenÃ¼z deneme verisi girilmemiÅŸ</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-left" style={{ color: config.secondary_action_color }}>
                      <th className="py-2">Tarih</th>
                      <th>Deneme AdÄ±</th>
                      <th>Tip</th>
                      <th>Toplam Net</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {[...studentExams].reverse().map(e => (
                      <tr key={e.__backendId} className="border-t">
                        <td className="py-2">{new Date(e.exam_date || e.created_at).toLocaleDateString('tr-TR')}</td>
                        <td>{e.exam_name}</td>
                        <td>{e.deneme_tipi === 'bireysel' ? 'Bireysel' : 'Ortak'}</td>
                        <td className="font-semibold">{parseFloat(e.exam_total_net || 0).toFixed(2)}</td>
                        <td>
                          <button onClick={() => setDetailModal(e)} className="text-blue-600 text-xs font-semibold">Detay GÃ¶r</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      )}

      {showAllStudies && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-3xl w-full mx-4 fade-in max-h-[80vh] overflow-y-auto" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>TÃ¼m GÃ¼nlÃ¼k Ã‡alÄ±ÅŸmalar</h3>
              <button onClick={() => setShowAllStudies(false)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <div className="flex items-center justify-between mb-3">
              <label className="text-xs" style={{ color: config.secondary_action_color }}>
                <input
                  type="checkbox"
                  checked={selectedStudyIds.length === studentQuick.length && studentQuick.length > 0}
                  onChange={(e) => setSelectedStudyIds(e.target.checked ? studentQuick.map(s => s.__backendId) : [])}
                /> TÃ¼mÃ¼nÃ¼ seÃ§
              </label>
              <button
                onClick={async () => {
                  if (selectedStudyIds.length === 0) return;
                  for (const id of selectedStudyIds) {
                    const rec = studentQuick.find(s => s.__backendId === id);
                    if (rec) await window.dataSdk.delete({ type: 'quick_study', __backendId: rec.__backendId });
                  }
                  setSelectedStudyIds([]);
                }}
                className="px-3 py-1.5 rounded-lg text-xs font-semibold border border-red-200 text-red-600 hover:bg-red-50"
              >
                SeÃ§ilileri Sil
              </button>
            </div>
            {studentQuick.length === 0 ? (
              <div className="text-center py-8" style={{ color: config.secondary_action_color }}>HenÃ¼z Ã§alÄ±ÅŸma verisi girilmemiÅŸ</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-left" style={{ color: config.secondary_action_color }}>
                      <th className="py-2"></th>
                      <th className="py-2">Tarih</th>
                      <th>TÃ¼rkÃ§e</th>
                      <th>Mat</th>
                      <th>Fen</th>
                      <th>Sosyal</th>
                      <th>Ä°ng</th>
                      <th>Din</th>
                      <th>Toplam</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {[...studentQuick].sort((a,b) => {
                      const da = toLocalDate(a.study_date);
                      const db = toLocalDate(b.study_date);
                      return (db ? db.getTime() : 0) - (da ? da.getTime() : 0);
                    }).map((q) => {
                      const total =
                        (q.tur_d||0)+(q.tur_y||0)+(q.tur_b||0)+
                        (q.mat_d||0)+(q.mat_y||0)+(q.mat_b||0)+
                        (q.fen_d||0)+(q.fen_y||0)+(q.fen_b||0)+
                        (q.ink_d||0)+(q.ink_y||0)+(q.ink_b||0)+
                        (q.ing_d||0)+(q.ing_y||0)+(q.ing_b||0)+
                        (q.din_d||0)+(q.din_y||0)+(q.din_b||0);
                      const displayDate = toLocalDate(q.study_date);
                      return (
                        <tr key={q.__backendId} className="border-t">
                          <td>
                            <input
                              type="checkbox"
                              checked={selectedStudyIds.includes(q.__backendId)}
                              onChange={(e) => setSelectedStudyIds(prev => e.target.checked ? [...prev, q.__backendId] : prev.filter(id => id !== q.__backendId))}
                            />
                          </td>
                          <td className="py-2">{displayDate ? displayDate.toLocaleDateString('tr-TR') : ''}</td>
                          <td>{(q.tur_d||0)+(q.tur_y||0)+(q.tur_b||0)}</td>
                          <td>{(q.mat_d||0)+(q.mat_y||0)+(q.mat_b||0)}</td>
                          <td>{(q.fen_d||0)+(q.fen_y||0)+(q.fen_b||0)}</td>
                          <td>{(q.ink_d||0)+(q.ink_y||0)+(q.ink_b||0)}</td>
                          <td>{(q.ing_d||0)+(q.ing_y||0)+(q.ing_b||0)}</td>
                          <td>{(q.din_d||0)+(q.din_y||0)+(q.din_b||0)}</td>
                          <td className="font-semibold">{total}</td>
                          <td className="space-x-2">
                            <button onClick={() => setEditingStudy(q)} className="text-blue-600 text-xs font-semibold">DÃ¼zenle</button>
                            <button onClick={async () => { await window.dataSdk.delete({ type: 'quick_study', __backendId: q.__backendId }); }} className="text-red-600 text-xs font-semibold">Sil</button>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      )}

      {editingStudy && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 fade-in" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma DÃ¼zenle</h3>
              <button onClick={() => setEditingStudy(null)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
              {[
                ['tur', 'TÃ¼rkÃ§e'], ['mat', 'Mat'], ['fen', 'Fen'], ['ink', 'Sosyal'], ['ing', 'Ä°ng'], ['din', 'Din']
              ].map(([k, label]) => (
                <div key={k} className="rounded-lg border border-gray-100 p-2">
                  <div className="text-xs font-semibold mb-1" style={{ color: config.secondary_action_color }}>{label}</div>
                  <div className="flex gap-2">
                    {['d','y','b'].map(t => (
                      <input key={t} type="number" min="0" value={editingStudy[`${k}_${t}`] || 0}
                        onChange={(e) => setEditingStudy(prev => ({ ...prev, [`${k}_${t}`]: parseInt(e.target.value || 0, 10) })) }
                        className="w-1/3 px-2 py-1 rounded border border-gray-200 text-xs text-center" />
                    ))}
                  </div>
                </div>
              ))}
            </div>
            <div className="flex justify-end gap-2 mt-4">
              <button onClick={() => setEditingStudy(null)} className="px-3 py-2 rounded-lg border border-gray-200 text-sm font-semibold">Ä°ptal</button>
              <button onClick={async () => { await window.dataSdk.update({ ...editingStudy, type: 'quick_study' }); setEditingStudy(null); }}
                className="px-4 py-2 rounded-lg text-white text-sm font-semibold" style={{ background: config.primary_action_color }}>
                Kaydet
              </button>
            </div>
          </div>
        </div>
      )}

      {showWeekDetail && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 fade-in" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>{showWeekDetail.label}</h3>
              <button onClick={() => setShowWeekDetail(null)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <div className="space-y-2">
              {showWeekDetail.days.map((d, i) => (
                <div key={i} className="flex items-center justify-between px-3 py-2 rounded-lg" style={{ background: '#F8FAFC' }}>
                  <div className="text-sm" style={{ color: config.text_color }}>
                    {d.date.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', weekday: 'long' })}
                  </div>
                  <div className="text-sm font-semibold" style={{ color: d.worked ? '#10B981' : '#EF4444' }}>
                    {d.worked ? 'âœ”ï¸ Ã‡alÄ±ÅŸÄ±ldÄ±' : 'âœ–ï¸ Veri yok'}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {editModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 fade-in">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold" style={{color: config.text_color}}>Ã–ÄŸrenciyi DÃ¼zenle</h2>
              <button onClick={() => setEditModal(false)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <form onSubmit={handleUpdate} className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Ad Soyad *</label>
                <input value={form.fullName} onChange={(e) => setForm({...form, fullName: e.target.value})}
                  className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium"/>
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>SÄ±nÄ±f *</label>
                  <select value={form.sinif} onChange={(e) => setForm({...form, sinif: e.target.value})}
                    className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium">
                    {['8A','8B','8C','8D','8E','8F'].map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Okul NumarasÄ± *</label>
                  <input value={form.okulNo} onChange={(e) => setForm({...form, okulNo: e.target.value})}
                    className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium"/>
                </div>
              </div>
              <div className="flex gap-3 justify-end pt-2">
                <button type="button" onClick={() => setEditModal(false)}
                  className="px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold">Ä°ptal</button>
                <button type="submit" disabled={saving}
                  className="px-5 py-2 rounded-lg text-white text-sm font-semibold transition-all hover:shadow-lg"
                  style={{ background: config.primary_action_color }}>
                  {saving ? 'Kaydediliyor...' : 'Kaydet'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {confirmDel && (
        <ConfirmModal message="Bu Ã¶ÄŸrenciyi silmek istediÄŸinize emin misiniz?" onConfirm={handleDelete} onCancel={() => setConfirmDel(false)}/>
      )}
    </div>
  );
}

function StudyPage({ config }) {
  const { students } = useAppData();
  const [selectedStudentId, setSelectedStudentId] = useState('');
  const [toast, setToast] = useState(null);
  const [loading, setLoading] = useState(false);
  const [quickDate, setQuickDate] = useState(new Date().toISOString().split('T')[0]);
  const [quickInputs, setQuickInputs] = useState({
    tur_d: '', tur_y: '', tur_b: '',
    mat_d: '', mat_y: '', mat_b: '',
    fen_d: '', fen_y: '', fen_b: '',
    ink_d: '', ink_y: '', ink_b: '',
    din_d: '', din_y: '', din_b: '',
    ing_d: '', ing_y: '', ing_b: '',
  });
  const quickFirstRef = React.useRef(null);

  const quickSubjects = [
    { key: 'tur', label: 'TÃœR', accent: '#EF4444', soft: '#FEE2E2' },
    { key: 'mat', label: 'MAT', accent: '#3B82F6', soft: '#DBEAFE' },
    { key: 'fen', label: 'FEN', accent: '#10B981', soft: '#DCFCE7' },
    { key: 'ink', label: 'Ä°NK', accent: '#F59E0B', soft: '#FEF3C7' },
    { key: 'din', label: 'DÄ°N', accent: '#EC4899', soft: '#FCE7F3' },
    { key: 'ing', label: 'Ä°NG', accent: '#8B5CF6', soft: '#F3E8FF' },
  ];

  const toNum = (v) => {
    if (v === '' || v == null) return 0;
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : 0;
  };

  const normalizeIntInput = (value) => {
    const digits = String(value).replace(/[^\d]/g, '');
    if (digits === '') return '';
    return digits.replace(/^0+(?=\d)/, '');
  };

  const calculateNet = (dogru, yanlis) => {
    return (toNum(dogru) - (toNum(yanlis) / 3)).toFixed(2);
  };

  const handleQuickChange = (key, value) => {
    const cleaned = normalizeIntInput(value).slice(0, 3);
    setQuickInputs(prev => ({ ...prev, [key]: cleaned }));
  };

  const focusQuickFirst = () => {
    if (quickFirstRef.current) quickFirstRef.current.focus();
  };

  const handleQuickSubmit = async (e) => {
    e.preventDefault();
    if (!selectedStudentId) {
      setToast({ msg: 'LÃ¼tfen Ã¶ÄŸrenci seÃ§in', type: 'error' });
      return;
    }
    if (!quickDate) {
      setToast({ msg: 'Tarih seÃ§meden kaydetme yapÄ±lamaz', type: 'error' });
      return;
    }

    const payload = Object.fromEntries(
      Object.entries(quickInputs).map(([k, v]) => [k, Number(toNum(v))])
    );

    setLoading(true);
    const result = await window.dataSdk.create({
      type: 'quick_study',
      student_id: selectedStudentId,
      study_date: quickDate,
      ...payload,
      created_at: new Date().toISOString()
    });
    setLoading(false);

    if (result.isOk) {
      setToast({ msg: 'HÄ±zlÄ± giriÅŸ kaydedildi! âœ…', type: 'success' });
      setQuickInputs({
        tur_d: '', tur_y: '', tur_b: '',
        mat_d: '', mat_y: '', mat_b: '',
        fen_d: '', fen_y: '', fen_b: '',
        ink_d: '', ink_y: '', ink_b: '',
        din_d: '', din_y: '', din_b: '',
        ing_d: '', ing_y: '', ing_b: '',
      });
      focusQuickFirst();
    } else {
      setToast({ msg: 'Hata oluÅŸtu', type: 'error' });
    }
  };

  const quickNet = (key) => {
    const d = quickInputs[`${key}_d`];
    const y = quickInputs[`${key}_y`];
    return calculateNet(d, y);
  };

  return (
    <div className="max-w-6xl mx-auto px-4 py-8 fade-in">
      {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}

      <div className="mb-10">
        <div className="rounded-2xl p-8 border border-gray-200 bg-white">
          <div className="flex items-center justify-center flex-wrap gap-6 mb-6">
            <h2 className="text-2xl font-bold" style={{ color: config.text_color }}>HÄ±zlÄ± GiriÅŸ</h2>
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2">
                <label className="text-sm font-semibold" style={{ color: config.text_color }}>Tarih *</label>
                <input
                  type="date"
                  value={quickDate}
                  onChange={(e) => setQuickDate(e.target.value)}
                  className="px-3 py-2 rounded-lg border border-gray-200 text-sm font-medium"
                  style={{ background: config.surface_color, color: config.text_color }}
                  required
                />
              </div>
              <div className="flex items-center gap-2">
                <label className="text-sm font-semibold" style={{ color: config.text_color }}>Ã–ÄŸrenci *</label>
                <select
                  value={selectedStudentId}
                  onChange={(e) => setSelectedStudentId(e.target.value)}
                  className="px-3 py-2 rounded-lg border border-gray-200 text-sm font-medium"
                  style={{ background: config.surface_color, color: config.text_color }}
                >
                  <option value="">-- Ã–ÄŸrenci SeÃ§in --</option>
                  {students.map(s => (
                    <option key={s.__backendId} value={s.__backendId}>
                      {s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim()}
                    </option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          <form onSubmit={handleQuickSubmit}>
            <div className="overflow-x-auto">
              <div className="min-w-[1100px]">
                <div className="grid grid-cols-6 gap-4 items-center text-xs font-semibold uppercase" style={{ color: config.secondary_action_color }}>
                  {quickSubjects.map(s => (
                    <div key={s.key} className="text-center">{s.label}</div>
                  ))}
                </div>

                <div className="grid grid-cols-6 gap-4 mt-3">
                  {quickSubjects.map((s, idx) => (
                    <div key={s.key} className="flex flex-col gap-2">
                      <div className="grid grid-cols-3 gap-2 text-[10px] font-semibold text-center" style={{ color: config.secondary_action_color }}>
                        <div>D</div>
                        <div>Y</div>
                        <div>B</div>
                      </div>
                      <div className="grid grid-cols-3 gap-2">
                        <input
                          ref={idx === 0 ? quickFirstRef : null}
                          autoFocus={idx === 0}
                          type="text"
                          inputMode="numeric"
                          maxLength={3}
                          value={quickInputs[`${s.key}_d`]}
                          onChange={(e) => handleQuickChange(`${s.key}_d`, e.target.value)}
                          className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                          style={{ background: s.soft, borderColor: s.soft }}
                        />
                        <input
                          type="text"
                          inputMode="numeric"
                          maxLength={3}
                          value={quickInputs[`${s.key}_y`]}
                          onChange={(e) => handleQuickChange(`${s.key}_y`, e.target.value)}
                          className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                          style={{ background: s.soft, borderColor: s.soft }}
                        />
                        <input
                          type="text"
                          inputMode="numeric"
                          maxLength={3}
                          value={quickInputs[`${s.key}_b`]}
                          onChange={(e) => handleQuickChange(`${s.key}_b`, e.target.value)}
                          className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                          style={{ background: s.soft, borderColor: s.soft }}
                        />
                      </div>
                      <div className="rounded-lg py-2 text-center text-sm font-bold" style={{ background: s.soft, color: s.accent }}>
                        Net: {quickNet(s.key)}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            <div className="flex justify-end mt-5">
              <button type="submit" className="px-6 py-2.5 rounded-lg text-white text-sm font-semibold transition-all hover:shadow-lg flex items-center gap-2" style={{ background: config.primary_action_color }}>
                {loading ? <Spinner size="sm" /> : <Icons.Check size={18} />}
                {loading ? 'Kaydediliyor...' : 'Kaydet'}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
}

function ExamPage({ config }) {
  const { students, exams, definedExams } = useAppData();
  const [selectedStudentId, setSelectedStudentId] = useState('');
  const [selectedDefinedExamId, setSelectedDefinedExamId] = useState('');
  const [examType, setExamType] = useState('ortak');
  const [examName, setExamName] = useState('');
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [subjects, setSubjects] = useState({
    turkce: { dogru: '', yanlis: '', bos: '' },
    matematik: { dogru: '', yanlis: '', bos: '' },
    fen: { dogru: '', yanlis: '', bos: '' },
    inkilap: { dogru: '', yanlis: '', bos: '' },
    ingilizce: { dogru: '', yanlis: '', bos: '' },
    din: { dogru: '', yanlis: '', bos: '' },
  });
  const [isSaving, setIsSaving] = useState(false);
  const [newDefineExamName, setNewDefineExamName] = useState('');
  const [newDefineExamDate, setNewDefineExamDate] = useState(new Date().toISOString().split('T')[0]);
  const [toast, setToast] = useState(null);
  const [detailModal, setDetailModal] = useState(null);

  const subjectColors = {
    turkce: { bg: '#FEE2E2', text: '#DC2626', name: 'TÃ¼rkÃ§e', emoji: 'ðŸ“˜' },
    matematik: { bg: '#DBEAFE', text: '#0284C7', name: 'Matematik', emoji: 'ðŸ”¢' },
    fen: { bg: '#DCFCE7', text: '#16A34A', name: 'Fen', emoji: 'ðŸ§ª' },
    inkilap: { bg: '#FEF3C7', text: '#D97706', name: 'Ä°nkÄ±lap', emoji: 'ðŸ“œ' },
    ingilizce: { bg: '#F3E8FF', text: '#7C3AED', name: 'Ä°ngilizce', emoji: 'ðŸŒ' },
    din: { bg: '#FCE7F3', text: '#BE185D', name: 'Din', emoji: 'â˜ªï¸' },
  };
  const quickSubjects = [
    { key: 'turkce', label: 'TÃœR', accent: '#EF4444', soft: '#FEE2E2' },
    { key: 'matematik', label: 'MAT', accent: '#3B82F6', soft: '#DBEAFE' },
    { key: 'fen', label: 'FEN', accent: '#10B981', soft: '#DCFCE7' },
    { key: 'inkilap', label: 'Ä°NK', accent: '#F59E0B', soft: '#FEF3C7' },
    { key: 'din', label: 'DÄ°N', accent: '#EC4899', soft: '#FCE7F3' },
    { key: 'ingilizce', label: 'Ä°NG', accent: '#8B5CF6', soft: '#F3E8FF' },
  ];

  const toNum = (v) => {
    if (v === '' || v == null) return 0;
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : 0;
  };

  const normalizeIntInput = (value) => {
    const digits = String(value).replace(/[^\d]/g, '');
    if (digits === '') return '';
    return digits.replace(/^0+(?=\d)/, '');
  };

  const calculateNet = (dogru, yanlis) => {
    return (toNum(dogru) - (toNum(yanlis) / 3)).toFixed(2);
  };

  const getTotalNet = () => {
    return Object.values(subjects)
      .reduce((sum, s) => sum + parseFloat(calculateNet(s.dogru, s.yanlis)), 0)
      .toFixed(2);
  };

  const handleDefineExam = async (e) => {
    e.preventDefault();
    if (!newDefineExamName.trim()) {
      setToast({ msg: 'Deneme adÄ± boÅŸ olamaz', type: 'error' });
      return;
    }
    if (!newDefineExamDate) {
      setToast({ msg: 'Tarih seÃ§in', type: 'error' });
      return;
    }
    setIsSaving(true);
    const result = await window.dataSdk.create({
      type: 'defined_exam',
      name: newDefineExamName,
      exam_date: newDefineExamDate,
      created_at: new Date().toISOString()
    });
    setIsSaving(false);
    if (result.isOk) {
      setToast({ msg: 'Deneme tanÄ±mlandÄ±! ðŸŽ‰', type: 'success' });
      setNewDefineExamName('');
      setNewDefineExamDate(new Date().toISOString().split('T')[0]);
    } else {
      setToast({ msg: 'Hata oluÅŸtu', type: 'error' });
    }
  };

  const handleDeleteDefinedExam = async (id) => {
    setIsSaving(true);
    const result = await window.dataSdk.delete({ type: 'defined_exam', __backendId: id });
    setIsSaving(false);
    if (result.isOk) setToast({ msg: 'Deneme silindi', type: 'success' });
    else setToast({ msg: 'Silme hatasÄ±', type: 'error' });
  };

  const handleSelectDefinedExam = (examId) => {
    if (examId === 'new') {
      setSelectedDefinedExamId('');
      setExamName('');
      setSelectedDate(new Date().toISOString().split('T')[0]);
    } else {
      const exam = definedExams.find(e => e.__backendId === examId);
      if (exam) {
        setSelectedDefinedExamId(examId);
        setExamName(exam.name);
        setSelectedDate(exam.exam_date);
      }
    }
  };

  const handleSubjectChange = (key, field, value) => {
    const num = normalizeIntInput(value).slice(0, 3);
    setSubjects(prev => ({
      ...prev,
      [key]: { ...prev[key], [field]: num }
    }));
  };

  const handleSave = async (e) => {
    e.preventDefault();
    if (!selectedStudentId) {
      setToast({ msg: 'LÃ¼tfen Ã¶ÄŸrenci seÃ§in', type: 'error' });
      return;
    }
    if (examType === 'ortak' && !selectedDefinedExamId) {
      setToast({ msg: 'LÃ¼tfen ortak deneme seÃ§in', type: 'error' });
      return;
    }
    if (examType === 'bireysel' && !examName.trim()) {
      setToast({ msg: 'LÃ¼tfen deneme adÄ± girin', type: 'error' });
      return;
    }

    setIsSaving(true);
    const serializeSubjects = (obj) => {
      return Object.fromEntries(
        Object.entries(obj).map(([k, v]) => [
          k,
          { dogru: toNum(v.dogru), yanlis: toNum(v.yanlis), bos: toNum(v.bos) }
        ])
      );
    };

    const result = await window.dataSdk.create({
      type: 'exam',
      student_id: selectedStudentId,
      exam_name: examType === 'bireysel' ? examName : (definedExams.find(e => e.__backendId === selectedDefinedExamId)?.name || examName),
      exam_date: selectedDate,
      exam_subjects: JSON.stringify(serializeSubjects(subjects)),
      exam_total_net: getTotalNet(),
      defined_exam_id: examType === 'ortak' ? (selectedDefinedExamId || null) : null,
      deneme_tipi: examType,
      created_at: new Date().toISOString()
    });
    setIsSaving(false);

    if (result.isOk) {
      setToast({ msg: 'Deneme kaydedildi! ðŸŽ‰', type: 'success' });
      handleReset();
    } else {
      setToast({ msg: 'Hata oluÅŸtu', type: 'error' });
    }
  };

  const handleReset = () => {
    setExamName('');
    setSelectedDefinedExamId('');
    setSelectedDate(new Date().toISOString().split('T')[0]);
    setSubjects({
      turkce: { dogru: '', yanlis: '', bos: '' },
      matematik: { dogru: '', yanlis: '', bos: '' },
      fen: { dogru: '', yanlis: '', bos: '' },
      inkilap: { dogru: '', yanlis: '', bos: '' },
      ingilizce: { dogru: '', yanlis: '', bos: '' },
      din: { dogru: '', yanlis: '', bos: '' },
    });
  };

  const handleDelete = async (id) => {
    setIsSaving(true);
    const result = await window.dataSdk.delete({ type: 'exam', __backendId: id });
    setIsSaving(false);
    if (result.isOk) setToast({ msg: 'Deneme silindi', type: 'success' });
    else setToast({ msg: 'Silme hatasÄ±', type: 'error' });
  };

  const studentExams = exams.filter(e => e.student_id === selectedStudentId);
  const openExamDetail = (exam) => {
    let subjects = {};
    if (exam.exam_subjects) {
      if (typeof exam.exam_subjects === 'string') {
        try {
          subjects = JSON.parse(exam.exam_subjects);
        } catch (e) {
          subjects = {};
        }
      } else {
        subjects = exam.exam_subjects;
      }
    }
    const computed = Object.entries(subjects).reduce((acc, [key, data]) => {
      acc[key] = {
        dogru: data.dogru || 0,
        yanlis: data.yanlis || 0,
        bos: data.bos || 0,
        net: calculateNet(data.dogru || 0, data.yanlis || 0),
      };
      return acc;
    }, {});
    setDetailModal({
      examName: exam.exam_name,
      date: exam.exam_date || exam.created_at,
      subjects: computed,
      totalNet: exam.exam_total_net,
    });
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 fade-in">
      {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}
      {detailModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 fade-in max-h-96 overflow-y-auto" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold" style={{color: config.text_color}}>{detailModal.examName}</h2>
              <button onClick={() => setDetailModal(null)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={20} className="text-gray-500"/></button>
            </div>
            <p className="text-sm mb-6" style={{color: config.secondary_action_color}}>ðŸ“… {new Date(detailModal.date).toLocaleDateString('tr-TR')}</p>
            
            <div className="space-y-3 mb-6">
              {Object.entries(detailModal.subjects).map(([key, data]) => {
                const color = subjectColors[key];
                return (
                  <div key={key} className="rounded-lg p-4" style={{background: color.bg}}>
                    <p className="font-semibold mb-2" style={{color: color.text}}>{color.emoji} {color.name}</p>
                    <div className="text-xs space-y-1" style={{color: color.text}}>
                      <p>âœ“ DoÄŸru: {data.dogru}</p>
                      <p>âœ— YanlÄ±ÅŸ: {data.yanlis}</p>
                      <p>âŠ˜ BoÅŸ: {data.bos}</p>
                      <p className="font-bold text-sm">NET: {data.net}</p>
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="rounded-lg p-4 bg-emerald-50 border-2 border-emerald-200 text-center mb-6">
              <p className="text-xs font-semibold mb-1" style={{color: '#059669'}}>TOPLAM NET</p>
              <p className="text-2xl font-extrabold text-emerald-600">{detailModal.totalNet}</p>
            </div>

            <button onClick={() => setDetailModal(null)} className="w-full px-4 py-2.5 rounded-xl border border-gray-300 text-sm font-semibold hover:bg-gray-50 transition-colors" style={{color: config.secondary_action_color}}>Kapat</button>
          </div>
        </div>
      )}

      <h1 className="text-3xl font-extrabold mb-8" style={{ color: config.text_color }}>Deneme SÄ±navÄ± GiriÅŸi</h1>
      
      {/* 2 SÃ¼tun Layout */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
        {/* SOL TARAF: Deneme TanÄ±mlama */}
        <div className="lg:col-span-1">
          <div className="rounded-2xl p-6 border-2 border-blue-200" style={{ background: '#F0F9FF' }}>
            <h2 className="text-lg font-bold mb-4 text-blue-900">ðŸ“‹ Yeni Deneme TanÄ±mla</h2>
            
            <form onSubmit={handleDefineExam} className="space-y-3 mb-6">
              <div>
                <label className="block text-xs font-semibold mb-1.5 text-blue-900">Deneme AdÄ±</label>
                <input
                  type="text"
                  value={newDefineExamName}
                  onChange={(e) => setNewDefineExamName(e.target.value)}
                  placeholder="1. Okul Denemesi"
                  className="w-full px-3 py-2 rounded-lg border border-blue-300 text-sm font-medium bg-white"
                  style={{ color: config.text_color }}
                />
              </div>
              <div>
                <label className="block text-xs font-semibold mb-1.5 text-blue-900">Tarih</label>
                <input
                  type="date"
                  value={newDefineExamDate}
                  onChange={(e) => setNewDefineExamDate(e.target.value)}
                  className="w-full px-3 py-2 rounded-lg border border-blue-300 text-sm font-medium bg-white"
                  style={{ color: config.text_color }}
                />
              </div>
              <button
                type="submit"
                disabled={isSaving}
                className="w-full px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 transition disabled:opacity-60"
              >
                {isSaving ? 'Kaydediliyor...' : 'âœ“ TanÄ±mla'}
              </button>
            </form>

            <div className="border-t border-blue-200 pt-4">
              <h3 className="text-sm font-bold mb-3 text-blue-900">TanÄ±mlanan Denemeler</h3>
              {definedExams.length === 0 ? (
                <p className="text-xs text-blue-700 text-center py-4">Ä°lk denemeyi tanÄ±mlayÄ±n</p>
              ) : (
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {definedExams.map(exam => (
                    <div key={exam.__backendId} className="flex items-center justify-between p-2 rounded-lg bg-white border border-blue-100">
                      <div className="flex-1">
                        <p className="text-xs font-bold text-blue-900">{exam.name}</p>
                        <p className="text-xs text-blue-600">{new Date(exam.exam_date).toLocaleDateString('tr-TR')}</p>
                      </div>
                      <button
                        onClick={() => handleDeleteDefinedExam(exam.__backendId)}
                        className="text-red-500 hover:text-red-700 p-1"
                        disabled={isSaving}
                      >
                        ðŸ—‘ï¸
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* SAÄž TARAF: Deneme GiriÅŸi Formu */}
        <div className="lg:col-span-2">
          <form onSubmit={handleSave}>
            <div className="rounded-2xl p-6 border border-gray-200 mb-6" style={{ background: config.surface_color }}>
              <h2 className="text-lg font-bold mb-4" style={{ color: config.text_color }}>ðŸ“ Deneme GiriÅŸi</h2>
              
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Ã–ÄŸrenci SeÃ§in *</label>
                  <select
                    value={selectedStudentId}
                    onChange={(e) => setSelectedStudentId(e.target.value)}
                    className="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-medium"
                    style={{ background: config.surface_color, color: config.text_color }}
                  >
                    <option value="">-- Ã–ÄŸrenci SeÃ§in --</option>
                    {students.map(s => (
                      <option key={s.__backendId} value={s.__backendId}>
                        {s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim()}
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Tarih *</label>
                  <input
                    type="date"
                    value={selectedDate}
                    onChange={(e) => setSelectedDate(e.target.value)}
                    className="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-medium"
                    style={{ background: config.surface_color, color: config.text_color }}
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Deneme Tipi *</label>
                  <div className="flex items-center gap-4">
                    <label className="flex items-center gap-2 text-sm font-medium" style={{ color: config.text_color }}>
                      <input type="radio" name="examType" value="ortak" checked={examType === 'ortak'} onChange={() => setExamType('ortak')} />
                      Ortak Deneme
                    </label>
                    <label className="flex items-center gap-2 text-sm font-medium" style={{ color: config.text_color }}>
                      <input type="radio" name="examType" value="bireysel" checked={examType === 'bireysel'} onChange={() => { setExamType('bireysel'); setSelectedDefinedExamId(''); }} />
                      Bireysel Deneme
                    </label>
                  </div>
                </div>
              </div>

              {examType === 'ortak' ? (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Ortak Deneme SeÃ§in *</label>
                    <select
                      value={selectedDefinedExamId}
                      onChange={(e) => handleSelectDefinedExam(e.target.value)}
                      className="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-medium"
                      style={{ background: config.surface_color, color: config.text_color }}
                    >
                      <option value="">-- Deneme SeÃ§in --</option>
                      {definedExams.map(exam => (
                        <option key={exam.__backendId} value={exam.__backendId}>
                          {exam.name}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div className="flex items-center text-sm" style={{ color: config.secondary_action_color }}>
                    {selectedDefinedExamId ? (
                      <>SeÃ§ilen: <span className="ml-1 font-semibold" style={{ color: config.text_color }}>
                        {definedExams.find(e => e.__backendId === selectedDefinedExamId)?.name}
                      </span> Â· {new Date(selectedDate).toLocaleDateString('tr-TR')}</>
                    ) : (
                      <>LÃ¼tfen bir ortak deneme seÃ§in</>
                    )}
                  </div>
                </div>
              ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Deneme AdÄ± *</label>
                    <input
                      type="text"
                      value={examName}
                      onChange={(e) => setExamName(e.target.value)}
                      className="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-medium"
                      placeholder="TYT YayÄ±nlarÄ± 8. Deneme"
                      style={{ background: config.surface_color, color: config.text_color }}
                    />
                  </div>
                </div>
              )}
            </div>

            {!selectedStudentId ? (
              <div className="text-center py-12 rounded-2xl border-2 border-dashed border-gray-300">
                <p className="text-lg font-medium" style={{ color: config.secondary_action_color }}>ðŸ“Œ LÃ¼tfen Ã¶ÄŸrenci seÃ§in</p>
              </div>
            ) : (
              <>
                <div className="mb-8 space-y-6">
                  {[quickSubjects.slice(0, 3), quickSubjects.slice(3, 6)].map((row, rowIdx) => (
                    <div key={rowIdx} className="grid grid-cols-3 gap-4">
                      {row.map((s, idx) => {
                        const focusFirst = rowIdx === 0 && idx === 0;
                        return (
                          <div key={s.key} className="rounded-2xl p-4 border border-gray-200" style={{ background: '#FFFFFF' }}>
                            <div className="flex items-center justify-between mb-3">
                              <span className="text-sm font-bold" style={{ color: s.accent }}>{s.label}</span>
                              <span className="text-[10px] font-semibold uppercase" style={{ color: config.secondary_action_color }}>D / Y / B</span>
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                              <input
                                id={`exam-${s.key}-dogru`}
                                autoFocus={focusFirst}
                                type="text"
                                inputMode="numeric"
                                maxLength={3}
                                value={subjects[s.key].dogru}
                                onChange={(e) => handleSubjectChange(s.key, 'dogru', e.target.value)}
                                className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                                style={{ background: s.soft, borderColor: s.soft }}
                              />
                              <input
                                id={`exam-${s.key}-yanlis`}
                                type="text"
                                inputMode="numeric"
                                maxLength={3}
                                value={subjects[s.key].yanlis}
                                onChange={(e) => handleSubjectChange(s.key, 'yanlis', e.target.value)}
                                className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                                style={{ background: s.soft, borderColor: s.soft }}
                              />
                              <input
                                id={`exam-${s.key}-bos`}
                                type="text"
                                inputMode="numeric"
                                maxLength={3}
                                value={subjects[s.key].bos}
                                onChange={(e) => handleSubjectChange(s.key, 'bos', e.target.value)}
                                className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                                style={{ background: s.soft, borderColor: s.soft }}
                              />
                            </div>
                            <div className="rounded-lg py-2 text-center text-sm font-bold mt-3" style={{ background: s.soft, color: s.accent }}>
                              Net: {calculateNet(subjects[s.key].dogru, subjects[s.key].yanlis)}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ))}
                </div>

                <div className="rounded-xl p-4 mb-6 text-center" style={{ background: '#ECFDF5', border: '1px solid #BBF7D0' }}>
                  <span className="text-sm font-semibold" style={{ color: '#059669' }}>Toplam Net: </span>
                  <span className="text-lg font-bold" style={{ color: '#047857' }}>{getTotalNet()}</span>
                </div>

                <div className="flex gap-3 mb-12">
                  <button type="submit" disabled={isSaving} className="flex-1 px-6 py-3.5 rounded-xl text-white text-base font-semibold transition-all hover:shadow-lg flex items-center justify-center gap-2 disabled:opacity-60" style={{ background: config.primary_action_color }}>
                    {isSaving ? <Spinner size="sm" /> : <Icons.Check size={20} />}
                    {isSaving ? 'Kaydediliyor...' : 'Denemeyi Kaydet'}
                  </button>
                  <button type="button" onClick={handleReset} className="px-6 py-3.5 rounded-xl border border-gray-300 text-sm font-semibold transition-colors hover:bg-gray-50" style={{ color: config.secondary_action_color }}>Formu Temizle</button>
                </div>
              </>
            )}
          </form>
        </div>
      </div>

      {selectedStudentId && (
        <div>
          <h2 className="text-2xl font-bold mb-6" style={{ color: config.text_color }}>Daha Ã–nce Girilen Denemeler</h2>
          
          {studentExams.length === 0 ? (
            <div className="text-center py-12 rounded-2xl border-2 border-dashed border-gray-300">
              <p className="text-base font-medium" style={{ color: config.secondary_action_color }}>HenÃ¼z deneme girilmemiÅŸ ðŸ“</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
              {studentExams.map((exam) => (
                <div key={exam.__backendId} className="rounded-2xl border border-gray-100 p-6 card-hover" style={{ background: config.surface_color }}>
                  <h3 className="text-xl font-bold mb-2" style={{ color: config.text_color }}>{exam.exam_name}</h3>
                  <p className="text-sm mb-4" style={{ color: config.secondary_action_color }}>ðŸ“… {new Date(exam.exam_date || exam.created_at).toLocaleDateString('tr-TR')}</p>
                  
                  <div className="rounded-lg p-4 bg-emerald-50 text-center mb-5">
                    <p className="text-xs font-semibold mb-1" style={{ color: '#059669' }}>TOPLAM NET</p>
                    <p className="text-2xl font-extrabold text-emerald-600">{exam.exam_total_net}</p>
                  </div>

                  <div className="flex gap-2">
                    <button onClick={() => openExamDetail(exam)} className="flex-1 px-3 py-2.5 rounded-lg text-white text-sm font-semibold transition-all" style={{background: config.primary_action_color}}>Detaylar</button>
                    <button onClick={() => handleDelete(exam.__backendId)} className="px-3 py-2.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 font-semibold text-sm transition-colors">ðŸ—‘ï¸</button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
}

function AnalysisPage({ config }) {
  const { students, exams, studies } = useAppData();
  const [selectedStudentId, setSelectedStudentId] = useState('');
  const [dateFilter, setDateFilter] = useState('1month');
  const [examData, setExamData] = useState([]);
  const [studyData, setStudyData] = useState([]);

  // Sabit renkler
  const colors = {
    turkce: '#F59E0B',
    matematik: '#3B82F6',
    fen: '#10B981',
    inkilap: '#8B5CF6',
    ingilizce: '#EF4444',
    din: '#EC4899',
    paragraf: '#92400E',
  };

  // Tarih filtresine gÃ¶re veri al
  useEffect(() => {
    if (!selectedStudentId) return;

    const now = new Date();
    let startDate = new Date();

    if (dateFilter === '1month') {
      startDate.setMonth(now.getMonth() - 1);
    } else if (dateFilter === '3month') {
      startDate.setMonth(now.getMonth() - 3);
    } else {
      startDate = new Date('2000-01-01');
    }

    const filtered = {
      exams: (exams || []).filter(e => {
        const d = new Date(e.exam_date || e.created_at);
        return d >= startDate && (e.student_id === selectedStudentId);
      }),
      studies: (studies || []).filter(s => {
        const d = new Date(s.study_date || s.created_at);
        return d >= startDate && (s.student_id === selectedStudentId);
      }),
    };

    setExamData(filtered.exams.sort((a, b) => new Date(a.exam_date || a.created_at) - new Date(b.exam_date || b.created_at)));
    setStudyData(filtered.studies.sort((a, b) => new Date(a.study_date || a.created_at) - new Date(b.study_date || b.created_at)));
  }, [selectedStudentId, dateFilter, exams, studies]);

  // Net hesapla
  const calculateNet = (correct, wrong) => {
    return (correct - (wrong / 3)).toFixed(2);
  };

  // Deneme veri iÅŸleme
  const processExamData = useCallback(() => {
    const processed = examData.map(exam => {
      // exam_subjects JSON string olabilir
      let subjects = {};
      try {
        if (exam.exam_subjects) {
          subjects = typeof exam.exam_subjects === 'string' ? JSON.parse(exam.exam_subjects) : exam.exam_subjects;
        } else if (exam.subjects) {
          subjects = typeof exam.subjects === 'string' ? JSON.parse(exam.subjects) : exam.subjects;
        }
      } catch (e) {
        console.warn('Failed to parse exam subjects', e, exam);
      }

      const totalNet = Object.values(subjects).reduce((sum, s) => sum + parseFloat(calculateNet(s?.dogru || 0, s?.yanlis || 0)), 0);

      const result = {
        date: exam.exam_date ? exam.exam_date.split('T')[0] : exam.created_at.split('T')[0],
        totalNet,
        ...Object.fromEntries(
          Object.entries(colors).map(([key]) => [
            key,
            subjects[key] ? parseFloat(calculateNet(subjects[key].dogru || 0, subjects[key].yanlis || 0)) : 0,
          ])
        ),
      };
      
      return result;
    });
    return processed;
  }, [examData, colors, calculateNet]);

  // GÃ¼nlÃ¼k Ã§alÄ±ÅŸma veri iÅŸleme
  const processStudyData = useCallback(() => {
    const processed = studyData.map(study => {
      // study_subjects JSON string olabilir
      let subjects = {};
      try {
        if (study.study_subjects) {
          subjects = typeof study.study_subjects === 'string' ? JSON.parse(study.study_subjects) : study.study_subjects;
        } else if (study.subjects) {
          subjects = typeof study.subjects === 'string' ? JSON.parse(study.subjects) : study.subjects;
        }
      } catch (e) {
        console.warn('Failed to parse study subjects', e);
      }

      return {
        date: study.study_date ? study.study_date.split('T')[0] : study.created_at.split('T')[0],
        ...Object.fromEntries(
          Object.entries(colors).map(([key]) => [
            key,
            subjects[key] ? parseFloat(calculateNet(subjects[key].dogru || 0, subjects[key].yanlis || 0)) : 0,
          ])
        ),
      };
    });
    
    return processed;
  }, [studyData, colors, calculateNet]);

  const processedExams = useMemo(() => processExamData(), [processExamData]);
  const processedStudies = useMemo(() => processStudyData(), [processStudyData]);

  // Performans kartlarÄ± verileri
  const getPerfData = () => {
    if (processedExams.length === 0) return null;

    const lastExam = processedExams[processedExams.length - 1];
    const avgNet = (processedExams.reduce((sum, e) => sum + e.totalNet, 0) / processedExams.length).toFixed(2);
    const maxNet = Math.max(...processedExams.map(e => e.totalNet)).toFixed(2);
    
    let change = 0;
    if (processedExams.length >= 2) {
      const prevTotal = processedExams[processedExams.length - 2].totalNet;
      change = (processedExams[processedExams.length - 1].totalNet - prevTotal).toFixed(2);
    }

    return {
      lastNet: lastExam.totalNet.toFixed(2),
      avgNet,
      maxNet,
      change,
    };
  };

  const perfData = getPerfData();

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 fade-in">
      {/* Header */}
      <div className="mb-8">
        <h1 className="text-3xl font-extrabold mb-6" style={{ color: config.text_color }}>Ã–ÄŸrenci Analizi</h1>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          {/* Ã–ÄŸrenci SeÃ§ici */}
          <div>
            <label htmlFor="student-select" className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Ã–ÄŸrenci SeÃ§</label>
            <select
              id="student-select"
              value={selectedStudentId}
              onChange={(e) => setSelectedStudentId(e.target.value)}
              className="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm"
              style={{ background: config.surface_color }}
            >
              <option value="">-- Ã–ÄŸrenci SeÃ§in --</option>
              {students.map(s => (
                <option key={s.__backendId} value={s.__backendId}>
                  {s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim()}
                </option>
              ))}
            </select>
          </div>

          {/* Tarih Filtreleri */}
          <div className="md:col-span-2">
            <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Zaman AralÄ±ÄŸÄ±</label>
            <div className="flex gap-2">
              {[
                { id: '1month', label: 'Son 1 Ay' },
                { id: '3month', label: 'Son 3 Ay' },
                { id: 'all', label: 'TÃ¼mÃ¼' },
              ].map(btn => (
                <button
                  key={btn.id}
                  onClick={() => setDateFilter(btn.id)}
                  className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all ${
                    dateFilter === btn.id ? 'text-white shadow-lg' : 'border border-gray-200'
                  }`}
                  style={{
                    background: dateFilter === btn.id ? config.primary_action_color : config.surface_color,
                    color: dateFilter === btn.id ? 'white' : config.text_color,
                  }}
                >
                  {btn.label}
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* BoÅŸ durumu gÃ¶ster */}
      {!selectedStudentId ? (
        <div className="flex items-center justify-center py-16 rounded-2xl border-2 border-dashed" style={{ borderColor: '#E2E8F0', background: config.surface_color }}>
          <div className="text-center">
            <div className="text-5xl mb-4">ðŸ“Š</div>
            <p className="text-lg font-semibold" style={{ color: config.text_color }}>LÃ¼tfen Ã¶ÄŸrenci seÃ§in</p>
            <p className="text-sm mt-2" style={{ color: config.secondary_action_color }}>Analiz gÃ¶rmek iÃ§in yukarÄ±dan bir Ã¶ÄŸrenci seÃ§iniz</p>
          </div>
        </div>
      ) : (
        <>
        {/* Performans KartlarÄ± */}
        {perfData ? (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          {/* Son Deneme Neti */}
          <div className="rounded-2xl p-6 shadow-lg" style={{ background: '#EFF6FF', borderLeft: '4px solid #3B82F6' }}>
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="text-sm font-semibold text-gray-600 mb-2">Son Deneme Neti</p>
                <p className="text-3xl font-extrabold" style={{ color: '#3B82F6' }}>{perfData.lastNet}</p>
              </div>
              <span className="text-3xl">ðŸ“Š</span>
            </div>
          </div>

          {/* Ortalama Neti */}
          <div className="rounded-2xl p-6 shadow-lg" style={{ background: '#ECFDF5', borderLeft: '4px solid #10B981' }}>
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="text-sm font-semibold text-gray-600 mb-2">Ortalama Deneme Neti</p>
                <p className="text-3xl font-extrabold" style={{ color: '#10B981' }}>{perfData.avgNet}</p>
              </div>
              <span className="text-3xl">ðŸ“ˆ</span>
            </div>
          </div>

          {/* En YÃ¼ksek Net */}
          <div className="rounded-2xl p-6 shadow-lg" style={{ background: '#FFFBEB', borderLeft: '4px solid #F59E0B' }}>
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="text-sm font-semibold text-gray-600 mb-2">En YÃ¼ksek Net</p>
                <p className="text-3xl font-extrabold" style={{ color: '#F59E0B' }}>{perfData.maxNet}</p>
              </div>
              <span className="text-3xl">ðŸ†</span>
            </div>
          </div>

          {/* Son 3 Deneme DeÄŸiÅŸimi */}
          <div className={`rounded-2xl p-6 shadow-lg border-l-4`} style={{
            background: parseFloat(perfData.change) >= 0 ? '#ECFDF5' : '#FEE2E2',
            borderLeftColor: parseFloat(perfData.change) >= 0 ? '#10B981' : '#EF4444',
          }}>
            <div className="flex items-start justify-between mb-4">
              <div>
                <p className="text-sm font-semibold text-gray-600 mb-2">Son 2 Deneme FarkÄ±</p>
                <div className="flex items-baseline gap-1">
                  <p className="text-3xl font-extrabold" style={{ color: parseFloat(perfData.change) >= 0 ? '#10B981' : '#EF4444' }}>
                    {perfData.change}
                  </p>
                  <span className="text-xl">{parseFloat(perfData.change) >= 0 ? 'â†—ï¸' : 'â†˜ï¸'}</span>
                </div>
              </div>
              <span className="text-3xl">{parseFloat(perfData.change) >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰'}</span>
            </div>
          </div>
        </div>
      ) : (
        <div className="rounded-2xl p-8 text-center mb-8" style={{ background: config.surface_color }}>
          <p className="text-lg" style={{ color: config.secondary_action_color }}>Bu Ã¶ÄŸrenci iÃ§in henÃ¼z deneme verisi yok ðŸ“Š</p>
        </div>
      )}

      {/* Ana Grafikler */}
      {processedExams.length > 0 && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          {/* Deneme BazlÄ± Net GeliÅŸimi */}
          <div className="rounded-2xl p-6 shadow-lg" style={{ background: config.surface_color }}>
            <h3 className="text-lg font-bold mb-4" style={{ color: config.text_color }}>Deneme BazlÄ± Net GeliÅŸimi</h3>
            <svg width="100%" height="280" viewBox="0 0 500 280" preserveAspectRatio="xMidYMid meet">
              {/* Grid Ã§izgileri */}
              {[0, 1, 2, 3, 4].map(i => (
                <line key={`h-${i}`} x1="40" y1={40 + i * 40} x2="480" y2={40 + i * 40} stroke="#E2E8F0" strokeWidth="1" />
              ))}
              <line x1="40" y1="40" x2="40" y2="240" stroke="#94A3B8" strokeWidth="2" />
              <line x1="40" y1="240" x2="480" y2="240" stroke="#94A3B8" strokeWidth="2" />
              
              {/* Ã‡izgi grafik */}
              {processedExams.length > 1 && (
                <polyline
                  points={processedExams.map((d, i) => {
                    const x = 40 + (i / (processedExams.length - 1)) * 440;
                    const maxNet = Math.max(...processedExams.map(e => e.totalNet), 1);
                    const y = 240 - (parseFloat(d.totalNet) / maxNet) * 190;
                    return `${x},${y}`;
                  }).join(' ')}
                  fill="none"
                  stroke="#3B82F6"
                  strokeWidth="3"
                />
              )}
              
              {/* Veri noktalarÄ± ve etiketler */}
              {processedExams.map((d, i) => {
                const x = 40 + (i / (processedExams.length - 1 || 1)) * 440;
                const maxNet = Math.max(...processedExams.map(e => e.totalNet), 1);
                const y = 240 - (parseFloat(d.totalNet) / maxNet) * 190;
                return (
                  <g key={i}>
                    <circle cx={x} cy={y} r="4" fill="#3B82F6" />
                    <text x={x} y={260} textAnchor="middle" fontSize="12" fill={config.text_color} style={{fontWeight: 'bold'}}>
                      {parseFloat(d.totalNet).toFixed(1)}
                    </text>
                  </g>
                );
              })}
            </svg>
          </div>

          {/* GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma Net GeliÅŸimi */}
          <div className="rounded-2xl p-6 shadow-lg" style={{ background: config.surface_color }}>
            <h3 className="text-lg font-bold mb-4" style={{ color: config.text_color }}>GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma Net GeliÅŸimi</h3>
            {processedStudies.length > 0 ? (
              <svg width="100%" height="280" viewBox="0 0 500 280" preserveAspectRatio="xMidYMid meet">
                {/* Grid Ã§izgileri */}
                {[0, 1, 2, 3, 4].map(i => (
                  <line key={`h-${i}`} x1="40" y1={40 + i * 40} x2="480" y2={40 + i * 40} stroke="#E2E8F0" strokeWidth="1" />
                ))}
                <line x1="40" y1="40" x2="40" y2="240" stroke="#94A3B8" strokeWidth="2" />
                <line x1="40" y1="240" x2="480" y2="240" stroke="#94A3B8" strokeWidth="2" />
                
                {/* Ã‡izgi grafik */}
                {processedStudies.length > 1 && (
                  <polyline
                    points={processedStudies.map((d, i) => {
                      const x = 40 + (i / (processedStudies.length - 1)) * 440;
                      const totalDayNets = processedStudies.map(s => ['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din', 'paragraf'].reduce((sum, key) => sum + (s[key] || 0), 0));
                      const maxNet = Math.max(...totalDayNets, 1);
                      const dayTotal = ['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din', 'paragraf'].reduce((sum, key) => sum + (d[key] || 0), 0);
                      const y = 240 - (dayTotal / maxNet) * 190;
                      return `${x},${y}`;
                    }).join(' ')}
                    fill="none"
                    stroke="#10B981"
                    strokeWidth="3"
                  />
                )}
                
                {/* Veri noktalarÄ± ve etiketler */}
                {processedStudies.map((d, i) => {
                  const x = 40 + (i / (processedStudies.length - 1 || 1)) * 440;
                  const totalDayNets = processedStudies.map(s => ['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din', 'paragraf'].reduce((sum, key) => sum + (s[key] || 0), 0));
                  const maxNet = Math.max(...totalDayNets, 1);
                  const dayTotal = ['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din', 'paragraf'].reduce((sum, key) => sum + (d[key] || 0), 0);
                  const y = 240 - (dayTotal / maxNet) * 190;
                  return (
                    <g key={i}>
                      <circle cx={x} cy={y} r="4" fill="#10B981" />
                      <text x={x} y={260} textAnchor="middle" fontSize="12" fill={config.text_color} style={{fontWeight: 'bold'}}>
                        {dayTotal.toFixed(1)}
                      </text>
                    </g>
                  );
                })}
              </svg>
            ) : (
              <div className="h-64 flex items-center justify-center" style={{ background: '#F1F5F9' }}>
                <p style={{ color: config.secondary_action_color }}>GÃ¼nlÃ¼k Ã§alÄ±ÅŸma verisi yok</p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Mini Grafikler - Deneme BazlÄ± */}
      {processedExams.length > 0 && (
        <div className="mb-8">
          <h3 className="text-xl font-bold mb-4" style={{ color: config.text_color }}>Deneme BazlÄ± Ders Analizi</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din'].map(key => {
              const color = colors[key];
              const subjectExams = processedExams.map(e => ({ date: e.date, net: parseFloat(e[key] || 0) }));
              
              const lastNet = subjectExams[subjectExams.length - 1]?.net || 0;
              const previousNet = subjectExams.length > 1 ? (subjectExams[subjectExams.length - 2]?.net || 0) : 0;
              const netChange = lastNet - previousNet;
              const changeText = netChange > 0 ? `+${netChange.toFixed(1)}` : netChange < 0 ? `${netChange.toFixed(1)}` : '=';
              const changeColor = netChange > 0 ? '#10B981' : netChange < 0 ? '#EF4444' : '#64748B';
              
              // SVG Ã§izgi grafik oluÅŸtur
              const maxNet = Math.max(...subjectExams.map(x => x.net), 1) || 1;
              const points = subjectExams.map((d, i) => {
                const x = (i / (subjectExams.length - 1 || 1)) * 280;
                const y = 60 - (d.net / maxNet) * 50;
                return `${x},${y}`;
              }).join(' ');

              return (
                <div key={key} className="rounded-xl p-4 shadow" style={{ background: config.surface_color }}>
                  <div className="flex items-center justify-between mb-3">
                    <h4 className="font-semibold capitalize" style={{ color }}>{key === 'ingilizce' ? 'Ä°ngilizce' : key === 'inkilap' ? 'Ä°nkÄ±lap' : key === 'turkce' ? 'TÃ¼rkÃ§e' : key === 'matematik' ? 'Matematik' : key === 'fen' ? 'Fen' : key === 'din' ? 'Din' : 'Paragraf'}</h4>
                    <span className="text-xs font-bold px-2 py-1 rounded" style={{ background: `${color}20`, color }}>Son: {lastNet.toFixed(1)}</span>
                  </div>
                  <svg width="100%" height="100" viewBox="0 0 300 100" style={{ marginBottom: '8px' }}>
                    {/* Grid Ã§izgileri */}
                    <line x1="0" y1="60" x2="300" y2="60" stroke="#E2E8F0" strokeWidth="1" />
                    {/* Ã‡izgi grafik */}
                    <polyline points={points} fill="none" stroke={color} strokeWidth="2" />
                    {/* Veri noktalarÄ± */}
                    {subjectExams.map((d, i) => {
                      const x = (i / (subjectExams.length - 1 || 1)) * 280;
                      const y = 60 - (d.net / maxNet) * 50;
                      return (
                        <g key={i}>
                          <circle cx={x} cy={y} r="3" fill={color} />
                          <text x={x} y={80} textAnchor="middle" fontSize="11" fill={color} style={{fontWeight: 'bold'}}>
                            {d.net.toFixed(1)}
                          </text>
                        </g>
                      );
                    })}
                  </svg>
                  <div className="flex items-center gap-1 text-xs">
                    <span style={{ color: changeColor }}>{changeText}</span>
                    <span>{netChange > 0 ? 'â†—ï¸' : netChange < 0 ? 'â†˜ï¸' : 'â†’'}</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Mini Grafikler - GÃ¼nlÃ¼k BazlÄ± */}
      {processedStudies.length > 0 && (
        <div>
          <h3 className="text-xl font-bold mb-4" style={{ color: config.text_color }}>GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma Ders Analizi</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din', 'paragraf'].map(key => {
              const color = colors[key];
              const subjectStudies = processedStudies.map(s => ({ date: s.date, questions: s[key] || 0 }));
              
              const lastQuestions = subjectStudies[subjectStudies.length - 1]?.questions || 0;
              const previousQuestions = subjectStudies.length > 1 ? (subjectStudies[subjectStudies.length - 2]?.questions || 0) : 0;
              const questionChange = lastQuestions - previousQuestions;
              const changeText = questionChange > 0 ? `+${questionChange}` : questionChange < 0 ? `${questionChange}` : '=';
              const changeColor = questionChange > 0 ? '#10B981' : questionChange < 0 ? '#EF4444' : '#64748B';
              
              // SVG Ã§izgi grafik oluÅŸtur
              const maxQuestions = Math.max(...subjectStudies.map(x => x.questions), 1) || 1;
              const points = subjectStudies.map((d, i) => {
                const x = (i / (subjectStudies.length - 1 || 1)) * 280;
                const y = 60 - (d.questions / maxQuestions) * 50;
                return `${x},${y}`;
              }).join(' ');

              return (
                <div key={`study-${key}`} className="rounded-xl p-4 shadow" style={{ background: config.surface_color }}>
                  <div className="flex items-center justify-between mb-3">
                    <h4 className="font-semibold capitalize" style={{ color }}>{key === 'ingilizce' ? 'Ä°ngilizce' : key === 'inkilap' ? 'Ä°nkÄ±lap' : key === 'turkce' ? 'TÃ¼rkÃ§e' : key === 'matematik' ? 'Matematik' : key === 'fen' ? 'Fen' : key === 'din' ? 'Din' : 'Paragraf'}</h4>
                    <span className="text-xs font-bold px-2 py-1 rounded" style={{ background: `${color}20`, color }}>Son: {lastQuestions}</span>
                  </div>
                  <svg width="100%" height="100" viewBox="0 0 300 100" style={{ marginBottom: '8px' }}>
                    {/* Grid Ã§izgileri */}
                    <line x1="0" y1="60" x2="300" y2="60" stroke="#E2E8F0" strokeWidth="1" />
                    {/* Ã‡izgi grafik */}
                    {subjectStudies.length > 1 && (
                      <polyline points={points} fill="none" stroke={color} strokeWidth="2" />
                    )}
                    {/* Veri noktalarÄ± */}
                    {subjectStudies.map((d, i) => {
                      const x = (i / (subjectStudies.length - 1 || 1)) * 280;
                      const y = 60 - (d.questions / maxQuestions) * 50;
                      return (
                        <g key={i}>
                          <circle cx={x} cy={y} r="3" fill={color} />
                          <text x={x} y={80} textAnchor="middle" fontSize="11" fill={color} style={{fontWeight: 'bold'}}>
                            {d.questions}
                          </text>
                        </g>
                      );
                    })}
                  </svg>
                  <div className="flex items-center gap-1 text-xs">
                    <span style={{ color: changeColor }}>{changeText}</span>
                    <span>{questionChange > 0 ? 'â†—ï¸' : questionChange < 0 ? 'â†˜ï¸' : 'â†’'}</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}
      </>
      )}
    </div>
  );
}

function DashboardPage({ config }) {
  const { students, exams } = useAppData();
  const [timeFilter, setTimeFilter] = useState('month');
  const studentData = students || [];
  const examData = exams || [];
  const calcSubjectNet = (subject) => {
    if (!subject) return 0;
    const dogru = parseFloat(subject.dogru || 0);
    const yanlis = parseFloat(subject.yanlis || 0);
    return parseFloat((dogru - (yanlis / 3)).toFixed(2));
  };

  // Tarih filtresine gÃ¶re denemeler
  const filteredExams = useMemo(() => {
    if (!examData || examData.length === 0) return [];
    
    const now = new Date();
    const exams = examData
      .map(e => {
        const dateStr = e.exam_date || e.date || new Date().toISOString().split('T')[0];
        const date = new Date(dateStr);
        return { ...e, dateObj: date, date: dateStr };
      })
      .sort((a, b) => a.dateObj - b.dateObj);

    if (timeFilter === 'week') {
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      return exams.filter(e => e.dateObj >= weekAgo);
    } else if (timeFilter === 'month') {
      const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      return exams.filter(e => e.dateObj >= monthAgo);
    } else {
      const threeMonthsAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
      return exams.filter(e => e.dateObj >= threeMonthsAgo);
    }
  }, [examData, timeFilter]);

  // Ä°statistikler
  const stats = useMemo(() => {
    if (!studentData || studentData.length === 0) {
      return {
        totalStudents: 0,
        lastExamAvg: 0,
        upCount: 0,
        downCount: 0,
        allExams: filteredExams,
        classAvgByExam: [],
        lastExamBySubject: {},
        studentStats: []
      };
    }

    const allStudentLastExams = studentData.map(student => {
      const studentExams = (filteredExams || []).filter(e => e.student_id === student.__backendId).sort((a, b) => new Date(a.date || a.exam_date) - new Date(b.date || b.exam_date));
      if (studentExams.length === 0) return null;

      const lastExam = studentExams[studentExams.length - 1];
      const prevExam = studentExams.length > 1 ? studentExams[studentExams.length - 2] : null;

      const lastNet = parseFloat(lastExam.exam_total_net || 0);
      const prevNet = prevExam ? parseFloat(prevExam.exam_total_net || 0) : lastNet;
      const change = lastNet - prevNet;

      return {
        student,
        lastExam,
        prevExam,
        lastNet,
        change,
        studentExams
      };
    }).filter(s => s !== null);

    const upCount = allStudentLastExams.filter(s => s.change > 0).length;
    const downCount = allStudentLastExams.filter(s => s.change < 0).length;

    // SÄ±nÄ±f ortalamasÄ± her deneme iÃ§in
    const examMap = {};
    (filteredExams || []).forEach(exam => {
      const dateKey = exam.exam_date || exam.date;
      if (!examMap[dateKey]) {
        examMap[dateKey] = [];
      }
      examMap[dateKey].push(parseFloat(exam.exam_total_net || 0));
    });

    const classAvgByExam = Object.entries(examMap).map(([date, nets]) => ({
      date,
      avg: nets.reduce((a, b) => a + b, 0) / nets.length
    })).sort((a, b) => new Date(a.date) - new Date(b.date));

    // Son deneme ders ortalamalarÄ±
    const lastExamDates = {};
    (filteredExams || []).forEach(exam => {
      if (!lastExamDates[exam.student_id] || new Date(exam.exam_date || exam.date) > new Date(lastExamDates[exam.student_id].exam_date || lastExamDates[exam.student_id].date)) {
        lastExamDates[exam.student_id] = exam;
      }
    });

    const lastExams = Object.values(lastExamDates);
    const lastExamBySubject = {};
    ['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din'].forEach(subject => {
      const nets = lastExams.map(exam => {
        let subjects = {};
        try {
          subjects = typeof exam.exam_subjects === 'string' ? JSON.parse(exam.exam_subjects) : exam.exam_subjects || {};
        } catch (e) {}
        return calcSubjectNet(subjects[subject]) || 0;
      }).filter(n => n > 0);

      lastExamBySubject[subject] = nets.length > 0 ? (nets.reduce((a, b) => a + b, 0) / nets.length).toFixed(2) : 0;
    });

    const lastExamAvg = allStudentLastExams.length > 0 ? (allStudentLastExams.reduce((sum, s) => sum + s.lastNet, 0) / allStudentLastExams.length).toFixed(2) : 0;

    return {
      totalStudents: studentData.length,
      lastExamAvg,
      upCount,
      downCount,
      allExams: filteredExams,
      classAvgByExam,
      lastExamBySubject,
      studentStats: allStudentLastExams
    };
  }, [studentData, filteredExams]);

  // SÄ±ralamalar
  const rankings = useMemo(() => {
    const bySubject = {};
    ['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din'].forEach(subject => {
      bySubject[subject] = [];
    });

    stats.studentStats.forEach(({ student, lastExam }) => {
      let subjects = {};
      try {
        subjects = typeof lastExam.exam_subjects === 'string' ? JSON.parse(lastExam.exam_subjects) : lastExam.exam_subjects || {};
      } catch (e) {}

      Object.keys(subjects).forEach(subject => {
        if (bySubject[subject] !== undefined) {
          bySubject[subject].push({
            name: student.ad_soyad || student.student_name,
            net: calcSubjectNet(subjects[subject]) || 0
          });
        }
      });
    });

    Object.keys(bySubject).forEach(subject => {
      bySubject[subject].sort((a, b) => b.net - a.net);
    });

    return bySubject;
  }, [stats]);

  const subjectNames = {
    turkce: 'TÃ¼rkÃ§e',
    matematik: 'Matematik',
    fen: 'Fen',
    inkilap: 'Ä°nkÄ±lap',
    ingilizce: 'Ä°ngilizce',
    din: 'Din'
  };

  if (studentData.length === 0) {
    return (
      <div className="max-w-6xl mx-auto px-4 py-12">
        <div className="text-center py-20">
          <p className="text-2xl font-bold mb-2" style={{ color: config.text_color }}>HenÃ¼z Ã¶ÄŸrenci eklenmemiÅŸ ðŸ‘¥</p>
          <p className="text-gray-500">Dashboard verilerini gÃ¶rmek iÃ§in Ã¶nce Ã¶ÄŸrenci ve deneme ekleyin.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 fade-in">
      {/* BaÅŸlÄ±k ve Filtreler */}
      <div className="mb-8">
        <h1 className="text-4xl font-bold mb-6" style={{ color: config.text_color }}>Kontrol Merkezi</h1>
        
        <div className="flex gap-3 flex-wrap">
          {[
            { label: 'Bu Hafta', value: 'week' },
            { label: 'Bu Ay', value: 'month' },
            { label: 'Son 3 Ay', value: 'threeMonths' }
          ].map(btn => (
            <button
              key={btn.value}
              onClick={() => setTimeFilter(btn.value)}
              className={`px-6 py-2 rounded-lg font-semibold transition ${
                timeFilter === btn.value
                  ? 'text-white'
                  : 'border-2'
              }`}
              style={{
                background: timeFilter === btn.value ? config.primary_action_color : 'transparent',
                borderColor: timeFilter === btn.value ? 'transparent' : config.primary_action_color,
                color: timeFilter === btn.value ? 'white' : config.primary_action_color
              }}
            >
              {btn.label}
            </button>
          ))}
        </div>
      </div>

      {/* Genel Durum KartlarÄ± */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        {/* Toplam Ã–ÄŸrenci */}
        <div className="rounded-2xl p-6 shadow-lg text-white" style={{ background: '#3B82F6' }}>
          <div className="flex justify-between items-start mb-4">
            <h3 className="text-gray-100 font-semibold">Toplam Ã–ÄŸrenci</h3>
            <span className="text-3xl">ðŸ‘¥</span>
          </div>
          <p className="text-5xl font-bold">{stats.totalStudents}</p>
        </div>

        {/* Son Deneme OrtalamasÄ± */}
        <div className="rounded-2xl p-6 shadow-lg text-white" style={{ background: '#10B981' }}>
          <div className="flex justify-between items-start mb-4">
            <h3 className="text-green-100 font-semibold">Son Deneme Ort.</h3>
            <span className="text-3xl">ðŸ“Š</span>
          </div>
          <p className="text-5xl font-bold">{stats.lastExamAvg}</p>
        </div>

        {/* YÃ¼kseliÅŸte Olanlar */}
        <div className="rounded-2xl p-6 shadow-lg text-white" style={{ background: '#10B981' }}>
          <div className="flex justify-between items-start mb-4">
            <h3 className="text-green-100 font-semibold">YÃ¼kseliÅŸte</h3>
            <span className="text-3xl">â†—ï¸</span>
          </div>
          <p className="text-5xl font-bold">{stats.upCount}</p>
        </div>

        {/* DÃ¼ÅŸÃ¼ÅŸte Olanlar */}
        <div className="rounded-2xl p-6 shadow-lg text-white" style={{ background: '#F97316' }}>
          <div className="flex justify-between items-start mb-4">
            <h3 className="text-orange-100 font-semibold">DÃ¼ÅŸÃ¼ÅŸte</h3>
            <span className="text-3xl">â†˜ï¸</span>
          </div>
          <p className="text-5xl font-bold">{stats.downCount}</p>
        </div>
      </div>

      {/* Grafikler */}
      {stats.classAvgByExam.length > 0 && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          {/* SÄ±nÄ±f Ortalama Net GeliÅŸimi */}
          <div className="rounded-2xl p-6 shadow-lg" style={{ background: config.surface_color }}>
            <h3 className="text-lg font-bold mb-4" style={{ color: config.text_color }}>SÄ±nÄ±f Ortalama Net GeliÅŸimi</h3>
            <svg width="100%" height="300" viewBox="0 0 500 300" preserveAspectRatio="xMidYMid meet">
              {/* Grid Ã§izgileri */}
              {[0, 1, 2, 3, 4].map(i => (
                <line key={`h-${i}`} x1="40" y1={40 + i * 50} x2="480" y2={40 + i * 50} stroke="#E2E8F0" strokeWidth="1" />
              ))}
              <line x1="40" y1="40" x2="40" y2="290" stroke="#94A3B8" strokeWidth="2" />
              <line x1="40" y1="290" x2="480" y2="290" stroke="#94A3B8" strokeWidth="2" />

              {/* Ã‡izgi */}
              {stats.classAvgByExam.length > 1 && (
                <polyline
                  points={stats.classAvgByExam.map((d, i) => {
                    const x = 40 + (i / (stats.classAvgByExam.length - 1)) * 440;
                    const maxAvg = Math.max(...stats.classAvgByExam.map(e => e.avg), 1);
                    const y = 290 - (d.avg / maxAvg) * 240;
                    return `${x},${y}`;
                  }).join(' ')}
                  fill="none"
                  stroke="#3B82F6"
                  strokeWidth="3"
                />
              )}

              {/* Noktalar ve deÄŸerler */}
              {stats.classAvgByExam.map((d, i) => {
                const x = 40 + (i / (stats.classAvgByExam.length - 1 || 1)) * 440;
                const maxAvg = Math.max(...stats.classAvgByExam.map(e => e.avg), 1);
                const y = 290 - (d.avg / maxAvg) * 240;
                return (
                  <g key={i}>
                    <circle cx={x} cy={y} r="4" fill="#3B82F6" />
                    <text x={x} y={310} textAnchor="middle" fontSize="11" fill={config.text_color} style={{fontWeight: 'bold'}}>
                      {d.avg.toFixed(1)}
                    </text>
                  </g>
                );
              })}
            </svg>
          </div>

          {/* Son Deneme Ders OrtalamalarÄ± - Bar Chart */}
          <div className="rounded-2xl p-6 shadow-lg" style={{ background: config.surface_color }}>
            <h3 className="text-lg font-bold mb-4" style={{ color: config.text_color }}>Son Deneme Ders OrtalamalarÄ±</h3>
            <svg width="100%" height="300" viewBox="0 0 500 300" preserveAspectRatio="xMidYMid meet">
              {/* Grid Ã§izgileri */}
              {[0, 1, 2, 3, 4].map(i => (
                <line key={`h-${i}`} x1="40" y1={40 + i * 50} x2="480" y2={40 + i * 50} stroke="#E2E8F0" strokeWidth="1" />
              ))}
              <line x1="40" y1="40" x2="40" y2="290" stroke="#94A3B8" strokeWidth="2" />
              <line x1="40" y1="290" x2="480" y2="290" stroke="#94A3B8" strokeWidth="2" />

              {/* Barlar */}
              {['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din'].map((subject, i) => {
                const maxVal = 30;
                const val = parseFloat(stats.lastExamBySubject[subject]) || 0;
                const height = (val / maxVal) * 240;
                const x = 60 + (i * 70);
                const colorMap = { turkce: '#EF4444', matematik: '#3B82F6', fen: '#10B981', inkilap: '#F59E0B', ingilizce: '#8B5CF6', din: '#EC4899' };
                
                return (
                  <g key={subject}>
                    <rect x={x} y={290 - height} width="50" height={height} fill={colorMap[subject]} rx="4" />
                    <text x={x + 25} y={310} textAnchor="middle" fontSize="10" fill={config.text_color} style={{fontWeight: 'bold'}}>
                      {subjectNames[subject].substring(0, 3)}
                    </text>
                    <text x={x + 25} y={290 - height - 8} textAnchor="middle" fontSize="11" fill={config.text_color} style={{fontWeight: 'bold'}}>
                      {val}
                    </text>
                  </g>
                );
              })}
            </svg>
          </div>
        </div>
      )}

      {/* En Ä°yi 3 / Dikkat Gereken 3 */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        {/* En Ä°yi 3 */}
        <div className="rounded-2xl p-6 shadow-lg" style={{ background: config.surface_color, borderLeft: '5px solid #10B981' }}>
          <h3 className="text-lg font-bold mb-4" style={{ color: config.text_color }}>En Ä°yi 3 Ã–ÄŸrenci</h3>
          <div className="space-y-3">
            {stats.studentStats
              .sort((a, b) => b.lastNet - a.lastNet)
              .slice(0, 3)
              .map((s, i) => (
                <div key={i} className="flex items-center gap-3 p-3 rounded-lg" style={{ background: '#F0FDF4' }}>
                  <div className="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white" style={{ background: '#10B981' }}>
                    {['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][i]}
                  </div>
                  <div className="flex-1">
                    <p className="font-bold" style={{ color: config.text_color }}>{s.student.ad_soyad || s.student.student_name}</p>
                    <p className="text-sm text-gray-500">{s.lastNet.toFixed(2)} net</p>
                  </div>
                </div>
              ))}
          </div>
        </div>

        {/* Dikkat Gereken 3 */}
        <div className="rounded-2xl p-6 shadow-lg" style={{ background: config.surface_color, borderLeft: '5px solid #F97316' }}>
          <h3 className="text-lg font-bold mb-4" style={{ color: config.text_color }}>Dikkat Gereken 3</h3>
          <div className="space-y-3">
            {stats.studentStats
              .filter(s => s.change < 0)
              .sort((a, b) => a.change - b.change)
              .slice(0, 3)
              .map((s, i) => (
                <div key={i} className="flex items-center gap-3 p-3 rounded-lg" style={{ background: '#FFF7ED' }}>
                  <div className="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white" style={{ background: '#F97316' }}>
                    {i + 1}
                  </div>
                  <div className="flex-1">
                    <p className="font-bold" style={{ color: config.text_color }}>{s.student.ad_soyad || s.student.student_name}</p>
                    <p className="text-sm text-red-600">{s.change.toFixed(2)} net</p>
                  </div>
                </div>
              ))}
          </div>
        </div>
      </div>

      {/* Ders BazlÄ± SÄ±ralamalar */}
      <div className="mb-8">
        <h3 className="text-xl font-bold mb-4" style={{ color: config.text_color }}>Ders BazlÄ± SÄ±ralamalar</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {Object.entries(rankings).map(([subject, students]) => (
            <div key={subject} className="rounded-xl p-4 shadow" style={{ background: config.surface_color }}>
              <h4 className="font-bold mb-3" style={{ color: config.text_color }}>En Ä°yi {subjectNames[subject]}</h4>
              <div className="space-y-2">
                {students.slice(0, 3).map((s, i) => (
                  <div key={i} className="flex justify-between items-center p-2 text-sm" style={{ background: '#F1F5F9', borderRadius: '6px' }}>
                    <span style={{ color: config.text_color }}>{i + 1}. {s.name}</span>
                    <span className="font-bold" style={{ color: config.primary_action_color }}>{s.net.toFixed(1)}</span>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

function LoginPage({ onLogin, config }) {
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const correctPassword = (window.__APP_CONFIG && window.__APP_CONFIG.LOGIN_PASSWORD) || '1234'; // Åžifreyi buraya yazÄ±n

  const handleLogin = (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    // Åžifreyi kontrol et
    if (password === correctPassword) {
      localStorage.setItem('appAuthenticated', 'true');
      onLogin();
    } else {
      setError('âŒ Åžifre hatalÄ±. LÃ¼tfen tekrar deneyin.');
      setPassword('');
    }

    setLoading(false);
  };

  return (
    <div className="h-full w-full flex items-center justify-center" style={{ background: config.background_color }}>
      <div className="rounded-3xl shadow-2xl p-10 max-w-md w-full mx-4 fade-in border border-gray-100" style={{ background: config.surface_color }}>
        <div className="text-center mb-8">
          <div className="text-5xl mb-4">ðŸ”</div>
          <h1 className="text-3xl font-extrabold mb-2" style={{ color: config.text_color }}>
            {config.app_title}
          </h1>
          <p className="text-sm" style={{ color: config.secondary_action_color }}>
            GiriÅŸ yapmak iÃ§in ÅŸifreyi girin
          </p>
        </div>

        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>
              Åžifre
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => {
                setPassword(e.target.value);
                setError('');
              }}
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"
              className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 text-sm font-medium transition-all focus:border-blue-500"
              style={{ color: config.text_color }}
              autoFocus
            />
          </div>

          {error && (
            <div className="p-3 rounded-lg bg-red-50 border border-red-200">
              <p className="text-sm text-red-600 font-medium">{error}</p>
            </div>
          )}

          <button
            type="submit"
            disabled={loading}
            className="w-full px-4 py-3 rounded-xl text-white text-base font-semibold transition-all hover:shadow-lg disabled:opacity-50"
            style={{ background: config.primary_action_color }}
          >
            {loading ? 'â³ Kontrol ediliyor...' : 'âœ“ GiriÅŸ Yap'}
          </button>
        </form>

        <div className="mt-8 pt-6 border-t border-gray-200 text-center">
          <p className="text-xs" style={{ color: config.secondary_action_color }}>
            Â© 2024 {config.app_title}
          </p>
        </div>
      </div>
    </div>
  );
}

function App() {
  const { route, navigate } = useRouter();
  const config = useConfig();
  const [selectedStudentId, setSelectedStudentId] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(() => {
    return localStorage.getItem('appAuthenticated') === 'true';
  });

  const handleLogin = () => {
    setIsAuthenticated(true);
  };

  const handleLogout = () => {
    localStorage.removeItem('appAuthenticated');
    setIsAuthenticated(false);
  };

  if (!isAuthenticated) {
    return <LoginPage onLogin={handleLogin} config={config} />;
  }

  const fontStack = `${config.font_family}, 'Plus Jakarta Sans', sans-serif`;
  const baseFontSize = config.font_size || 16;

  const renderPage = () => {
    switch(route) {
      case 'ogrenciler': return <StudentsPage config={config} onSelectStudent={(id) => { setSelectedStudentId(id); navigate('ogrenci-detay'); }} />;
      case 'ogrenci-detay': return <StudentDetailPage config={config} studentId={selectedStudentId} onBack={() => navigate('ogrenciler')} />;
      case 'gunluk-calisma': return <StudyPage config={config}/>;
      case 'deneme-girisi': return <ExamPage config={config}/>;
      case 'analiz': return <AnalysisPage config={config}/>;
      case 'dashboard': return <DashboardPage config={config}/>;
      default: return <HomePage navigate={navigate} config={config}/>;
    }
  };

  return (
    <div className="h-full w-full flex flex-col overflow-auto" style={{ background: config.background_color, fontFamily: fontStack, fontSize: `${baseFontSize}px` }}>
      <Header route={route} navigate={navigate} config={config} onLogout={handleLogout}/>
      <main className="flex-1">
        {renderPage()}
      </main>
      <footer className="text-center py-4 border-t border-gray-100" style={{background: config.surface_color}}>
        <p className="text-xs" style={{color: config.secondary_action_color}}>Â© 2024 {config.app_title}</p>
      </footer>
    </div>
  );
}

(async function init() {
  const dataHandler = {
    onDataChanged(data) {
      notifyDataChange(data);
    }
  };
  const dataResult = await window.dataSdk.init(dataHandler);
  if (!dataResult.isOk) {
    console.error('Data SDK init failed');
  }

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange: async (config) => {
        notifyConfigChange(config);
        const fontStack = `${config.font_family || defaultConfig.font_family}, 'Plus Jakarta Sans', sans-serif`;
        const baseSize = config.font_size || defaultConfig.font_size;
        document.body.style.fontFamily = fontStack;
        document.body.style.fontSize = `${baseSize}px`;
        const wrapper = document.getElementById('root');
        if (wrapper) wrapper.style.background = config.background_color || defaultConfig.background_color;
      },
      mapToCapabilities: (config) => ({
        recolorables: [
          { get: () => config.background_color || defaultConfig.background_color, set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
          { get: () => config.surface_color || defaultConfig.surface_color, set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); } },
          { get: () => config.text_color || defaultConfig.text_color, set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); } },
          { get: () => config.primary_action_color || defaultConfig.primary_action_color, set: (v) => { config.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); } },
          { get: () => config.secondary_action_color || defaultConfig.secondary_action_color, set: (v) => { config.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); } },
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (v) => { config.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (v) => { config.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
        },
      }),
      mapToEditPanelValues: (config) => new Map([
        ['app_title', config.app_title || defaultConfig.app_title],
        ['welcome_title', config.welcome_title || defaultConfig.welcome_title],
        ['welcome_subtitle', config.welcome_subtitle || defaultConfig.welcome_subtitle],
      ]),
    });
  }

  ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
})();
</script>
</body>
</html>
