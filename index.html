<!doctype html>
<html lang="tr" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ã–ÄŸrenci Takip Sistemi</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/recharts@2.10.3/dist/Recharts.js"></script>
  <script src="https://unpkg.com/react-calendar-heatmap@1.10.0/dist/react-calendar-heatmap.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/react-calendar-heatmap@1.10.0/dist/react-calendar-heatmap.css">
  <script>
    window.__APP_CONFIG = {
      SUPABASE_URL: 'https://mnwxfknxkwwurrevmlri.supabase.co',
      SUPABASE_ANON_KEY: 'sb_publishable_qci3p2BNw3oqVNwd4Fhq9A_pgwOZrpc',
      APP_TITLE: 'Ã–ÄŸrenci Takip Sistemi',
      LOGIN_PASSWORD: '1234'
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Plus Jakarta Sans', sans-serif; }
    html, body, #root { height: 100%; width: 100%; margin: 0; padding: 0; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px -12px rgba(59, 130, 246, 0.15); }
    .nav-link { position: relative; transition: color 0.2s; }
    .nav-link::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 0; height: 2px; background: #3B82F6; transition: width 0.3s; border-radius: 2px; }
    .nav-link:hover::after, .nav-link.active::after { width: 100%; }
    .slide-up { animation: slideUp 0.5s ease-out forwards; opacity: 0; }
    @keyframes slideUp { to { opacity: 1; transform: translateY(0); } from { opacity: 0; transform: translateY(20px); } }
    .modal-backdrop { animation: backdropIn 0.2s ease-out; }
    @keyframes backdropIn { from { opacity: 0; } to { opacity: 1; } }
    .toast-enter { animation: toastIn 0.3s ease-out; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); border-color: #3B82F6; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .heatmap-container { overflow-x: auto; }
    .react-calendar-heatmap text { font-size: 9px; fill: #64748B; }
    .react-calendar-heatmap .color-empty { fill: #ebedf0; }
    .react-calendar-heatmap .color-low { fill: #7bc96f; }
    .react-calendar-heatmap .color-mid { fill: #239a3b; }
    .react-calendar-heatmap .color-high { fill: #196127; }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full">
  <div id="root" class="h-full"></div>
  <script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

const Icons = {
  GraduationCap: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.08a1 1 0 0 0 0 1.832l8.57 3.908a2 2 0 0 0 1.66 0z"/><path d="M22 10v6"/><path d="M6 12.5V16a6 3 0 0 0 12 0v-3.5"/></svg>,
  Users: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
  BookOpen: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M12 7v14"/><path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"/></svg>,
  FileText: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>,
  BarChart3: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M3 3v16a2 2 0 0 0 2 2h16"/><path d="M7 16h8"/><path d="M7 11h12"/><path d="M7 6h3"/></svg>,
  LayoutDashboard: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
  Plus: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
  Trash2: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
  X: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
  Check: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M20 6 9 17l-5-5"/></svg>,
  Edit: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg>,
  Menu: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
};

const studentColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];

const defaultConfig = {
  app_title: (window.__APP_CONFIG && window.__APP_CONFIG.APP_TITLE) || 'Ã–ÄŸrenci Takip Sistemi',
  welcome_title: 'HoÅŸ Geldiniz ðŸ‘‹',
  welcome_subtitle: 'LÃ¼tfen menÃ¼den bir bÃ¶lÃ¼m seÃ§in',
  background_color: '#F8FAFC',
  surface_color: '#FFFFFF',
  text_color: '#1E293B',
  primary_action_color: '#3B82F6',
  secondary_action_color: '#64748B',
  font_family: 'Plus Jakarta Sans',
  font_size: 16,
};

let allData = [];
let dataChangeListeners = [];
function subscribeData(fn) { dataChangeListeners.push(fn); return () => { dataChangeListeners = dataChangeListeners.filter(f => f !== fn); }; }
function notifyDataChange(d) { allData = d; dataChangeListeners.forEach(fn => fn(d)); }
window.notifyDataChange = notifyDataChange;

function useAppData() {
  const [data, setData] = useState(allData);
  useEffect(() => subscribeData(setData), []);
  const students = useMemo(() => data.filter(d => d.type === 'student'), [data]);
  const studies = useMemo(() => data.filter(d => d.type === 'study'), [data]);
  const exams = useMemo(() => data.filter(d => d.type === 'exam'), [data]);
  const definedExams = useMemo(() => data.filter(d => d.type === 'defined_exam'), [data]);
  const quickStudies = useMemo(() => data.filter(d => d.type === 'quick_study'), [data]);
  return { students, studies, exams, definedExams, quickStudies, allData: data };
}

let appConfig = { ...defaultConfig };
let configListeners = [];
function subscribeConfig(fn) { configListeners.push(fn); return () => { configListeners = configListeners.filter(f => f !== fn); }; }
function notifyConfigChange(c) { appConfig = c; configListeners.forEach(fn => fn({...c})); }
function useConfig() {
  const [cfg, setCfg] = useState(appConfig);
  useEffect(() => subscribeConfig(setCfg), []);
  return cfg;
}

function useRouter() {
  const [route, setRoute] = useState('dashboard');
  const navigate = useCallback((r) => setRoute(r), []);
  return { route, navigate };
}

function Toast({ message, type, onClose }) {
  useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
  const bg = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
  return (
    <div className={`fixed top-4 right-4 z-50 toast-enter ${bg} text-white px-5 py-3 rounded-xl shadow-lg flex items-center gap-2`}>
      {type === 'success' ? <Icons.Check size={18}/> : null}
      <span className="text-sm font-medium">{message}</span>
      <button onClick={onClose} className="ml-2 hover:opacity-70"><Icons.X size={16}/></button>
    </div>
  );
}

function ConfirmModal({ message, onConfirm, onCancel }) {
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
      <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 fade-in">
        <p className="text-gray-800 font-medium mb-5">{message}</p>
        <div className="flex gap-3 justify-end">
          <button onClick={onCancel} className="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-100 font-medium text-sm transition-colors">Ä°ptal</button>
          <button onClick={onConfirm} className="px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600 font-medium text-sm transition-colors">Sil</button>
        </div>
      </div>
    </div>
  );
}

function Spinner({ size = 'md' }) {
  const s = size === 'sm' ? 'w-4 h-4' : size === 'lg' ? 'w-8 h-8' : 'w-5 h-5';
  return <div className={`${s} border-2 border-blue-200 border-t-blue-500 rounded-full animate-spin`}></div>;
}

function Header({ route, navigate, config, onLogout }) {
  const [mobileOpen, setMobileOpen] = useState(false);
  const links = [
    { id: 'ogrenciler', label: 'Ã–ÄŸrenciler', icon: Icons.Users },
    { id: 'gunluk-calisma', label: 'GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma', icon: Icons.BookOpen },
    { id: 'deneme-girisi', label: 'Deneme GiriÅŸi', icon: Icons.FileText },
    { id: 'dashboard', label: 'Dashboard', icon: Icons.LayoutDashboard },
  ];
  return (
    <header className="sticky top-0 z-40 border-b" style={{ background: config.surface_color, borderColor: '#E2E8F0' }}>
      <div className="max-w-7xl mx-auto px-4 sm:px-6">
        <div className="flex items-center justify-between h-16">
          <button onClick={() => navigate('dashboard')} className="flex items-center gap-2.5 group">
            <div className="w-9 h-9 rounded-xl flex items-center justify-center" style={{background: config.primary_action_color}}>
              <Icons.GraduationCap size={20} className="text-white"/>
            </div>
            <span className="font-bold text-base hidden sm:block" style={{color: config.text_color}}>{config.app_title}</span>
          </button>
          <nav className="hidden md:flex items-center gap-1">
            {links.map(l => (
              <button key={l.id} onClick={() => navigate(l.id)}
                className={`nav-link px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1.5 transition-colors ${route === l.id ? 'active text-blue-600 bg-blue-50' : ''}`}
                style={{ color: route === l.id ? config.primary_action_color : config.secondary_action_color }}>
                <l.icon size={16}/> {l.label}
              </button>
            ))}
          </nav>
          <div className="flex items-center gap-2">
            <button onClick={onLogout} className="hidden sm:flex px-4 py-2 rounded-lg text-sm font-semibold transition-all items-center gap-1.5 hover:bg-red-50" style={{color: config.secondary_action_color}}>
              ðŸšª Ã‡Ä±kÄ±ÅŸ
            </button>
            <button onClick={() => setMobileOpen(!mobileOpen)} className="md:hidden p-2 rounded-lg hover:bg-gray-100">
              <Icons.Menu size={22} className="text-gray-600"/>
            </button>
          </div>
        </div>
      </div>
      {mobileOpen && (
        <div className="md:hidden border-t border-gray-100 fade-in" style={{background: config.surface_color}}>
          <nav className="px-4 py-3 flex flex-col gap-1">
            {links.map(l => (
              <button key={l.id} onClick={() => { navigate(l.id); setMobileOpen(false); }}
                className={`px-3 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${route === l.id ? 'bg-blue-50' : 'hover:bg-gray-50'}`}
                style={{ color: route === l.id ? config.primary_action_color : config.secondary_action_color }}>
                <l.icon size={16}/> {l.label}
              </button>
            ))}
            <button onClick={() => { onLogout(); setMobileOpen(false); }} className="px-3 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors hover:bg-red-50" style={{color: config.secondary_action_color}}>
              ðŸšª Ã‡Ä±kÄ±ÅŸ
            </button>
          </nav>
        </div>
      )}
    </header>
  );
}

function HomePage({ navigate, config }) {
  const { students, studies, exams } = useAppData();
  const examCount = exams.length;
  const [countdown, setCountdown] = useState({ days: 0, hours: 0, minutes: 0 });
  useEffect(() => {
    const target = new Date(2026, 5, 14, 9, 30, 0); // 14 Haziran 2026
    const tick = () => {
      const now = new Date();
      let diff = target.getTime() - now.getTime();
      if (diff < 0) diff = 0;
      const days = Math.floor(diff / (24 * 60 * 60 * 1000));
      const hours = Math.floor((diff / (60 * 60 * 1000)) % 24);
      const minutes = Math.floor((diff / (60 * 1000)) % 60);
      setCountdown({ days, hours, minutes });
    };
    tick();
    const id = setInterval(tick, 60000);
    return () => clearInterval(id);
  }, []);
  const cards = [
    { id: 'ogrenciler', title: 'Ã–ÄŸrenciler', desc: 'Ã–ÄŸrenci kayÄ±tlarÄ±nÄ± yÃ¶netin', icon: Icons.Users, count: students.length, color: '#3B82F6', bg: '#EFF6FF' },
    { id: 'gunluk-calisma', title: 'GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma', desc: 'Ã‡alÄ±ÅŸma kayÄ±tlarÄ±nÄ± takip edin', icon: Icons.BookOpen, count: studies.length, color: '#10B981', bg: '#ECFDF5' },
    { id: 'deneme-girisi', title: 'Deneme GiriÅŸi', desc: 'Deneme sonuÃ§larÄ±nÄ± kaydedin', icon: Icons.FileText, count: examCount, color: '#F59E0B', bg: '#FFFBEB' },
    { id: 'dashboard', title: 'Dashboard', desc: 'Genel bakÄ±ÅŸ ve Ã¶zet', icon: Icons.LayoutDashboard, count: null, color: '#EC4899', bg: '#FDF2F8' },
  ];
  return (
    <div className="max-w-5xl mx-auto px-4 py-10 fade-in">
      <div className="rounded-2xl p-5 mb-6 border border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3" style={{ background: config.surface_color }}>
        <div>
          <div className="text-sm font-semibold" style={{ color: config.secondary_action_color }}>LGS SayaÃ§ 2026</div>
          <div className="text-lg font-bold" style={{ color: config.text_color }}>14 Haziran 2026</div>
        </div>
        <div className="flex gap-3 text-center">
          {[
            { label: 'GÃ¼n', value: countdown.days },
            { label: 'Saat', value: countdown.hours },
            { label: 'Dak', value: countdown.minutes },
          ].map((c, i) => (
            <div key={i} className="rounded-xl px-4 py-2 border border-gray-100" style={{ background: '#F8FAFC' }}>
              <div className="text-xl font-extrabold" style={{ color: config.text_color }}>{c.value}</div>
              <div className="text-[11px]" style={{ color: config.secondary_action_color }}>{c.label}</div>
            </div>
          ))}
        </div>
      </div>
      <div className="text-center mb-10">
        <h1 className="text-3xl sm:text-4xl font-extrabold mb-3" style={{color: config.text_color}}>{config.welcome_title}</h1>
        <p className="text-base sm:text-lg" style={{color: config.secondary_action_color}}>{config.welcome_subtitle}</p>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
        {cards.map((c, i) => (
          <button key={c.id} onClick={() => navigate(c.id)}
            className="card-hover rounded-2xl p-6 text-left border border-gray-100 slide-up"
            style={{ background: config.surface_color, animationDelay: `${i * 0.08}s` }}>
            <div className="flex items-start justify-between mb-4">
              <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{background: c.bg}}>
                <c.icon size={24} style={{color: c.color}}/>
              </div>
              {c.count !== null && (
                <span className="text-xs font-bold px-2.5 py-1 rounded-full" style={{background: c.bg, color: c.color}}>{c.count}</span>
              )}
            </div>
            <h3 className="font-bold text-base mb-1" style={{color: config.text_color}}>{c.title}</h3>
            <p className="text-sm" style={{color: config.secondary_action_color}}>{c.desc}</p>
          </button>
        ))}
      </div>
    </div>
  );
}

function StudentsPage({ config, onSelectStudent }) {
  const { students, exams } = useAppData();
  const [showForm, setShowForm] = useState(false);
  const [loading, setLoading] = useState(false);
  const [toast, setToast] = useState(null);
  const [editingStudent, setEditingStudent] = useState(null);
  const [form, setForm] = useState({ fullName: '', sinif: '8A', okulNo: '' });

  const resetForm = () => { setForm({ fullName: '', sinif: '8A', okulNo: '' }); setEditingStudent(null); };

  const splitName = (full) => {
    const parts = full.trim().split(/\s+/);
    const name = parts.shift() || '';
    const surname = parts.join(' ');
    return { name, surname };
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!form.fullName.trim() || !form.sinif || !form.okulNo.trim()) {
      setToast({ msg: 'LÃ¼tfen tÃ¼m alanlarÄ± doldurun', type: 'error' });
      return;
    }
    if (students.length >= 999 && !editingStudent) {
      setToast({ msg: 'Maksimum kayÄ±t limitine ulaÅŸÄ±ldÄ± (999)', type: 'error' });
      return;
    }

    const { name, surname } = splitName(form.fullName);
    setLoading(true);
    const payload = {
      type: 'student',
      ad_soyad: form.fullName.trim(),
      sinif: form.sinif,
      okul_numarasi: form.okulNo.trim(),
      student_name: name,
      student_surname: surname,
      student_number: form.okulNo.trim(),
      kayit_tarihi: new Date().toISOString().split('T')[0],
      created_at: new Date().toISOString(),
    };
    const result = editingStudent
      ? await window.dataSdk.update({ ...editingStudent, ...payload })
      : await window.dataSdk.create(payload);
    setLoading(false);

    if (result.isOk) {
      setToast({ msg: editingStudent ? 'Ã–ÄŸrenci gÃ¼ncellendi!' : 'Ã–ÄŸrenci eklendi!', type: 'success' });
      setShowForm(false);
      resetForm();
    } else {
      setToast({ msg: 'Hata oluÅŸtu', type: 'error' });
    }
  };

  const startEdit = (s) => {
    setForm({
      fullName: s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim(),
      sinif: s.sinif || '8A',
      okulNo: s.okul_numarasi || s.student_number || ''
    });
    setEditingStudent(s);
    setShowForm(true);
  };

  const getStudentSummary = (s) => {
    const studentExams = exams.filter(e => e.student_id === s.__backendId);
    if (studentExams.length === 0) return 'HenÃ¼z deneme yok';
    const sorted = [...studentExams].sort((a, b) => new Date(b.exam_date || b.created_at) - new Date(a.exam_date || a.created_at));
    const last = sorted[0];
    return `${studentExams.length} deneme â€¢ Son deneme: ${parseFloat(last.exam_total_net || 0).toFixed(1)} net`;
  };

  return (
    <div className="max-w-6xl mx-auto px-4 py-8 fade-in">
      {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)}/>}

      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-extrabold" style={{color: config.text_color}}>Ã–ÄŸrenciler</h1>
          <p className="text-sm mt-1" style={{color: config.secondary_action_color}}>{students.length} Ã¶ÄŸrenci kayÄ±tlÄ±</p>
        </div>
        <button onClick={() => { resetForm(); setShowForm(true); }}
          className="flex items-center gap-2 px-5 py-2.5 rounded-xl text-white text-sm font-semibold transition-all hover:shadow-lg"
          style={{ background: config.primary_action_color }}>
          <Icons.Plus size={18}/> Ã–ÄŸrenci Ekle
        </button>
      </div>

      {showForm && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 fade-in">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold" style={{color: config.text_color}}>
                {editingStudent ? 'Ã–ÄŸrenciyi DÃ¼zenle' : 'Yeni Ã–ÄŸrenci Ekle'}
              </h2>
              <button onClick={() => { setShowForm(false); resetForm(); }} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Ad Soyad *</label>
                <input value={form.fullName} onChange={(e) => setForm({...form, fullName: e.target.value})}
                  className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium" placeholder="Ã–rn: Ahmet YÄ±lmaz"/>
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>SÄ±nÄ±f *</label>
                  <select value={form.sinif} onChange={(e) => setForm({...form, sinif: e.target.value})}
                    className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium">
                    {['8A','8B','8C','8D','8E','8F'].map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Okul NumarasÄ± *</label>
                  <input value={form.okulNo} onChange={(e) => setForm({...form, okulNo: e.target.value})}
                    className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium" placeholder="Ã–rn: 1254"/>
                </div>
              </div>
              <div className="flex gap-3 justify-end pt-2">
                <button type="button" onClick={() => { setShowForm(false); resetForm(); }}
                  className="px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold">Ä°ptal</button>
                <button type="submit" disabled={loading}
                  className="px-5 py-2 rounded-lg text-white text-sm font-semibold transition-all hover:shadow-lg"
                  style={{ background: config.primary_action_color }}>
                  {loading ? 'Kaydediliyor...' : 'Kaydet'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {students.length === 0 ? (
        <div className="text-center py-12 rounded-2xl border-2 border-dashed border-gray-300">
          <p className="text-lg font-medium" style={{ color: config.secondary_action_color }}>HenÃ¼z Ã¶ÄŸrenci yok</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          {students.map((s, idx) => (
            <button key={s.__backendId} onClick={() => onSelectStudent(s.__backendId)}
              className="rounded-2xl border border-gray-100 p-6 text-left card-hover transition-all"
              style={{background: config.surface_color}}>
              <div className="flex items-start justify-between mb-4">
                <div className="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-lg" style={{background: studentColors[idx % studentColors.length]}}>
                  {((s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim() || '?')[0] || '?').toUpperCase()}
                </div>
                <div className="text-xs px-2 py-1 rounded-full" style={{ background: '#F1F5F9', color: config.secondary_action_color }}>
                  {s.sinif || 'SÄ±nÄ±f?'}
                </div>
              </div>
              <h3 className="text-lg font-bold mb-1" style={{color: config.text_color}}>
                {s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim()}
              </h3>
              <p className="text-sm" style={{color: config.secondary_action_color}}>
                {s.sinif || 'SÄ±nÄ±f?'} â€¢ No: {s.okul_numarasi || s.student_number || '-'}
              </p>
              <p className="text-xs mt-3" style={{color: config.secondary_action_color}}>
                {getStudentSummary(s)}
              </p>
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

function StudentDetailPage({ config, studentId, onBack }) {
  const { students, exams, quickStudies } = useAppData();
  const [detailModal, setDetailModal] = useState(null);
  const [editModal, setEditModal] = useState(false);
  const [confirmDel, setConfirmDel] = useState(false);
  const [showAllExams, setShowAllExams] = useState(false);
  const [showAllStudies, setShowAllStudies] = useState(false);
  const [showWeekDetail, setShowWeekDetail] = useState(null);
  const [selectedStudyIds, setSelectedStudyIds] = useState([]);
  const [editingStudy, setEditingStudy] = useState(null);
  const [saving, setSaving] = useState(false);
  const [form, setForm] = useState({ fullName: '', sinif: '8A', okulNo: '' });
  const [lessonRange, setLessonRange] = useState(30);
  const [trendRange, setTrendRange] = useState(30);
  const [trendHover, setTrendHover] = useState(null);
  const [selectedTrendSubjects, setSelectedTrendSubjects] = useState(null);
  const [selectedLessonSubjects, setSelectedLessonSubjects] = useState(null);
  const [editingExam, setEditingExam] = useState(null);
  const [editExamSubjects, setEditExamSubjects] = useState({});
  const [editExamErrors, setEditExamErrors] = useState({});
  const weekdays = ['Paz', 'Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt'];
  const monthNames = ['Ocak','Åžubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
  const start = new Date(yearStart);
  const end = new Date(yearEnd);
  const days = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    const dateStr = toDateKey(d);
    days.push({
      date: new Date(d),
      dateStr,
      count: dailyTotalsMap[dateStr] || 0
    });
  }
  const weeks = [];
  let week = new Array(7).fill(null);
  days.forEach(day => {
    const dayOfWeek = day.date.getDay();
    week[dayOfWeek] = day;
    if (dayOfWeek === 6) {
      weeks.push(week);
      week = new Array(7).fill(null);
    }
  });
  if (week.some(Boolean)) weeks.push(week);
  const monthPositions = {};
  weeks.forEach((w, idx) => {
    const firstDay = w.find(d => d && d.date.getDate() === 1);
    if (firstDay) {
      monthPositions[idx] = monthNames[firstDay.date.getMonth()];
    }
  });
  const {
    ResponsiveContainer,
    LineChart,
    CartesianGrid,
    XAxis,
    YAxis,
    Tooltip,
    Line,
    BarChart,
    Bar,
    PieChart,
    Pie
  } = window.Recharts || {};

  const student = students.find(s => s.__backendId === studentId);
  if (!student) {
    return (
      <div className="max-w-6xl mx-auto px-4 py-8">
        <button onClick={onBack} className="px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold">Geri</button>
        <div className="mt-6 text-center text-sm" style={{ color: config.secondary_action_color }}>Ã–ÄŸrenci bulunamadÄ±</div>
      </div>
    );
  }

  const displayName = student.ad_soyad || `${student.student_name || ''} ${student.student_surname || ''}`.trim();
  const displayClass = student.sinif || 'SÄ±nÄ±f?';
  const displayNo = student.okul_numarasi || student.student_number || '-';

  const studentExams = exams
    .filter(e => e.student_id === studentId)
    .sort((a, b) => new Date(a.exam_date || a.created_at) - new Date(b.exam_date || b.created_at));

  const totalExams = studentExams.length;
  const totalNetSum = studentExams.reduce((sum, e) => sum + parseFloat(e.exam_total_net || 0), 0);
  const avgNet = totalExams ? (totalNetSum / totalExams).toFixed(2) : '0.00';
  const maxNet = totalExams ? Math.max(...studentExams.map(e => parseFloat(e.exam_total_net || 0))).toFixed(2) : '0.00';
  const minNet = totalExams ? Math.min(...studentExams.map(e => parseFloat(e.exam_total_net || 0))).toFixed(2) : '0.00';
  const lastNet = totalExams ? parseFloat(studentExams[studentExams.length - 1].exam_total_net || 0).toFixed(2) : '0.00';

  const recentExams = studentExams.slice(-10);
  const netSeries = recentExams.map((e) => ({
    date: (e.exam_date || e.created_at || '').toString().split('T')[0],
    total: parseFloat(e.exam_total_net || 0),
    name: e.exam_name || ''
  }));

  const subjects = ['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce', 'din'];
  const subjectLabels = {
    turkce: 'TÃ¼rkÃ§e',
    matematik: 'Matematik',
    fen: 'Fen',
    inkilap: 'Sosyal',
    ingilizce: 'Ä°ngilizce',
    din: 'Din'
  };
  const subjectSeries = subjects.map(key => {
    const series = recentExams.slice(-6).map(e => {
      let subj = {};
      try {
        subj = typeof e.exam_subjects === 'string' ? JSON.parse(e.exam_subjects) : e.exam_subjects || {};
      } catch {}
      if (subj[key]) {
        return parseFloat((parseFloat(subj[key].dogru || 0) - (parseFloat(subj[key].yanlis || 0) / 3)).toFixed(2));
      }
      return 0;
    });
    return { key, name: subjectLabels[key], series };
  });

  const lastExams = [...studentExams].reverse().slice(0, 10);

  const studentQuick = (quickStudies || []).filter(q => q.student_id === studentId);
  const today = new Date();
  const yearStart = new Date(today.getFullYear(), 0, 1);
  const yearEnd = new Date(today.getFullYear(), 11, 31);
  const toLocalDate = (d) => {
    if (!d) return null;
    if (typeof d === 'string') {
      const m = d.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return new Date(parseInt(m[1], 10), parseInt(m[2], 10) - 1, parseInt(m[3], 10));
    }
    const dt = new Date(d);
    if (Number.isNaN(dt.getTime())) return null;
    return dt;
  };
  const toDateKey = (d) => {
    if (!d) return '';
    if (typeof d === 'string') {
      const m = d.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;
    }
    const dt = toLocalDate(d);
    if (!dt) return '';
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  };
  const dailyTotalsMap = {};
  studentQuick.forEach(q => {
    const dateKey = q.study_date ? toDateKey(q.study_date) : '';
    if (!dateKey) return;
    const total = [
      q.tur_d, q.tur_y, q.tur_b,
      q.mat_d, q.mat_y, q.mat_b,
      q.fen_d, q.fen_y, q.fen_b,
      q.ink_d, q.ink_y, q.ink_b,
      q.din_d, q.din_y, q.din_b,
      q.ing_d, q.ing_y, q.ing_b,
    ].reduce((s, v) => s + (parseInt(v || 0, 10)), 0);
    dailyTotalsMap[dateKey] = (dailyTotalsMap[dateKey] || 0) + total;
  });
  const subjectKeys = [
    { key: 'tur', label: 'TÃ¼rkÃ§e', color: '#e11d48' },
    { key: 'mat', label: 'Matematik', color: '#2563eb' },
    { key: 'fen', label: 'Fen', color: '#14b8a6' },
    { key: 'ink', label: 'Sosyal', color: '#f59e0b' },
    { key: 'ing', label: 'Ä°ngilizce', color: '#8b5cf6' },
    { key: 'din', label: 'Din', color: '#84cc16' },
  ];
  const activeTrendSubjects = selectedTrendSubjects === null ? subjectKeys.map(s => s.key) : selectedTrendSubjects;
  const activeLessonSubjects = selectedLessonSubjects === null ? subjectKeys.map(s => s.key) : selectedLessonSubjects;
  const dailySubjectMap = {};
  studentQuick.forEach(q => {
    const dateKey = q.study_date ? toDateKey(q.study_date) : '';
    if (!dateKey) return;
    if (!dailySubjectMap[dateKey]) dailySubjectMap[dateKey] = { tur: 0, mat: 0, fen: 0, ink: 0, ing: 0, din: 0 };
    dailySubjectMap[dateKey].tur += (q.tur_d || 0) + (q.tur_y || 0) + (q.tur_b || 0);
    dailySubjectMap[dateKey].mat += (q.mat_d || 0) + (q.mat_y || 0) + (q.mat_b || 0);
    dailySubjectMap[dateKey].fen += (q.fen_d || 0) + (q.fen_y || 0) + (q.fen_b || 0);
    dailySubjectMap[dateKey].ink += (q.ink_d || 0) + (q.ink_y || 0) + (q.ink_b || 0);
    dailySubjectMap[dateKey].ing += (q.ing_d || 0) + (q.ing_y || 0) + (q.ing_b || 0);
    dailySubjectMap[dateKey].din += (q.din_d || 0) + (q.din_y || 0) + (q.din_b || 0);
  });
  const heatmapValues = Object.entries(dailyTotalsMap).map(([date, count]) => ({ date, count }));
  const startOfWeek = (d) => {
    const date = new Date(d);
    const day = date.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    date.setDate(date.getDate() + diff);
    date.setHours(0, 0, 0, 0);
    return date;
  };
  const weeklyStats = [];
  for (let i = 0; i < 4; i++) {
    const end = new Date(startOfWeek(today));
    end.setDate(end.getDate() - (i * 7));
    const start = new Date(end);
    const label = i === 0 ? 'Bu hafta' : i === 1 ? 'GeÃ§en hafta' : `${i} hafta Ã¶nce`;
    let daysWorked = 0;
    const days = [];
    for (let d = new Date(start); d < new Date(start.getTime() + 7 * 24 * 60 * 60 * 1000); d.setDate(d.getDate() + 1)) {
      const key = toDateKey(d);
      const worked = (dailyTotalsMap[key] || 0) > 0;
      if (worked) daysWorked += 1;
      days.push({ date: new Date(d), worked });
    }
    const pct = ((daysWorked / 7) * 100).toFixed(1);
    const emoji = daysWorked === 7 ? 'ðŸ”¥' : daysWorked >= 5 ? 'ðŸ’ª' : daysWorked >= 3 ? 'ðŸ‘' : daysWorked >= 1 ? 'âš ï¸' : 'âŒ';
    weeklyStats.push({ label, daysWorked, pct, emoji, days });
  }

  const handleEditOpen = () => {
    setForm({
      fullName: displayName,
      sinif: displayClass,
      okulNo: displayNo === '-' ? '' : displayNo
    });
    setEditModal(true);
  };

  const handleUpdate = async (e) => {
    e.preventDefault();
    if (!form.fullName.trim() || !form.sinif || !form.okulNo.trim()) return;
    const parts = form.fullName.trim().split(/\s+/);
    const name = parts.shift() || '';
    const surname = parts.join(' ');
    setSaving(true);
    const result = await window.dataSdk.update({
      ...student,
      type: 'student',
      ad_soyad: form.fullName.trim(),
      sinif: form.sinif,
      okul_numarasi: form.okulNo.trim(),
      student_name: name,
      student_surname: surname,
      student_number: form.okulNo.trim(),
    });
    setSaving(false);
    if (result.isOk) setEditModal(false);
  };

  const handleDelete = async () => {
    setSaving(true);
    const result = await window.dataSdk.delete(student);
    setSaving(false);
    setConfirmDel(false);
    if (result.isOk) onBack();
  };

  return (
    <div className="max-w-6xl mx-auto px-4 py-8 fade-in">
      <div className="flex items-center justify-between mb-6">
        <button onClick={onBack} className="px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold">Geri</button>
        <div className="flex gap-2">
          <button onClick={handleEditOpen} className="px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold">DÃ¼zenle</button>
          <button onClick={() => setConfirmDel(true)} className="px-4 py-2 rounded-lg bg-red-500 text-white text-sm font-semibold">Sil</button>
        </div>
      </div>

      <div className="rounded-2xl p-6 border border-gray-100 mb-6" style={{ background: config.surface_color }}>
        <h1 className="text-2xl font-bold mb-2" style={{ color: config.text_color }}>{displayName}</h1>
        <p className="text-sm" style={{ color: config.secondary_action_color }}>{displayClass} â€¢ No: {displayNo}</p>
      </div>

      <div className="mb-8">
        <h2 className="text-xl font-bold mb-4" style={{ color: config.text_color }}>Deneme Analizi</h2>
        <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
          {[
            { label: 'Toplam Deneme', value: totalExams },
            { label: 'Ortalama Net', value: avgNet },
            { label: 'En YÃ¼ksek Net', value: maxNet },
            { label: 'En DÃ¼ÅŸÃ¼k Net', value: minNet },
            { label: 'Son Deneme', value: lastNet },
          ].map((card, i) => (
            <div key={i} className="rounded-xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
              <p className="text-xs font-semibold mb-1" style={{ color: config.secondary_action_color }}>{card.label}</p>
              <p className="text-2xl font-bold" style={{ color: config.text_color }}>{card.value}</p>
            </div>
          ))}
        </div>

        {totalExams === 0 ? (
          <div className="text-center py-10 rounded-xl border border-dashed" style={{ color: config.secondary_action_color }}>HenÃ¼z deneme verisi girilmemiÅŸ</div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="rounded-2xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
              <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>Net Ä°lerleme (Son 10 Deneme)</h3>
              {netSeries.length === 0 ? (
                <div className="text-center py-10 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z veri yok</div>
              ) : (
                <svg width="100%" height="260" viewBox="0 0 500 260" preserveAspectRatio="xMidYMid meet">
                  {[0, 1, 2, 3, 4].map(i => (
                    <line key={`h-${i}`} x1="40" y1={30 + i * 50} x2="480" y2={30 + i * 50} stroke="#E2E8F0" strokeWidth="1" />
                  ))}
                  <line x1="40" y1="30" x2="40" y2="230" stroke="#94A3B8" strokeWidth="2" />
                  <line x1="40" y1="230" x2="480" y2="230" stroke="#94A3B8" strokeWidth="2" />
                  {netSeries.length > 1 && (
                    <polyline
                      points={netSeries.map((d, i) => {
                        const x = 40 + (i / (netSeries.length - 1)) * 440;
                        const max = Math.max(...netSeries.map(e => e.total), 1);
                        const y = 230 - (d.total / max) * 180;
                        return `${x},${y}`;
                      }).join(' ')}
                      fill="none"
                      stroke="#3B82F6"
                      strokeWidth="3"
                    />
                  )}
                  {netSeries.map((d, i) => {
                    const x = 40 + (i / (netSeries.length - 1 || 1)) * 440;
                    const max = Math.max(...netSeries.map(e => e.total), 1);
                    const y = 230 - (d.total / max) * 180;
                    return (
                      <g key={i}>
                        <circle cx={x} cy={y} r="4" fill="#3B82F6" />
                        <text x={x} y={y - 8} textAnchor="middle" fontSize="10" fill={config.text_color}>{d.total.toFixed(1)}</text>
                        {d.name ? (
                          <text x={x} y={245} textAnchor="middle" fontSize="9" fill={config.secondary_action_color}>
                            {d.name.slice(0, 6)}
                          </text>
                        ) : null}
                      </g>
                    );
                  })}
                </svg>
              )}
            </div>
            <div className="rounded-2xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
              <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>Son Denemeler</h3>
              {recentExams.length === 0 ? (
                <div className="text-center py-10 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z veri yok</div>
              ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div className="rounded-xl p-3 border border-gray-100" style={{ background: '#F1F5F9' }}>
                    <div className="text-xs font-semibold" style={{ color: config.text_color }}>Ortalama Net</div>
                    <div className="text-[10px]" style={{ color: config.secondary_action_color }}>Son {recentExams.length} deneme</div>
                    <div className="mt-2 text-lg font-bold" style={{ color: '#0F172A' }}>
                      {avgNet}
                    </div>
                  </div>
                  <button onClick={() => setShowAllExams(true)} className="rounded-xl p-3 border border-gray-100 text-left hover:shadow-md transition" style={{ background: '#EFF6FF' }}>
                    <div className="text-xs font-semibold" style={{ color: config.text_color }}>TÃ¼m Denemeler</div>
                    <div className="text-[10px]" style={{ color: config.secondary_action_color }}>TÄ±klayarak listele</div>
                    <div className="mt-2 text-lg font-bold" style={{ color: '#1D4ED8' }}>
                      {studentExams.length}
                    </div>
                  </button>
                  <button onClick={() => setShowAllStudies(true)} className="rounded-xl p-3 border border-gray-100 text-left hover:shadow-md transition" style={{ background: '#ECFDF5' }}>
                    <div className="text-xs font-semibold" style={{ color: config.text_color }}>GÃ¼nlÃ¼k Ã‡alÄ±ÅŸmalar</div>
                    <div className="text-[10px]" style={{ color: config.secondary_action_color }}>TÄ±klayarak listele</div>
                    <div className="mt-2 text-lg font-bold" style={{ color: '#059669' }}>
                      {studentQuick.length}
                    </div>
                  </button>
                  {recentExams.slice(-6).reverse().map((e, i) => (
                    <div key={e.__backendId} className="rounded-xl p-3 border border-gray-100" style={{ background: ['#EFF6FF','#ECFDF5','#FEF3C7','#FCE7F3','#F3E8FF','#FFF7ED'][i % 6] }}>
                      <div className="text-xs font-semibold" style={{ color: config.text_color }}>{(e.exam_name || 'Deneme').slice(0, 20)}</div>
                      <div className="text-[10px]" style={{ color: config.secondary_action_color }}>
                        {new Date(e.exam_date || e.created_at).toLocaleDateString('tr-TR')}
                      </div>
                      <div className="mt-2 text-lg font-bold" style={{ color: '#0F172A' }}>
                        {parseFloat(e.exam_total_net || 0).toFixed(1)} net
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

      </div>

      <div className="mb-8">
        <h2 className="text-xl font-bold mb-4" style={{ color: config.text_color }}>Ders Ders Deneme Analizi (Son 6)</h2>
        {subjectSeries.length === 0 ? (
          <div className="text-center py-10 rounded-xl border border-dashed" style={{ color: config.secondary_action_color }}>HenÃ¼z deneme verisi girilmemiÅŸ</div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {subjectSeries.map(s => (
              <div key={s.key} className="rounded-2xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
                <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>{s.name}</h3>
                <svg width="100%" height="200" viewBox="0 0 500 200" preserveAspectRatio="xMidYMid meet">
                  {[0, 1, 2, 3].map(i => (
                    <line key={`h-${i}`} x1="40" y1={30 + i * 40} x2="480" y2={30 + i * 40} stroke="#E2E8F0" strokeWidth="1" />
                  ))}
                  <line x1="40" y1="30" x2="40" y2="170" stroke="#94A3B8" strokeWidth="2" />
                  <line x1="40" y1="170" x2="480" y2="170" stroke="#94A3B8" strokeWidth="2" />
                  {s.series.length > 1 && (
                    <polyline
                      points={s.series.map((v, i) => {
                        const x = 40 + (i / (s.series.length - 1)) * 440;
                        const max = Math.max(...s.series, 1);
                        const y = 170 - (v / max) * 120;
                        return `${x},${y}`;
                      }).join(' ')}
                      fill="none"
                      stroke="#10B981"
                      strokeWidth="3"
                    />
                  )}
                  {s.series.map((v, i) => {
                    const x = 40 + (i / (s.series.length - 1 || 1)) * 440;
                    const max = Math.max(...s.series, 1);
                    const y = 170 - (v / max) * 120;
                    const name = recentExams.slice(-6)[i]?.exam_name || '';
                    return (
                      <g key={i}>
                        <circle cx={x} cy={y} r="4" fill="#10B981" />
                        <text x={x} y={y - 8} textAnchor="middle" fontSize="10" fill={config.text_color}>{v.toFixed(1)}</text>
                        {name ? (
                          <text x={x} y={185} textAnchor="middle" fontSize="9" fill={config.secondary_action_color}>
                            {name.slice(0, 8)}
                          </text>
                        ) : null}
                      </g>
                    );
                  })}
                </svg>
              </div>
            ))}
          </div>
        )}
      </div>

      <div className="mb-8">
        <h2 className="text-xl font-bold mb-4" style={{ color: config.text_color }}>GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma Analizi</h2>
        <div className="rounded-2xl p-4 border border-gray-100 mb-6" style={{ background: config.surface_color }}>
          <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>ðŸ“Š HaftalÄ±k SÃ¼reklilik Skoru</h3>
          <div className="space-y-2">
            {weeklyStats.map((w, i) => (
              <button key={i} onClick={() => setShowWeekDetail(w)} className="w-full text-left flex items-center justify-between px-3 py-2 rounded-lg hover:shadow-sm transition" style={{ background: '#F8FAFC' }}>
                <div className="text-sm" style={{ color: config.text_color }}>
                  {w.label}: {w.daysWorked}/7 gÃ¼n Ã§alÄ±ÅŸtÄ±n! {w.emoji}
                </div>
                <div className="text-sm font-bold" style={{ color: config.primary_action_color }}>
                  %{w.pct}
                </div>
              </button>
            ))}
          </div>
        </div>

        <div className="rounded-2xl p-4 border border-gray-100 mb-4" style={{ background: config.surface_color }}>
          <div className="flex items-start justify-between gap-4">
            <div className="text-xs font-semibold pt-1" style={{ color: config.secondary_action_color }}>Trend & HaftalÄ±k KarÅŸÄ±laÅŸtÄ±rma</div>
            <div className="flex flex-col items-end gap-3">
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setTrendRange(7)}
                  className={`px-3 py-1 rounded-full text-xs font-semibold border ${trendRange === 7 ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-200'}`}
                >
                  Son 7 gÃ¼n
                </button>
                <button
                  onClick={() => setTrendRange(30)}
                  className={`px-3 py-1 rounded-full text-xs font-semibold border ${trendRange === 30 ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-200'}`}
                >
                  Son 30 gÃ¼n
                </button>
              </div>
              <div className="flex flex-wrap gap-2 justify-end">
              <button
                onClick={() => setSelectedTrendSubjects(prev => (prev === null ? [] : null))}
                className="px-3 py-1 rounded-full text-xs font-semibold border border-gray-200"
              >
                TÃ¼mÃ¼
              </button>
              {subjectKeys.map(s => {
                const active = selectedTrendSubjects === null ? true : activeTrendSubjects.includes(s.key);
                return (
                  <button
                    key={s.key}
                    onClick={() => setSelectedTrendSubjects(prev => {
                      if (prev === null) return [s.key];
                      return prev.includes(s.key) ? prev.filter(k => k !== s.key) : [...prev, s.key];
                    })}
                    className={`px-3 py-1 rounded-full text-xs font-semibold border ${active ? 'text-white' : 'border-gray-200'}`}
                    style={{ background: active ? s.color : 'transparent' }}
                  >
                    {s.label}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="rounded-2xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-sm font-semibold" style={{ color: config.text_color }}>ðŸ“ˆ Soru Ã‡Ã¶zÃ¼m Trendi</h3>
            </div>
            {Object.keys(dailyTotalsMap).length === 0 ? (
              <div className="text-center py-10 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z veri yok</div>
            ) : (
              (() => {
                const totalDays = trendRange;
                const days30 = [];
                const avgWindow = [];
                const start = new Date();
                start.setDate(start.getDate() - (totalDays - 1));
                for (let i = 0; i < totalDays; i++) {
                  const d = new Date(start);
                  d.setDate(start.getDate() + i);
                  const key = toDateKey(d);
                const subj = dailySubjectMap[key] || {};
                const total = activeTrendSubjects.reduce((s, k) => s + (subj[k] || 0), 0);
                days30.push({ date: d, total, key });
                avgWindow.push(total);
              }
                const avg = avgWindow.reduce((s, v) => s + v, 0) / (avgWindow.length || 1);
                const max = Math.max(...days30.map(d => d.total), avg, 1);
                return (
                  <svg width="100%" height="240" viewBox="0 0 520 240" preserveAspectRatio="xMidYMid meet">
                    {[0, 1, 2, 3, 4].map(i => (
                      <line key={`h-${i}`} x1="40" y1={20 + i * 45} x2="500" y2={20 + i * 45} stroke="#E2E8F0" strokeWidth="1" />
                    ))}
                    <line x1="40" y1="20" x2="40" y2="200" stroke="#94A3B8" strokeWidth="2" />
                    <line x1="40" y1="200" x2="500" y2="200" stroke="#94A3B8" strokeWidth="2" />
                    {(() => {
                      const avgY = 200 - (avg / max) * 160;
                      return (
                        <>
                          <line x1="40" y1={avgY} x2="500" y2={avgY} stroke="#64748B" strokeWidth="1" strokeDasharray="4 4" />
                          <text x="2" y={avgY - 2} textAnchor="start" fontSize="10" fill="#64748B">Ort: {avg.toFixed(1)}</text>
                        </>
                      );
                    })()}
                    <defs>
                      <linearGradient id="trendFill" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stopColor="#10B981" stopOpacity="0.25" />
                        <stop offset="100%" stopColor="#EF4444" stopOpacity="0.1" />
                      </linearGradient>
                    </defs>
                    <polyline
                      points={days30.map((d, i) => {
                        const x = 40 + (i / ((days30.length - 1) || 1)) * 460;
                        const y = 200 - (d.total / max) * 160;
                        return `${x},${y}`;
                      }).join(' ')}
                      fill="none"
                      stroke="#3B82F6"
                      strokeWidth="2.5"
                    />
                    {days30.map((d, i) => {
                      const x = 40 + (i / ((days30.length - 1) || 1)) * 460;
                      const y = 200 - (d.total / max) * 160;
                      const color = d.total >= avg ? '#10B981' : '#EF4444';
                      const title = d.date.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', weekday: 'long' }) + ` - ${d.total} soru`;
                      return (
                        <g
                          key={d.key}
                          style={{ pointerEvents: 'all' }}
                          onMouseEnter={() => setTrendHover({ x, y, text: title })}
                          onMouseLeave={() => setTrendHover(null)}
                        >
                          <circle cx={x} cy={y} r="10" fill="transparent" />
                          <circle cx={x} cy={y} r="3.5" fill={color} />
                          {i % (days30.length <= 10 ? 1 : 5) === 0 ? (
                            <text x={x} y={220} textAnchor="middle" fontSize="9" fill={config.secondary_action_color}>
                              {d.date.getDate()}/{d.date.getMonth() + 1}
                            </text>
                          ) : null}
                          {i % (days30.length <= 10 ? 1 : 5) === 0 ? (
                            <text x={x} y={y - 6} textAnchor="middle" fontSize="8" fill={config.text_color}>{d.total}</text>
                          ) : null}
                        </g>
                      );
                    })}
                    {trendHover && (
                      <g>
                        <rect x={Math.min(trendHover.x + 8, 320)} y={Math.max(trendHover.y - 28, 8)} width="190" height="20" rx="6" fill="#0F172A" opacity="0.9" />
                        <text x={Math.min(trendHover.x + 14, 326)} y={Math.max(trendHover.y - 14, 22)} fontSize="9" fill="#fff">{trendHover.text}</text>
                      </g>
                    )}
                  </svg>
                );
              })()
            )}
          </div>

          <div className="rounded-2xl p-4 border border-gray-100" style={{ background: config.surface_color }}>
            <h3 className="text-sm font-semibold mb-3" style={{ color: config.text_color }}>ðŸ“Š HaftalÄ±k KarÅŸÄ±laÅŸtÄ±rma</h3>
            {Object.keys(dailyTotalsMap).length === 0 ? (
              <div className="text-center py-10 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z veri yok</div>
            ) : (
              (() => {
                const weeks = [];
                for (let i = 5; i >= 0; i--) {
                  const end = new Date(startOfWeek(today));
                  end.setDate(end.getDate() - (i * 7));
                  const start = new Date(end);
                  let total = 0;
                  for (let d = new Date(start); d < new Date(start.getTime() + 7 * 24 * 60 * 60 * 1000); d.setDate(d.getDate() + 1)) {
                    const key = toDateKey(d);
                    const subj = dailySubjectMap[key] || {};
                    const dayTotal = activeTrendSubjects.reduce((s, k) => s + (subj[k] || 0), 0);
                    total += dayTotal;
                  }
                  weeks.push({ label: `${6 - i}. Hafta`, total });
                }
                const max = Math.max(...weeks.map(w => w.total), 1);
                return (
                  <svg width="100%" height="240" viewBox="0 0 520 240" preserveAspectRatio="xMidYMid meet">
                    {[0, 1, 2, 3, 4].map(i => (
                      <line key={`h-${i}`} x1="40" y1={20 + i * 45} x2="500" y2={20 + i * 45} stroke="#E2E8F0" strokeWidth="1" />
                    ))}
                    <line x1="40" y1="20" x2="40" y2="200" stroke="#94A3B8" strokeWidth="2" />
                    <line x1="40" y1="200" x2="500" y2="200" stroke="#94A3B8" strokeWidth="2" />
                    {weeks.map((w, i) => {
                      const x = 60 + i * 70;
                      const h = (w.total / max) * 160;
                      return (
                        <g key={w.label}>
                          <rect x={x} y={200 - h} width="40" height={h} fill="#3B82F6" rx="4" />
                          <text x={x + 20} y={200 - h - 6} textAnchor="middle" fontSize="10" fill={config.text_color}>{w.total}</text>
                          <text x={x + 20} y={220} textAnchor="middle" fontSize="9" fill={config.secondary_action_color}>{w.label}</text>
                        </g>
                      );
                    })}
                  </svg>
                );
              })()
            )}
          </div>
        </div>

        <div className="rounded-2xl p-4 border border-gray-100 mt-6" style={{ background: config.surface_color }}>
            <div className="flex items-center justify-between mb-4">
              <div className="text-xs font-semibold" style={{ color: config.secondary_action_color }}>Ders BazlÄ± Analizler</div>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setLessonRange(7)}
                  className={`px-3 py-1 rounded-full text-xs font-semibold border ${lessonRange === 7 ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-200'}`}
                >
                  Son 7 gÃ¼n
              </button>
              <button
                onClick={() => setLessonRange(30)}
                className={`px-3 py-1 rounded-full text-xs font-semibold border ${lessonRange === 30 ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-200'}`}
              >
                Son 30 gÃ¼n
                </button>
              </div>
            </div>
            <div className="flex items-center justify-between mb-4">
              <div className="text-xs font-semibold" style={{ color: config.secondary_action_color }}>Ders Filtreleri</div>
              <div className="flex flex-wrap gap-2">
              <button
                onClick={() => setSelectedLessonSubjects(prev => (prev === null ? [] : null))}
                className="px-3 py-1 rounded-full text-xs font-semibold border border-gray-200"
              >
                TÃ¼mÃ¼
              </button>
              {subjectKeys.map(s => {
                const active = selectedLessonSubjects === null ? true : activeLessonSubjects.includes(s.key);
                return (
                  <button
                    key={s.key}
                    onClick={() => setSelectedLessonSubjects(prev => {
                      if (prev === null) return [s.key];
                      return prev.includes(s.key) ? prev.filter(k => k !== s.key) : [...prev, s.key];
                    })}
                    className={`px-3 py-1 rounded-full text-xs font-semibold border ${active ? 'text-white' : 'border-gray-200'}`}
                    style={{ background: active ? s.color : 'transparent' }}
                  >
                    {s.label}
                  </button>
                );
              })}
            </div>
          </div>

          {Object.keys(dailySubjectMap).length === 0 ? (
            <div className="text-center py-8 text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z Ã§alÄ±ÅŸma verisi girilmemiÅŸ</div>
          ) : (
            (() => {
              const rangeDays = lessonRange;
              const end = new Date();
              const start = new Date();
              start.setDate(end.getDate() - (rangeDays - 1));
              const days = [];
              for (let i = 0; i < rangeDays; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                const key = toDateKey(d);
                const subj = dailySubjectMap[key] || { tur: 0, mat: 0, fen: 0, ink: 0, ing: 0, din: 0 };
                const total = activeLessonSubjects.reduce((s, k) => s + (subj[k] || 0), 0);
                days.push({ date: d, key, subj, total });
              }
              const totalsBySubject = subjectKeys.reduce((acc, s) => {
                acc[s.key] = days.reduce((t, d) => t + (d.subj[s.key] || 0), 0);
                return acc;
              }, {});
              const totalAll = activeLessonSubjects.reduce((s, k) => s + (totalsBySubject[k] || 0), 0);
              const maxDay = Math.max(...days.map(d => d.total), 1);
              const maxAvg = Math.max(...Object.values(totalsBySubject).map(v => v / (rangeDays || 1)), 1);
              return (
                <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                  <div className="rounded-2xl p-4 border border-gray-100" style={{ background: '#F8FAFC' }}>
                    <h4 className="text-xs font-semibold mb-3" style={{ color: config.text_color }}>ðŸ“Š Ders DaÄŸÄ±lÄ±mÄ± (YÄ±ÄŸÄ±lmÄ±ÅŸ Bar)</h4>
                    <svg width="100%" height="260" viewBox="0 0 560 260" preserveAspectRatio="xMidYMid meet">
                      {[0, 1, 2, 3, 4].map(i => (
                        <line key={`h-${i}`} x1="40" y1={30 + i * 45} x2="540" y2={30 + i * 45} stroke="#E2E8F0" strokeWidth="1" />
                      ))}
                      <line x1="40" y1="30" x2="40" y2="230" stroke="#94A3B8" strokeWidth="2" />
                      <line x1="40" y1="230" x2="540" y2="230" stroke="#94A3B8" strokeWidth="2" />
                      {days.map((d, i) => {
                        const x = 50 + (i / (days.length - 1 || 1)) * 470;
                        const barW = days.length > 20 ? 10 : 14;
                        let yCursor = 230;
                        return (
                          <g key={d.key}>
                            <title>{d.date.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', weekday: 'long' })} - {d.total} soru</title>
                            {subjectKeys.filter(s => activeLessonSubjects.includes(s.key)).map(s => {
                              const val = d.subj[s.key] || 0;
                              const h = (val / maxDay) * 180;
                              yCursor -= h;
                              return h > 0 ? (
                                <rect key={s.key} x={x} y={yCursor} width={barW} height={h} fill={s.color} rx="2" />
                              ) : null;
                            })}
                            {(i % 5 === 0 || days.length <= 10) ? (
                              <text x={x + barW / 2} y={245} textAnchor="middle" fontSize="9" fill={config.secondary_action_color}>
                                {d.date.getDate()}/{d.date.getMonth() + 1}
                              </text>
                            ) : null}
                          </g>
                        );
                      })}
                    </svg>
                    <div className="flex flex-wrap gap-3 mt-2 text-[11px]" style={{ color: config.secondary_action_color }}>
                      {subjectKeys.filter(s => activeLessonSubjects.includes(s.key)).map(s => (
                        <div key={s.key} className="flex items-center gap-1">
                          <span className="w-3 h-3 rounded-sm inline-block" style={{ background: s.color }}></span>
                          <span>{s.label}</span>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="grid grid-cols-1 gap-6">
                    <div className="rounded-2xl p-4 border border-gray-100" style={{ background: '#F8FAFC' }}>
                      <h4 className="text-xs font-semibold mb-3" style={{ color: config.text_color }}>ðŸŸ£ Ders BazlÄ± Toplam Soru (Donut)</h4>
                      {totalAll === 0 ? (
                        <div className="text-center py-10 text-sm" style={{ color: config.secondary_action_color }}>SeÃ§ilen aralÄ±kta veri yok</div>
                      ) : (
                        <div className="flex items-center gap-6">
                          <svg width="220" height="220" viewBox="0 0 220 220">
                            <g transform="translate(110,110)">
                              {(() => {
                                let acc = 0;
                                const r = 80;
                                const inner = 48;
                                return subjectKeys.filter(s => activeLessonSubjects.includes(s.key)).map(s => {
                                  const v = totalsBySubject[s.key] || 0;
                                  const pct = v / totalAll;
                                  const startAngle = acc * 2 * Math.PI;
                                  const endAngle = (acc + pct) * 2 * Math.PI;
                                  acc += pct;
                                  if (v === 0) return null;
                                  const x1 = r * Math.cos(startAngle);
                                  const y1 = r * Math.sin(startAngle);
                                  const x2 = r * Math.cos(endAngle);
                                  const y2 = r * Math.sin(endAngle);
                                  const large = pct > 0.5 ? 1 : 0;
                                  const path = [
                                    `M ${x1} ${y1}`,
                                    `A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`,
                                    `L ${inner * Math.cos(endAngle)} ${inner * Math.sin(endAngle)}`,
                                    `A ${inner} ${inner} 0 ${large} 0 ${inner * Math.cos(startAngle)} ${inner * Math.sin(startAngle)}`,
                                    'Z'
                                  ].join(' ');
                                  return <path key={s.key} d={path} fill={s.color} />;
                                });
                              })()}
                              <circle r="44" fill="white" />
                              <text textAnchor="middle" y="-2" fontSize="12" fill={config.secondary_action_color}>Toplam</text>
                              <text textAnchor="middle" y="16" fontSize="18" fontWeight="700" fill={config.text_color}>{totalAll}</text>
                            </g>
                          </svg>
                          <div className="space-y-2 text-xs">
                            {subjectKeys.filter(s => activeLessonSubjects.includes(s.key)).map(s => {
                              const v = totalsBySubject[s.key] || 0;
                              const pct = totalAll ? ((v / totalAll) * 100).toFixed(1) : '0.0';
                              return (
                                <div key={s.key} className="flex items-center justify-between gap-3">
                                  <div className="flex items-center gap-2">
                                    <span className="w-3 h-3 rounded-sm inline-block" style={{ background: s.color }}></span>
                                    <span>{s.label}</span>
                                  </div>
                                  <div className="font-semibold" style={{ color: config.text_color }}>{v} ({pct}%)</div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}
                    </div>

                  </div>
                </div>
              );
            })()
          )}
        </div>
      </div>

      {detailModal && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 fade-in" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>{detailModal.exam_name}</h3>
              <button onClick={() => setDetailModal(null)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <div className="text-sm mb-4" style={{ color: config.secondary_action_color }}>
              {new Date(detailModal.exam_date || detailModal.created_at).toLocaleDateString('tr-TR')}
            </div>
            <div className="space-y-2">
              {subjects.map(key => {
                let subj = {};
                try { subj = typeof detailModal.exam_subjects === 'string' ? JSON.parse(detailModal.exam_subjects) : detailModal.exam_subjects || {}; } catch {}
                const s = subj[key];
                if (!s) return null;
                const net = (parseFloat(s.dogru || 0) - (parseFloat(s.yanlis || 0) / 3)).toFixed(2);
                return (
                  <div key={key} className="flex justify-between text-sm">
                    <span>{subjectLabels[key]}</span>
                    <span className="font-semibold">{net}</span>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}

      {showAllExams && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-2xl w-full mx-4 fade-in max-h-[80vh] overflow-y-auto" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>TÃ¼m Denemeler</h3>
              <button onClick={() => setShowAllExams(false)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            {studentExams.length === 0 ? (
              <div className="text-center py-8" style={{ color: config.secondary_action_color }}>HenÃ¼z deneme verisi girilmemiÅŸ</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-left" style={{ color: config.secondary_action_color }}>
                      <th className="py-2">Tarih</th>
                      <th>Deneme AdÄ±</th>
                      <th>Tip</th>
                      <th>Toplam Net</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {[...studentExams].reverse().map(e => (
                      <tr key={e.__backendId} className="border-t">
                        <td className="py-2">{new Date(e.exam_date || e.created_at).toLocaleDateString('tr-TR')}</td>
                        <td>{e.exam_name}</td>
                        <td>{e.deneme_tipi === 'bireysel' ? 'Bireysel' : 'Ortak'}</td>
                        <td className="font-semibold">{parseFloat(e.exam_total_net || 0).toFixed(2)}</td>
                        <td className="flex gap-2">
                          <button onClick={() => handleOpenEditExam(e)} className="text-blue-600 text-xs font-semibold hover:underline">âœï¸</button>
                          <button onClick={() => setDetailModal(e)} className="text-blue-600 text-xs font-semibold hover:underline">ðŸ‘ï¸</button>
                          <button onClick={() => handleDeleteExam(e)} disabled={saving} className="text-red-600 text-xs font-semibold hover:underline disabled:opacity-50">ðŸ—‘ï¸</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      )}

      {showAllStudies && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-3xl w-full mx-4 fade-in max-h-[80vh] overflow-y-auto" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>TÃ¼m GÃ¼nlÃ¼k Ã‡alÄ±ÅŸmalar</h3>
              <button onClick={() => setShowAllStudies(false)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <div className="flex items-center justify-between mb-3">
              <label className="text-xs" style={{ color: config.secondary_action_color }}>
                <input
                  type="checkbox"
                  checked={selectedStudyIds.length === studentQuick.length && studentQuick.length > 0}
                  onChange={(e) => setSelectedStudyIds(e.target.checked ? studentQuick.map(s => s.__backendId) : [])}
                /> TÃ¼mÃ¼nÃ¼ seÃ§
              </label>
              <button
                onClick={async () => {
                  if (selectedStudyIds.length === 0) return;
                  for (const id of selectedStudyIds) {
                    const rec = studentQuick.find(s => s.__backendId === id);
                    if (rec) await window.dataSdk.delete({ type: 'quick_study', __backendId: rec.__backendId });
                  }
                  setSelectedStudyIds([]);
                }}
                className="px-3 py-1.5 rounded-lg text-xs font-semibold border border-red-200 text-red-600 hover:bg-red-50"
              >
                SeÃ§ilileri Sil
              </button>
            </div>
            {studentQuick.length === 0 ? (
              <div className="text-center py-8" style={{ color: config.secondary_action_color }}>HenÃ¼z Ã§alÄ±ÅŸma verisi girilmemiÅŸ</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-left" style={{ color: config.secondary_action_color }}>
                      <th className="py-2"></th>
                      <th className="py-2">Tarih</th>
                      <th>TÃ¼rkÃ§e</th>
                      <th>Mat</th>
                      <th>Fen</th>
                      <th>Sosyal</th>
                      <th>Ä°ng</th>
                      <th>Din</th>
                      <th>Toplam</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {[...studentQuick].sort((a,b) => {
                      const da = toLocalDate(a.study_date);
                      const db = toLocalDate(b.study_date);
                      return (db ? db.getTime() : 0) - (da ? da.getTime() : 0);
                    }).map((q) => {
                      const total =
                        (q.tur_d||0)+(q.tur_y||0)+(q.tur_b||0)+
                        (q.mat_d||0)+(q.mat_y||0)+(q.mat_b||0)+
                        (q.fen_d||0)+(q.fen_y||0)+(q.fen_b||0)+
                        (q.ink_d||0)+(q.ink_y||0)+(q.ink_b||0)+
                        (q.ing_d||0)+(q.ing_y||0)+(q.ing_b||0)+
                        (q.din_d||0)+(q.din_y||0)+(q.din_b||0);
                      const displayDate = toLocalDate(q.study_date);
                      return (
                        <tr key={q.__backendId} className="border-t">
                          <td>
                            <input
                              type="checkbox"
                              checked={selectedStudyIds.includes(q.__backendId)}
                              onChange={(e) => setSelectedStudyIds(prev => e.target.checked ? [...prev, q.__backendId] : prev.filter(id => id !== q.__backendId))}
                            />
                          </td>
                          <td className="py-2">{displayDate ? displayDate.toLocaleDateString('tr-TR') : ''}</td>
                          <td>{(q.tur_d||0)+(q.tur_y||0)+(q.tur_b||0)}</td>
                          <td>{(q.mat_d||0)+(q.mat_y||0)+(q.mat_b||0)}</td>
                          <td>{(q.fen_d||0)+(q.fen_y||0)+(q.fen_b||0)}</td>
                          <td>{(q.ink_d||0)+(q.ink_y||0)+(q.ink_b||0)}</td>
                          <td>{(q.ing_d||0)+(q.ing_y||0)+(q.ing_b||0)}</td>
                          <td>{(q.din_d||0)+(q.din_y||0)+(q.din_b||0)}</td>
                          <td className="font-semibold">{total}</td>
                          <td className="space-x-2">
                            <button onClick={() => setEditingStudy(q)} className="text-blue-600 text-xs font-semibold">DÃ¼zenle</button>
                            <button onClick={async () => { await window.dataSdk.delete({ type: 'quick_study', __backendId: q.__backendId }); }} className="text-red-600 text-xs font-semibold">Sil</button>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      )}

      {editingExam && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-2xl w-full mx-4 fade-in max-h-[80vh] overflow-y-auto" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>Deneme DÃ¼zenle</h3>
              <button onClick={() => setEditingExam(null)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <div className="grid grid-cols-2 gap-4 mb-6">
              {quickSubjects.map(s => (
                <div key={s.key} className="rounded-xl p-4" style={{ background: s.soft }}>
                  <div className="text-xs font-bold mb-3" style={{ color: s.accent }}>{s.label}</div>
                  <div className="space-y-2">
                    <div>
                      <label className="text-xs font-semibold" style={{ color: s.accent }}>DoÄŸru</label>
                      <input
                        type="text"
                        inputMode="numeric"
                        maxLength={3}
                        value={editExamSubjects[s.key]?.dogru || ''}
                        onChange={(e) => handleEditExamSubjectChange(s.key, 'dogru', e.target.value)}
                        className="w-full px-2 py-1.5 rounded border text-sm font-semibold text-center"
                        style={{ background: 'white', borderColor: editExamErrors[s.key] ? '#EF4444' : s.soft }}
                      />
                    </div>
                    <div>
                      <label className="text-xs font-semibold" style={{ color: s.accent }}>YanlÄ±ÅŸ</label>
                      <input
                        type="text"
                        inputMode="numeric"
                        maxLength={3}
                        value={editExamSubjects[s.key]?.yanlis || ''}
                        onChange={(e) => handleEditExamSubjectChange(s.key, 'yanlis', e.target.value)}
                        className="w-full px-2 py-1.5 rounded border text-sm font-semibold text-center"
                        style={{ background: 'white', borderColor: editExamErrors[s.key] ? '#EF4444' : s.soft }}
                      />
                    </div>
                    {editExamErrors[s.key] && (
                      <div className="text-xs font-semibold text-red-600 text-center">
                        {editExamErrors[s.key]}
                      </div>
                    )}
                    <div className="rounded py-1.5 text-center text-xs font-bold" style={{ background: s.soft, color: s.accent }}>
                      Net: {calculateNet(editExamSubjects[s.key]?.dogru, editExamSubjects[s.key]?.yanlis)}
                    </div>
                  </div>
                </div>
              ))}
            </div>
            <div className="rounded-xl p-4 mb-6 text-center" style={{ background: '#ECFDF5', border: '1px solid #BBF7D0' }}>
              <span className="text-sm font-semibold" style={{ color: '#059669' }}>Toplam Net: </span>
              <span className="text-lg font-bold" style={{ color: '#047857' }}>{calculateEditExamNet()}</span>
            </div>
            <div className="flex gap-3">
              <button
                onClick={handleSaveEditExam}
                disabled={saving || Object.keys(editExamErrors).length > 0}
                className="flex-1 px-4 py-2 rounded-lg bg-green-600 text-white text-sm font-bold hover:bg-green-700 transition disabled:opacity-60"
              >
                {saving ? 'Kaydediliyor...' : 'âœ“ Kaydet'}
              </button>
              <button
                onClick={() => setEditingExam(null)}
                disabled={saving}
                className="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 text-sm font-bold hover:bg-gray-50 transition disabled:opacity-60"
              >
                Ä°ptal
              </button>
            </div>
          </div>
        </div>
      )}

      {editingStudy && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 fade-in" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma DÃ¼zenle</h3>
              <button onClick={() => setEditingStudy(null)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
              {[
                ['tur', 'TÃ¼rkÃ§e'], ['mat', 'Mat'], ['fen', 'Fen'], ['ink', 'Sosyal'], ['ing', 'Ä°ng'], ['din', 'Din']
              ].map(([k, label]) => (
                <div key={k} className="rounded-lg border border-gray-100 p-2">
                  <div className="text-xs font-semibold mb-1" style={{ color: config.secondary_action_color }}>{label}</div>
                  <div className="flex gap-2">
                    {['d','y','b'].map(t => (
                      <input key={t} type="number" min="0" value={editingStudy[`${k}_${t}`] || 0}
                        onChange={(e) => setEditingStudy(prev => ({ ...prev, [`${k}_${t}`]: parseInt(e.target.value || 0, 10) })) }
                        className="w-1/3 px-2 py-1 rounded border border-gray-200 text-xs text-center" />
                    ))}
                  </div>
                </div>
              ))}
            </div>
            <div className="flex justify-end gap-2 mt-4">
              <button onClick={() => setEditingStudy(null)} className="px-3 py-2 rounded-lg border border-gray-200 text-sm font-semibold">Ä°ptal</button>
              <button onClick={async () => { await window.dataSdk.update({ ...editingStudy, type: 'quick_study' }); setEditingStudy(null); }}
                className="px-4 py-2 rounded-lg text-white text-sm font-semibold" style={{ background: config.primary_action_color }}>
                Kaydet
              </button>
            </div>
          </div>
        </div>
      )}

      {showWeekDetail && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 fade-in" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>{showWeekDetail.label}</h3>
              <button onClick={() => setShowWeekDetail(null)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <div className="space-y-2">
              {showWeekDetail.days.map((d, i) => (
                <div key={i} className="flex items-center justify-between px-3 py-2 rounded-lg" style={{ background: '#F8FAFC' }}>
                  <div className="text-sm" style={{ color: config.text_color }}>
                    {d.date.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', weekday: 'long' })}
                  </div>
                  <div className="text-sm font-semibold" style={{ color: d.worked ? '#10B981' : '#EF4444' }}>
                    {d.worked ? 'âœ”ï¸ Ã‡alÄ±ÅŸÄ±ldÄ±' : 'âœ–ï¸ Veri yok'}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {editModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 fade-in">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold" style={{color: config.text_color}}>Ã–ÄŸrenciyi DÃ¼zenle</h2>
              <button onClick={() => setEditModal(false)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            <form onSubmit={handleUpdate} className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Ad Soyad *</label>
                <input value={form.fullName} onChange={(e) => setForm({...form, fullName: e.target.value})}
                  className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium"/>
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>SÄ±nÄ±f *</label>
                  <select value={form.sinif} onChange={(e) => setForm({...form, sinif: e.target.value})}
                    className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium">
                    {['8A','8B','8C','8D','8E','8F'].map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Okul NumarasÄ± *</label>
                  <input value={form.okulNo} onChange={(e) => setForm({...form, okulNo: e.target.value})}
                    className="w-full px-4 py-2.5 rounded-lg border border-gray-200 text-sm font-medium"/>
                </div>
              </div>
              <div className="flex gap-3 justify-end pt-2">
                <button type="button" onClick={() => setEditModal(false)}
                  className="px-4 py-2 rounded-lg border border-gray-200 text-sm font-semibold">Ä°ptal</button>
                <button type="submit" disabled={saving}
                  className="px-5 py-2 rounded-lg text-white text-sm font-semibold transition-all hover:shadow-lg"
                  style={{ background: config.primary_action_color }}>
                  {saving ? 'Kaydediliyor...' : 'Kaydet'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {confirmDel && (
        <ConfirmModal message="Bu Ã¶ÄŸrenciyi silmek istediÄŸinize emin misiniz?" onConfirm={handleDelete} onCancel={() => setConfirmDel(false)}/>
      )}
    </div>
  );
}

function StudyPage({ config }) {
  const { students } = useAppData();
  const [selectedStudentId, setSelectedStudentId] = useState('');
  const [toast, setToast] = useState(null);
  const [loading, setLoading] = useState(false);
  const [quickDate, setQuickDate] = useState(new Date().toISOString().split('T')[0]);
  const [quickInputs, setQuickInputs] = useState({
    tur_d: '', tur_y: '', tur_b: '',
    mat_d: '', mat_y: '', mat_b: '',
    fen_d: '', fen_y: '', fen_b: '',
    ink_d: '', ink_y: '', ink_b: '',
    din_d: '', din_y: '', din_b: '',
    ing_d: '', ing_y: '', ing_b: '',
    paragraf_d: '', paragraf_y: '', paragraf_b: '',
  });
  const quickFirstRef = React.useRef(null);

  const quickSubjects = [
    { key: 'tur', label: 'TÃœR', accent: '#EF4444', soft: '#FEE2E2' },
    { key: 'mat', label: 'MAT', accent: '#3B82F6', soft: '#DBEAFE' },
    { key: 'fen', label: 'FEN', accent: '#10B981', soft: '#DCFCE7' },
    { key: 'ink', label: 'Ä°NK', accent: '#F59E0B', soft: '#FEF3C7' },
    { key: 'din', label: 'DÄ°N', accent: '#EC4899', soft: '#FCE7F3' },
    { key: 'ing', label: 'Ä°NG', accent: '#8B5CF6', soft: '#F3E8FF' },
  ];

  const quickSubjectsRow1 = quickSubjects.slice(0, 3);
  const quickSubjectsRow2 = quickSubjects.slice(3, 6);

  const toNum = (v) => {
    if (v === '' || v == null) return 0;
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : 0;
  };

  const normalizeIntInput = (value) => {
    const digits = String(value).replace(/[^\d]/g, '');
    if (digits === '') return '';
    return digits.replace(/^0+(?=\d)/, '');
  };

  const calculateNet = (dogru, yanlis) => {
    return (toNum(dogru) - (toNum(yanlis) / 3)).toFixed(2);
  };

  const subjectMaxLimits = {
    turkce: 20,
    matematik: 20,
    fen: 20,
    ingilizce: 10,
    inkilap: 10,
    din: 10,
  };

  const handleOpenEditExam = (exam) => {
    let subj = {};
    try {
      subj = typeof exam.exam_subjects === 'string' ? JSON.parse(exam.exam_subjects) : exam.exam_subjects || {};
    } catch {}
    // 6 konuya default boÅŸ obje ekle
    const fullSubjects = {
      turkce: { dogru: '', yanlis: '' },
      inkilap: { dogru: '', yanlis: '' },
      din: { dogru: '', yanlis: '' },
      ingilizce: { dogru: '', yanlis: '' },
      matematik: { dogru: '', yanlis: '' },
      fen: { dogru: '', yanlis: '' },
      ...subj
    };
    setEditingExam(exam);
    setEditExamSubjects(fullSubjects);
    setEditExamErrors({});
  };

  const handleEditExamSubjectChange = (key, field, value) => {
    const num = normalizeIntInput(value).slice(0, 3);
    const updatedSubj = { ...editExamSubjects[key], [field]: num };
    const total = toNum(updatedSubj.dogru) + toNum(updatedSubj.yanlis);
    const maxLimit = subjectMaxLimits[key];
    
    setEditExamSubjects(prev => ({
      ...prev,
      [key]: updatedSubj
    }));
    
    if (total > maxLimit) {
      setEditExamErrors(prev => ({
        ...prev,
        [key]: `Maksimum ${maxLimit} soru girilebilir`
      }));
    } else {
      setEditExamErrors(prev => {
        const newErrors = { ...prev };
        delete newErrors[key];
        return newErrors;
      });
    }
  };

  const calculateEditExamNet = () => {
    return Object.values(editExamSubjects)
      .reduce((sum, s) => sum + parseFloat(calculateNet(s.dogru, s.yanlis)), 0)
      .toFixed(2);
  };

  const handleSaveEditExam = async () => {
    if (Object.keys(editExamErrors).length > 0) {
      return;
    }
    setSaving(true);
    const result = await window.dataSdk.update({
      type: 'exam',
      __backendId: editingExam.__backendId,
      exam_name: editingExam.exam_name,
      exam_date: editingExam.exam_date,
      exam_subjects: JSON.stringify(editExamSubjects),
      exam_total_net: calculateEditExamNet(),
      deneme_tipi: editingExam.deneme_tipi,
      student_backend_id: editingExam.student_backend_id
    });
    setSaving(false);
    if (result.isOk) {
      setEditingExam(null);
      setEditExamSubjects({});
      setEditExamErrors({});
      // Refresh data and show success message
      setTimeout(() => {
        if (window.dataSdk && window.dataSdk.initialize) {
          window.dataSdk.initialize().catch(e => console.error('Data refresh failed:', e));
        }
      }, 300);
    }
  };

  const handleDeleteExam = async (exam) => {
    setSaving(true);
    const result = await window.dataSdk.delete({
      type: 'exam',
      __backendId: exam.__backendId
    });
    setSaving(false);
    if (result.isOk) {
      // BaÅŸarÄ±lÄ± silindi
    }
  };

  const handleQuickChange = (key, value) => {
    const cleaned = normalizeIntInput(value).slice(0, 3);
    setQuickInputs(prev => ({ ...prev, [key]: cleaned }));
  };

  const focusQuickFirst = () => {
    if (quickFirstRef.current) quickFirstRef.current.focus();
  };

  const handleQuickSubmit = async (e) => {
    e.preventDefault();
    if (!selectedStudentId) {
      setToast({ msg: 'LÃ¼tfen Ã¶ÄŸrenci seÃ§in', type: 'error' });
      return;
    }
    if (!quickDate) {
      setToast({ msg: 'Tarih seÃ§meden kaydetme yapÄ±lamaz', type: 'error' });
      return;
    }

    const payload = Object.fromEntries(
      Object.entries(quickInputs).map(([k, v]) => [k, Number(toNum(v))])
    );

    setLoading(true);
    const result = await window.dataSdk.create({
      type: 'quick_study',
      student_id: selectedStudentId,
      study_date: quickDate,
      ...payload,
      created_at: new Date().toISOString()
    });
    setLoading(false);

    if (result.isOk) {
      setToast({ msg: 'HÄ±zlÄ± giriÅŸ kaydedildi! âœ…', type: 'success' });
      setQuickInputs({
        tur_d: '', tur_y: '', tur_b: '',
        mat_d: '', mat_y: '', mat_b: '',
        fen_d: '', fen_y: '', fen_b: '',
        ink_d: '', ink_y: '', ink_b: '',
        din_d: '', din_y: '', din_b: '',
        ing_d: '', ing_y: '', ing_b: '',
        paragraf_d: '', paragraf_y: '', paragraf_b: '',
      });
      focusQuickFirst();
    } else {
      setToast({ msg: 'Hata oluÅŸtu', type: 'error' });
    }
  };

  const quickNet = (key) => {
    const d = quickInputs[`${key}_d`];
    const y = quickInputs[`${key}_y`];
    return calculateNet(d, y);
  };

  return (
    <div className="max-w-6xl mx-auto px-4 py-8 fade-in">
      {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}

      <div className="mb-10">
        <div className="rounded-2xl p-8 border border-gray-200 bg-white">
          <div className="flex items-center justify-center flex-wrap gap-6 mb-6">
            <h2 className="text-2xl font-bold" style={{ color: config.text_color }}>HÄ±zlÄ± GiriÅŸ</h2>
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2">
                <label className="text-sm font-semibold" style={{ color: config.text_color }}>Tarih *</label>
                <input
                  type="date"
                  value={quickDate}
                  onChange={(e) => setQuickDate(e.target.value)}
                  className="px-3 py-2 rounded-lg border border-gray-200 text-sm font-medium"
                  style={{ background: config.surface_color, color: config.text_color }}
                  required
                />
              </div>
              <div className="flex items-center gap-2">
                <label className="text-sm font-semibold" style={{ color: config.text_color }}>Ã–ÄŸrenci *</label>
                <select
                  value={selectedStudentId}
                  onChange={(e) => setSelectedStudentId(e.target.value)}
                  className="px-3 py-2 rounded-lg border border-gray-200 text-sm font-medium"
                  style={{ background: config.surface_color, color: config.text_color }}
                >
                  <option value="">-- Ã–ÄŸrenci SeÃ§in --</option>
                  {students.map(s => (
                    <option key={s.__backendId} value={s.__backendId}>
                      {s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim()}
                    </option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          <form onSubmit={handleQuickSubmit}>
            <div className="space-y-6">
              {/* Row 1: TUR, MAT, FEN */}
              <div className="overflow-x-auto">
                <div className="min-w-fit">
                  <div className="grid grid-cols-3 gap-4 items-center text-xs font-semibold uppercase" style={{ color: config.secondary_action_color }}>
                    {quickSubjectsRow1.map(s => (
                      <div key={s.key} className="text-center">{s.label}</div>
                    ))}
                  </div>
                  <div className="grid grid-cols-3 gap-4 mt-3">
                    {quickSubjectsRow1.map((s, idx) => (
                      <div key={s.key} className="flex flex-col gap-2">
                        <div className="grid grid-cols-3 gap-2 text-[10px] font-semibold text-center" style={{ color: config.secondary_action_color }}>
                          <div>D</div>
                          <div>Y</div>
                          <div>B</div>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                          <input
                            ref={idx === 0 ? quickFirstRef : null}
                            autoFocus={idx === 0}
                            type="text"
                            inputMode="numeric"
                            maxLength={3}
                            value={quickInputs[`${s.key}_d`]}
                            onChange={(e) => handleQuickChange(`${s.key}_d`, e.target.value)}
                            className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                            style={{ background: s.soft, borderColor: s.soft }}
                          />
                          <input
                            type="text"
                            inputMode="numeric"
                            maxLength={3}
                            value={quickInputs[`${s.key}_y`]}
                            onChange={(e) => handleQuickChange(`${s.key}_y`, e.target.value)}
                            className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                            style={{ background: s.soft, borderColor: s.soft }}
                          />
                          <input
                            type="text"
                            inputMode="numeric"
                            maxLength={3}
                            value={quickInputs[`${s.key}_b`]}
                            onChange={(e) => handleQuickChange(`${s.key}_b`, e.target.value)}
                            className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                            style={{ background: s.soft, borderColor: s.soft }}
                          />
                        </div>
                        <div className="rounded-lg py-2 text-center text-sm font-bold" style={{ background: s.soft, color: s.accent }}>
                          Net: {quickNet(s.key)}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Row 2: INK, DIN, ING */}
              <div className="overflow-x-auto">
                <div className="min-w-fit">
                  <div className="grid grid-cols-3 gap-4 items-center text-xs font-semibold uppercase" style={{ color: config.secondary_action_color }}>
                    {quickSubjectsRow2.map(s => (
                      <div key={s.key} className="text-center">{s.label}</div>
                    ))}
                  </div>
                  <div className="grid grid-cols-3 gap-4 mt-3">
                    {quickSubjectsRow2.map((s, idx) => (
                      <div key={s.key} className="flex flex-col gap-2">
                        <div className="grid grid-cols-3 gap-2 text-[10px] font-semibold text-center" style={{ color: config.secondary_action_color }}>
                          <div>D</div>
                          <div>Y</div>
                          <div>B</div>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                          <input
                            type="text"
                            inputMode="numeric"
                            maxLength={3}
                            value={quickInputs[`${s.key}_d`]}
                            onChange={(e) => handleQuickChange(`${s.key}_d`, e.target.value)}
                            className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                            style={{ background: s.soft, borderColor: s.soft }}
                          />
                          <input
                            type="text"
                            inputMode="numeric"
                            maxLength={3}
                            value={quickInputs[`${s.key}_y`]}
                            onChange={(e) => handleQuickChange(`${s.key}_y`, e.target.value)}
                            className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                            style={{ background: s.soft, borderColor: s.soft }}
                          />
                          <input
                            type="text"
                            inputMode="numeric"
                            maxLength={3}
                            value={quickInputs[`${s.key}_b`]}
                            onChange={(e) => handleQuickChange(`${s.key}_b`, e.target.value)}
                            className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                            style={{ background: s.soft, borderColor: s.soft }}
                          />
                        </div>
                        <div className="rounded-lg py-2 text-center text-sm font-bold" style={{ background: s.soft, color: s.accent }}>
                          Net: {quickNet(s.key)}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Row 3: Paragraph */}
              <div className="border-t pt-6">
                <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Paragraf</label>
                <div className="grid grid-cols-3 gap-2 text-[10px] font-semibold text-center mb-2" style={{ color: config.secondary_action_color }}>
                  <div>D</div>
                  <div>Y</div>
                  <div>B</div>
                </div>
                <div className="grid grid-cols-3 gap-2">
                  <input
                    type="text"
                    inputMode="numeric"
                    maxLength={3}
                    value={quickInputs['paragraf_d'] || ''}
                    onChange={(e) => handleQuickChange('paragraf_d', e.target.value)}
                    className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                    style={{ background: '#F3E8FF', borderColor: '#E9D5FF' }}
                  />
                  <input
                    type="text"
                    inputMode="numeric"
                    maxLength={3}
                    value={quickInputs['paragraf_y'] || ''}
                    onChange={(e) => handleQuickChange('paragraf_y', e.target.value)}
                    className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                    style={{ background: '#F3E8FF', borderColor: '#E9D5FF' }}
                  />
                  <input
                    type="text"
                    inputMode="numeric"
                    maxLength={3}
                    value={quickInputs['paragraf_b'] || ''}
                    onChange={(e) => handleQuickChange('paragraf_b', e.target.value)}
                    className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                    style={{ background: '#F3E8FF', borderColor: '#E9D5FF' }}
                  />
                </div>
                <div className="rounded-lg py-2 text-center text-sm font-bold mt-2" style={{ background: '#F3E8FF', color: '#7C3AED' }}>
                  Net: {quickNet('paragraf')}
                </div>
              </div>
            </div>

            <div className="flex justify-end mt-5">
              <button type="submit" className="px-6 py-2.5 rounded-lg text-white text-sm font-semibold transition-all hover:shadow-lg flex items-center gap-2" style={{ background: config.primary_action_color }}>
                {loading ? <Spinner size="sm" /> : <Icons.Check size={18} />}
                {loading ? 'Kaydediliyor...' : 'Kaydet'}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
}

function ExamPage({ config }) {
  const { students, exams, definedExams } = useAppData();
  const [selectedStudentId, setSelectedStudentId] = useState('');
  const [selectedDefinedExamId, setSelectedDefinedExamId] = useState('');
  const [examType, setExamType] = useState('ortak');
  const [examName, setExamName] = useState('');
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [subjects, setSubjects] = useState({
    turkce: { dogru: '', yanlis: '' },
    inkilap: { dogru: '', yanlis: '' },
    din: { dogru: '', yanlis: '' },
    ingilizce: { dogru: '', yanlis: '' },
    matematik: { dogru: '', yanlis: '' },
    fen: { dogru: '', yanlis: '' },
  });
  const [subjectErrors, setSubjectErrors] = useState({});
  const [isSaving, setIsSaving] = useState(false);
  const [newDefineExamName, setNewDefineExamName] = useState('');
  const [newDefineExamDate, setNewDefineExamDate] = useState(new Date().toISOString().split('T')[0]);
  const [toast, setToast] = useState(null);
  const [detailModal, setDetailModal] = useState(null);
  const [editingDefinedExam, setEditingDefinedExam] = useState(null);
  const [editName, setEditName] = useState('');
  const [editDate, setEditDate] = useState('');

  const subjectColors = {
    turkce: { bg: '#FEE2E2', text: '#DC2626', name: 'TÃ¼rkÃ§e', emoji: 'ðŸ“˜' },
    matematik: { bg: '#DBEAFE', text: '#0284C7', name: 'Matematik', emoji: 'ðŸ”¢' },
    fen: { bg: '#DCFCE7', text: '#16A34A', name: 'Fen', emoji: 'ðŸ§ª' },
    inkilap: { bg: '#FEF3C7', text: '#D97706', name: 'Ä°nkÄ±lap', emoji: 'ðŸ“œ' },
    ingilizce: { bg: '#F3E8FF', text: '#7C3AED', name: 'Ä°ngilizce', emoji: 'ðŸŒ' },
    din: { bg: '#FCE7F3', text: '#BE185D', name: 'Din', emoji: 'â˜ªï¸' },
  };
  const quickSubjects = [
    { key: 'turkce', label: 'TÃœR', accent: '#EF4444', soft: '#FEE2E2' },
    { key: 'inkilap', label: 'Ä°NK', accent: '#F59E0B', soft: '#FEF3C7' },
    { key: 'din', label: 'DÄ°N', accent: '#EC4899', soft: '#FCE7F3' },
    { key: 'ingilizce', label: 'Ä°NG', accent: '#8B5CF6', soft: '#F3E8FF' },
    { key: 'matematik', label: 'MAT', accent: '#3B82F6', soft: '#DBEAFE' },
    { key: 'fen', label: 'FEN', accent: '#10B981', soft: '#DCFCE7' },
  ];

  const toNum = (v) => {
    if (v === '' || v == null) return 0;
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : 0;
  };

  const normalizeIntInput = (value) => {
    const digits = String(value).replace(/[^\d]/g, '');
    if (digits === '') return '';
    return digits.replace(/^0+(?=\d)/, '');
  };

  const calculateNet = (dogru, yanlis) => {
    return (toNum(dogru) - (toNum(yanlis) / 3)).toFixed(2);
  };

  const getTotalNet = () => {
    return Object.values(subjects)
      .reduce((sum, s) => sum + parseFloat(calculateNet(s.dogru, s.yanlis)), 0)
      .toFixed(2);
  };

  const handleDefineExam = async (e) => {
    e.preventDefault();
    if (!newDefineExamName.trim()) {
      setToast({ msg: 'Deneme adÄ± boÅŸ olamaz', type: 'error' });
      return;
    }
    if (!newDefineExamDate) {
      setToast({ msg: 'Tarih seÃ§in', type: 'error' });
      return;
    }
    setIsSaving(true);
    const result = await window.dataSdk.create({
      type: 'defined_exam',
      name: newDefineExamName,
      exam_date: newDefineExamDate,
      created_at: new Date().toISOString()
    });
    setIsSaving(false);
    if (result.isOk) {
      setToast({ msg: 'Deneme tanÄ±mlandÄ±! ðŸŽ‰', type: 'success' });
      setNewDefineExamName('');
      setNewDefineExamDate(new Date().toISOString().split('T')[0]);
    } else {
      setToast({ msg: 'Hata oluÅŸtu', type: 'error' });
    }
  };

  const handleDeleteDefinedExam = async (id) => {
    setIsSaving(true);
    const result = await window.dataSdk.delete({ type: 'defined_exam', __backendId: id });
    setIsSaving(false);
    if (result.isOk) setToast({ msg: 'Deneme silindi', type: 'success' });
    else setToast({ msg: 'Silme hatasÄ±', type: 'error' });
  };

  const handleOpenEditModal = (exam) => {
    setEditingDefinedExam(exam);
    setEditName(exam.name);
    setEditDate(exam.exam_date);
  };

  const handleEditDefinedExam = async () => {
    if (!editName.trim()) {
      setToast({ msg: 'Deneme adÄ± boÅŸ olamaz', type: 'error' });
      return;
    }
    if (!editDate) {
      setToast({ msg: 'Tarih seÃ§in', type: 'error' });
      return;
    }
    setIsSaving(true);
    const result = await window.dataSdk.update({
      type: 'defined_exam',
      __backendId: editingDefinedExam.__backendId,
      name: editName,
      exam_date: editDate
    });
    setIsSaving(false);
    if (result.isOk) {
      setToast({ msg: 'Deneme gÃ¼ncellendi! ðŸŽ‰', type: 'success' });
      setEditingDefinedExam(null);
      setEditName('');
      setEditDate('');
    } else {
      setToast({ msg: 'GÃ¼ncelleme hatasÄ±', type: 'error' });
    }
  };

  const handleSelectDefinedExam = (examId) => {
    if (examId === 'new') {
      setSelectedDefinedExamId('');
      setExamName('');
      setSelectedDate(new Date().toISOString().split('T')[0]);
    } else {
      const exam = definedExams.find(e => e.__backendId === examId);
      if (exam) {
        setSelectedDefinedExamId(examId);
        setExamName(exam.name);
        setSelectedDate(exam.exam_date);
      }
    }
  };

  const subjectMaxLimits = {
    turkce: 20,
    matematik: 20,
    fen: 20,
    ingilizce: 10,
    inkilap: 10,
    din: 10,
  };

  const handleSubjectChange = (key, field, value) => {
    const num = normalizeIntInput(value).slice(0, 3);
    const updatedSubj = { ...subjects[key], [field]: num };
    const total = toNum(updatedSubj.dogru) + toNum(updatedSubj.yanlis);
    const maxLimit = subjectMaxLimits[key];
    
    setSubjects(prev => ({
      ...prev,
      [key]: updatedSubj
    }));
    
    if (total > maxLimit) {
      setSubjectErrors(prev => ({
        ...prev,
        [key]: `Maksimum ${maxLimit} soru girilebilir`
      }));
    } else {
      setSubjectErrors(prev => {
        const newErrors = { ...prev };
        delete newErrors[key];
        return newErrors;
      });
    }
  };

  const handleSave = async (e) => {
    e.preventDefault();
    if (!selectedStudentId) {
      setToast({ msg: 'LÃ¼tfen Ã¶ÄŸrenci seÃ§in', type: 'error' });
      return;
    }
    if (examType === 'ortak' && !selectedDefinedExamId) {
      setToast({ msg: 'LÃ¼tfen ortak deneme seÃ§in', type: 'error' });
      return;
    }
    if (examType === 'bireysel' && !examName.trim()) {
      setToast({ msg: 'LÃ¼tfen deneme adÄ± girin', type: 'error' });
      return;
    }

    setIsSaving(true);
    const serializeSubjects = (obj) => {
      return Object.fromEntries(
        Object.entries(obj).map(([k, v]) => [
          k,
          { dogru: toNum(v.dogru), yanlis: toNum(v.yanlis) }
        ])
      );
    };

    const result = await window.dataSdk.create({
      type: 'exam',
      student_id: selectedStudentId,
      exam_name: examType === 'bireysel' ? examName : (definedExams.find(e => e.__backendId === selectedDefinedExamId)?.name || examName),
      exam_date: selectedDate,
      exam_subjects: JSON.stringify(serializeSubjects(subjects)),
      exam_total_net: getTotalNet(),
      defined_exam_id: examType === 'ortak' ? (selectedDefinedExamId || null) : null,
      deneme_tipi: examType,
      created_at: new Date().toISOString()
    });
    setIsSaving(false);

    if (result.isOk) {
      setToast({ msg: 'Deneme kaydedildi! ðŸŽ‰', type: 'success' });
      handleReset();
    } else {
      setToast({ msg: 'Hata oluÅŸtu', type: 'error' });
    }
  };

  const handleReset = () => {
    setExamName('');
    setSelectedDefinedExamId('');
    setSelectedDate(new Date().toISOString().split('T')[0]);
    setSubjects({
      turkce: { dogru: '', yanlis: '' },
      inkilap: { dogru: '', yanlis: '' },
      din: { dogru: '', yanlis: '' },
      ingilizce: { dogru: '', yanlis: '' },
      matematik: { dogru: '', yanlis: '' },
      fen: { dogru: '', yanlis: '' },
    });
    setSubjectErrors({});
  };

  const handleDelete = async (id) => {
    setIsSaving(true);
    const result = await window.dataSdk.delete({ type: 'exam', __backendId: id });
    setIsSaving(false);
    if (result.isOk) setToast({ msg: 'Deneme silindi', type: 'success' });
    else setToast({ msg: 'Silme hatasÄ±', type: 'error' });
  };

  const studentExams = exams.filter(e => e.student_id === selectedStudentId);
  const openExamDetail = (exam) => {
    let subjects = {};
    if (exam.exam_subjects) {
      if (typeof exam.exam_subjects === 'string') {
        try {
          subjects = JSON.parse(exam.exam_subjects);
        } catch (e) {
          subjects = {};
        }
      } else {
        subjects = exam.exam_subjects;
      }
    }
    const computed = Object.entries(subjects).reduce((acc, [key, data]) => {
      acc[key] = {
        dogru: data.dogru || 0,
        yanlis: data.yanlis || 0,
        bos: data.bos || 0,
        net: calculateNet(data.dogru || 0, data.yanlis || 0),
      };
      return acc;
    }, {});
    setDetailModal({
      examName: exam.exam_name,
      date: exam.exam_date || exam.created_at,
      subjects: computed,
      totalNet: exam.exam_total_net,
    });
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 fade-in">
      {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}
      {detailModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 fade-in max-h-96 overflow-y-auto" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold" style={{color: config.text_color}}>{detailModal.examName}</h2>
              <button onClick={() => setDetailModal(null)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={20} className="text-gray-500"/></button>
            </div>
            <p className="text-sm mb-6" style={{color: config.secondary_action_color}}>ðŸ“… {new Date(detailModal.date).toLocaleDateString('tr-TR')}</p>
            
            <div className="space-y-3 mb-6">
              {Object.entries(detailModal.subjects).map(([key, data]) => {
                const color = subjectColors[key];
                return (
                  <div key={key} className="rounded-lg p-4" style={{background: color.bg}}>
                    <p className="font-semibold mb-2" style={{color: color.text}}>{color.emoji} {color.name}</p>
                    <div className="text-xs space-y-1" style={{color: color.text}}>
                      <p>âœ“ DoÄŸru: {data.dogru}</p>
                      <p>âœ— YanlÄ±ÅŸ: {data.yanlis}</p>
                      <p>âŠ˜ BoÅŸ: {data.bos}</p>
                      <p className="font-bold text-sm">NET: {data.net}</p>
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="rounded-lg p-4 bg-emerald-50 border-2 border-emerald-200 text-center mb-6">
              <p className="text-xs font-semibold mb-1" style={{color: '#059669'}}>TOPLAM NET</p>
              <p className="text-2xl font-extrabold text-emerald-600">{detailModal.totalNet}</p>
            </div>

            <button onClick={() => setDetailModal(null)} className="w-full px-4 py-2.5 rounded-xl border border-gray-300 text-sm font-semibold hover:bg-gray-50 transition-colors" style={{color: config.secondary_action_color}}>Kapat</button>
          </div>
        </div>
      )}

      <h1 className="text-3xl font-extrabold mb-8" style={{ color: config.text_color }}>Deneme SÄ±navÄ± GiriÅŸi</h1>
      
      {/* 2 SÃ¼tun Layout */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
        {/* SOL TARAF: Deneme TanÄ±mlama */}
        <div className="lg:col-span-1">
          <div className="rounded-2xl p-6 border-2 border-blue-200" style={{ background: '#F0F9FF' }}>
            <h2 className="text-lg font-bold mb-4 text-blue-900">ðŸ“‹ Yeni Deneme TanÄ±mla</h2>
            
            <form onSubmit={handleDefineExam} className="space-y-3 mb-6">
              <div>
                <label className="block text-xs font-semibold mb-1.5 text-blue-900">Deneme AdÄ±</label>
                <input
                  type="text"
                  value={newDefineExamName}
                  onChange={(e) => setNewDefineExamName(e.target.value)}
                  placeholder="1. Okul Denemesi"
                  className="w-full px-3 py-2 rounded-lg border border-blue-300 text-sm font-medium bg-white"
                  style={{ color: config.text_color }}
                />
              </div>
              <div>
                <label className="block text-xs font-semibold mb-1.5 text-blue-900">Tarih</label>
                <input
                  type="date"
                  value={newDefineExamDate}
                  onChange={(e) => setNewDefineExamDate(e.target.value)}
                  className="w-full px-3 py-2 rounded-lg border border-blue-300 text-sm font-medium bg-white"
                  style={{ color: config.text_color }}
                />
              </div>
              <button
                type="submit"
                disabled={isSaving}
                className="w-full px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 transition disabled:opacity-60"
              >
                {isSaving ? 'Kaydediliyor...' : 'âœ“ TanÄ±mla'}
              </button>
            </form>

            <div className="border-t border-blue-200 pt-4">
              <h3 className="text-sm font-bold mb-3 text-blue-900">TanÄ±mlanan Denemeler</h3>
              {definedExams.length === 0 ? (
                <p className="text-xs text-blue-700 text-center py-4">Ä°lk denemeyi tanÄ±mlayÄ±n</p>
              ) : (
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {definedExams.map(exam => (
                    <div key={exam.__backendId} className="flex items-center justify-between p-2 rounded-lg bg-white border border-blue-100">
                      <div className="flex-1">
                        <p className="text-xs font-bold text-blue-900">{exam.name}</p>
                        <p className="text-xs text-blue-600">{new Date(exam.exam_date).toLocaleDateString('tr-TR')}</p>
                      </div>
                      <div className="flex gap-1">
                        <button
                          onClick={() => handleOpenEditModal(exam)}
                          className="text-blue-500 hover:text-blue-700 p-1"
                          disabled={isSaving}
                          title="DÃ¼zenle"
                        >
                          âœï¸
                        </button>
                        <button
                          onClick={() => handleDeleteDefinedExam(exam.__backendId)}
                          className="text-red-500 hover:text-red-700 p-1"
                          disabled={isSaving}
                          title="Sil"
                        >
                          ðŸ—‘ï¸
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* SAÄž TARAF: Deneme GiriÅŸi Formu */}
        <div className="lg:col-span-2">
          <form onSubmit={handleSave}>
            <div className="rounded-2xl p-6 border border-gray-200 mb-6" style={{ background: config.surface_color }}>
              <h2 className="text-lg font-bold mb-4" style={{ color: config.text_color }}>ðŸ“ Deneme GiriÅŸi</h2>
              
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Ã–ÄŸrenci SeÃ§in *</label>
                  <select
                    value={selectedStudentId}
                    onChange={(e) => setSelectedStudentId(e.target.value)}
                    className="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-medium"
                    style={{ background: config.surface_color, color: config.text_color }}
                  >
                    <option value="">-- Ã–ÄŸrenci SeÃ§in --</option>
                    {students.map(s => (
                      <option key={s.__backendId} value={s.__backendId}>
                        {s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim()}
                      </option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Tarih *</label>
                  <input
                    type="date"
                    value={selectedDate}
                    onChange={(e) => setSelectedDate(e.target.value)}
                    className="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-medium"
                    style={{ background: config.surface_color, color: config.text_color }}
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div>
                  <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Deneme Tipi *</label>
                  <div className="flex items-center gap-4">
                    <label className="flex items-center gap-2 text-sm font-medium" style={{ color: config.text_color }}>
                      <input type="radio" name="examType" value="ortak" checked={examType === 'ortak'} onChange={() => setExamType('ortak')} />
                      Ortak Deneme
                    </label>
                    <label className="flex items-center gap-2 text-sm font-medium" style={{ color: config.text_color }}>
                      <input type="radio" name="examType" value="bireysel" checked={examType === 'bireysel'} onChange={() => { setExamType('bireysel'); setSelectedDefinedExamId(''); }} />
                      Bireysel Deneme
                    </label>
                  </div>
                </div>
              </div>

              {examType === 'ortak' ? (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Ortak Deneme SeÃ§in *</label>
                    <select
                      value={selectedDefinedExamId}
                      onChange={(e) => handleSelectDefinedExam(e.target.value)}
                      className="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-medium"
                      style={{ background: config.surface_color, color: config.text_color }}
                    >
                      <option value="">-- Deneme SeÃ§in --</option>
                      {definedExams.map(exam => (
                        <option key={exam.__backendId} value={exam.__backendId}>
                          {exam.name}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div className="flex items-center text-sm" style={{ color: config.secondary_action_color }}>
                    {selectedDefinedExamId ? (
                      <>SeÃ§ilen: <span className="ml-1 font-semibold" style={{ color: config.text_color }}>
                        {definedExams.find(e => e.__backendId === selectedDefinedExamId)?.name}
                      </span> Â· {new Date(selectedDate).toLocaleDateString('tr-TR')}</>
                    ) : (
                      <>LÃ¼tfen bir ortak deneme seÃ§in</>
                    )}
                  </div>
                </div>
              ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold mb-2" style={{ color: config.text_color }}>Deneme AdÄ± *</label>
                    <input
                      type="text"
                      value={examName}
                      onChange={(e) => setExamName(e.target.value)}
                      className="w-full px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-medium"
                      placeholder="TYT YayÄ±nlarÄ± 8. Deneme"
                      style={{ background: config.surface_color, color: config.text_color }}
                    />
                  </div>
                </div>
              )}
            </div>

            {!selectedStudentId ? (
              <div className="text-center py-12 rounded-2xl border-2 border-dashed border-gray-300">
                <p className="text-lg font-medium" style={{ color: config.secondary_action_color }}>ðŸ“Œ LÃ¼tfen Ã¶ÄŸrenci seÃ§in</p>
              </div>
            ) : (
              <>
                <div className="mb-8 space-y-6">
                  {[quickSubjects.slice(0, 3), quickSubjects.slice(3, 6)].map((row, rowIdx) => (
                    <div key={rowIdx} className="grid grid-cols-3 gap-4">
                      {row.map((s, idx) => {
                        const focusFirst = rowIdx === 0 && idx === 0;
                        return (
                          <div key={s.key} className="rounded-2xl p-4 border border-gray-200" style={{ background: '#FFFFFF' }}>
                            <div className="flex items-center justify-between mb-3">
                              <span className="text-sm font-bold" style={{ color: s.accent }}>{s.label}</span>
                              <span className="text-[10px] font-semibold uppercase" style={{ color: config.secondary_action_color }}>D / Y</span>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                              <input
                                id={`exam-${s.key}-dogru`}
                                autoFocus={focusFirst}
                                type="text"
                                inputMode="numeric"
                                maxLength={3}
                                value={subjects[s.key].dogru}
                                onChange={(e) => handleSubjectChange(s.key, 'dogru', e.target.value)}
                                className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                                style={{ background: s.soft, borderColor: subjectErrors[s.key] ? '#EF4444' : s.soft }}
                              />
                              <input
                                id={`exam-${s.key}-yanlis`}
                                type="text"
                                inputMode="numeric"
                                maxLength={3}
                                value={subjects[s.key].yanlis}
                                onChange={(e) => handleSubjectChange(s.key, 'yanlis', e.target.value)}
                                className="px-3 py-2 rounded-lg border text-sm font-semibold text-center"
                                style={{ background: s.soft, borderColor: subjectErrors[s.key] ? '#EF4444' : s.soft }}
                              />
                            </div>
                            {subjectErrors[s.key] && (
                              <div className="text-xs font-semibold text-red-600 mt-2 text-center">
                                {subjectErrors[s.key]}
                              </div>
                            )}
                            <div className="rounded-lg py-2 text-center text-sm font-bold mt-3" style={{ background: s.soft, color: s.accent }}>
                              Net: {calculateNet(subjects[s.key].dogru, subjects[s.key].yanlis)}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ))}
                </div>

                <div className="rounded-xl p-4 mb-6 text-center" style={{ background: '#ECFDF5', border: '1px solid #BBF7D0' }}>
                  <span className="text-sm font-semibold" style={{ color: '#059669' }}>Toplam Net: </span>
                  <span className="text-lg font-bold" style={{ color: '#047857' }}>{getTotalNet()}</span>
                </div>

                <div className="flex gap-3 mb-12">
                  <button type="submit" disabled={isSaving || Object.keys(subjectErrors).length > 0} className="flex-1 px-6 py-3.5 rounded-xl text-white text-base font-semibold transition-all hover:shadow-lg flex items-center justify-center gap-2 disabled:opacity-60" style={{ background: config.primary_action_color }}>
                    {isSaving ? <Spinner size="sm" /> : <Icons.Check size={20} />}
                    {isSaving ? 'Kaydediliyor...' : 'Denemeyi Kaydet'}
                  </button>
                  <button type="button" onClick={handleReset} className="px-6 py-3.5 rounded-xl border border-gray-300 text-sm font-semibold transition-colors hover:bg-gray-50" style={{ color: config.secondary_action_color }}>Formu Temizle</button>
                </div>
              </>
            )}
          </form>
        </div>
      </div>

      {selectedStudentId && (
        <div>
          <h2 className="text-2xl font-bold mb-6" style={{ color: config.text_color }}>Daha Ã–nce Girilen Denemeler</h2>
          
          {studentExams.length === 0 ? (
            <div className="text-center py-12 rounded-2xl border-2 border-dashed border-gray-300">
              <p className="text-base font-medium" style={{ color: config.secondary_action_color }}>HenÃ¼z deneme girilmemiÅŸ ðŸ“</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
              {studentExams.map((exam) => {
                const definedExam = exam.defined_exam_id ? definedExams.find(d => Number(d.__backendId) === Number(exam.defined_exam_id)) : null;
                const displayDate = definedExam ? definedExam.exam_date : (exam.exam_date || exam.created_at);
                return (
                  <div key={exam.__backendId} className="rounded-2xl border border-gray-100 p-6 card-hover" style={{ background: config.surface_color }}>
                    <h3 className="text-xl font-bold mb-2" style={{ color: config.text_color }}>{exam.exam_name}</h3>
                    <p className="text-sm mb-4" style={{ color: config.secondary_action_color }}>ðŸ“… {new Date(displayDate).toLocaleDateString('tr-TR')}</p>
                    
                    <div className="rounded-lg p-4 bg-emerald-50 text-center mb-5">
                      <p className="text-xs font-semibold mb-1" style={{ color: '#059669' }}>TOPLAM NET</p>
                      <p className="text-2xl font-extrabold text-emerald-600">{exam.exam_total_net}</p>
                    </div>

                    <div className="flex gap-2">
                      <button onClick={() => openExamDetail(exam)} className="flex-1 px-3 py-2.5 rounded-lg text-white text-sm font-semibold transition-all" style={{background: config.primary_action_color}}>Detaylar</button>
                      <button onClick={() => handleDelete(exam.__backendId)} className="px-3 py-2.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 font-semibold text-sm transition-colors">ðŸ—‘ï¸</button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {/* Edit Modal */}
      {editingDefinedExam && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-lg max-w-sm w-full p-6">
            <h2 className="text-lg font-bold text-gray-900 mb-4">Deneme DÃ¼zenle</h2>
            <div className="space-y-4 mb-6">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1.5">Deneme AdÄ±</label>
                <input
                  type="text"
                  value={editName}
                  onChange={(e) => setEditName(e.target.value)}
                  className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Deneme adÄ±"
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1.5">Tarih</label>
                <input
                  type="date"
                  value={editDate}
                  onChange={(e) => setEditDate(e.target.value)}
                  className="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>
            <div className="flex gap-3">
              <button
                onClick={handleEditDefinedExam}
                disabled={isSaving}
                className="flex-1 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 transition disabled:opacity-60"
              >
                {isSaving ? 'Kaydediliyor...' : 'Kaydet'}
              </button>
              <button
                onClick={() => setEditingDefinedExam(null)}
                disabled={isSaving}
                className="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 text-sm font-bold hover:bg-gray-50 transition disabled:opacity-60"
              >
                Ä°ptal
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Toast Notification */}
      {toast && (
        <div className={`fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white font-semibold text-sm z-40 ${toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'}`}>
          {toast.msg}
        </div>
      )}
    </div>
  );
}

function DashboardPage({ config, onSelectStudent, onNavigate }) {
  const { students, exams, quickStudies, definedExams } = useAppData();
  const [loading, setLoading] = useState(true);
  const [showRiskModal, setShowRiskModal] = useState(false);
  const [showDropModal, setShowDropModal] = useState(false);
  const chartRef = useRef(null);
  const chartInstanceRef = useRef(null);
  const radarRef = useRef(null);
  const radarInstanceRef = useRef(null);

  useEffect(() => {
    const t = setTimeout(() => setLoading(false), 400);
    return () => clearTimeout(t);
  }, [students.length, exams.length]);

  // Refresh data on mount to ensure latest exams are displayed
  useEffect(() => {
    if (window.dataSdk && window.dataSdk.initialize) {
      window.dataSdk.initialize().catch(e => console.error('Dashboard data refresh failed:', e));
    }
  }, []);

  const ortakExams = useMemo(() => (exams || []).filter(e => e.deneme_tipi === 'ortak'), [exams]);

  const groupedExams = useMemo(() => {
    const map = {};
    (ortakExams || []).forEach(e => {
      const definedExam = e.defined_exam_id ? (definedExams || []).find(d => Number(d.__backendId) === Number(e.defined_exam_id)) : null;
      const dateStr = definedExam ? definedExam.exam_date : (e.exam_date || e.created_at || '').toString().split('T')[0];
      const key = (e.defined_exam_id || '') + '::' + (e.exam_name || 'Deneme') + '::' + dateStr;
      if (!map[key]) {
        map[key] = { key, dateStr, name: e.exam_name || 'Ortak Deneme', records: [] };
      }
      map[key].records.push(e);
    });
    return Object.values(map).sort((a, b) => new Date(a.dateStr) - new Date(b.dateStr));
  }, [ortakExams, definedExams]);

  const lastGroup = groupedExams[groupedExams.length - 1] || null;
  const prevGroup = groupedExams.length > 1 ? groupedExams[groupedExams.length - 2] : null;

  const calcNet = (subject) => {
    if (!subject) return 0;
    const d = parseFloat(subject.dogru || 0);
    const y = parseFloat(subject.yanlis || 0);
    return parseFloat((d - (y / 3)).toFixed(2));
  };

  const classAvg = (group) => {
    if (!group || group.records.length === 0) return 0;
    const sum = group.records.reduce((s, r) => s + parseFloat(r.exam_total_net || 0), 0);
    return sum / group.records.length;
  };

  const lastAvg = lastGroup ? classAvg(lastGroup) : 0;
  const prevAvg = prevGroup ? classAvg(prevGroup) : 0;
  const avgTrend = lastGroup && prevGroup ? (lastAvg - prevAvg) : null;

  const studentMap = useMemo(() => {
    const map = {};
    (students || []).forEach(s => { map[s.__backendId] = s; });
    return map;
  }, [students]);

  const studentDiffs = useMemo(() => {
    if (!lastGroup || !prevGroup) return [];
    const prevByStudent = {};
    prevGroup.records.forEach(r => { prevByStudent[r.student_id] = r; });
    return lastGroup.records
      .filter(r => studentMap[r.student_id]) // Only include records where student exists
      .map(r => {
        const prev = prevByStudent[r.student_id];
        if (!prev) return null;
        const lastNet = parseFloat(r.exam_total_net || 0);
        const prevNet = parseFloat(prev.exam_total_net || 0);
        return {
          studentId: r.student_id,
          name: (studentMap[r.student_id]?.ad_soyad || '').trim() || (studentMap[r.student_id]?.student_name || 'Ã–ÄŸrenci'),
          lastNet,
          prevNet,
          diff: lastNet - prevNet
        };
      }).filter(Boolean);
  }, [lastGroup, prevGroup, studentMap]);

  const riskStudents = studentDiffs.filter(s => s.diff < 0);
  const bigDropStudents = studentDiffs.filter(s => s.diff <= -5);

  const bestImprover = studentDiffs.length > 0
    ? studentDiffs.reduce((a, b) => (b.diff > a.diff ? b : a))
    : null;

  const weakestSubject = useMemo(() => {
    if (!ortakExams || ortakExams.length === 0) return null;
    const subjects = ['turkce', 'matematik', 'fen', 'inkilap', 'ingilizce'];
    const totals = {};
    const counts = {};
    subjects.forEach(s => { totals[s] = 0; counts[s] = 0; });
    ortakExams.forEach(e => {
      // Filter: only include if student exists
      if (!studentMap[e.student_id]) return;
      let subj = {};
      try { subj = typeof e.exam_subjects === 'string' ? JSON.parse(e.exam_subjects) : e.exam_subjects || {}; } catch {}
      subjects.forEach(s => {
        if (subj[s]) {
          totals[s] += calcNet(subj[s]);
          counts[s] += 1;
        }
      });
    });
    let minSubj = null;
    let minAvg = Infinity;
    subjects.forEach(s => {
      if (counts[s] > 0) {
        const avg = totals[s] / counts[s];
        if (avg < minAvg) { minAvg = avg; minSubj = s; }
      }
    });
    if (!minSubj) return null;
    const labelMap = { turkce: 'TÃ¼rkÃ§e', matematik: 'Matematik', fen: 'Fen', inkilap: 'Sosyal', ingilizce: 'Ä°ngilizce' };
    return { name: labelMap[minSubj], avg: minAvg };
  }, [ortakExams, studentMap]);

  const growthPercent = useMemo(() => {
    if (groupedExams.length < 6) return null;
    const first = groupedExams.slice(0, 3);
    const last = groupedExams.slice(-3);
    const getAvgByStudent = (groups) => {
      const map = {};
      const count = {};
      groups.forEach(g => {
        g.records.forEach(r => {
          // Filter: only include if student exists
          if (!studentMap[r.student_id]) return;
          const id = r.student_id;
          map[id] = (map[id] || 0) + parseFloat(r.exam_total_net || 0);
          count[id] = (count[id] || 0) + 1;
        });
      });
      const avg = {};
      Object.keys(map).forEach(id => { avg[id] = map[id] / count[id]; });
      return avg;
    };
    const firstAvg = getAvgByStudent(first);
    const lastAvg = getAvgByStudent(last);
    const pcts = [];
    Object.keys(lastAvg).forEach(id => {
      if (firstAvg[id] && firstAvg[id] > 0) {
        pcts.push(((lastAvg[id] - firstAvg[id]) / firstAvg[id]) * 100);
      }
    });
    if (pcts.length === 0) return null;
    return pcts.reduce((s, v) => s + v, 0) / pcts.length;
  }, [groupedExams]);

  const hasStudents = (students || []).length > 0;
  const hasOrtak = ortakExams.length > 0;

  const now = new Date();
  const dayMs = 24 * 60 * 60 * 1000;
  const toDateKey = (d) => {
    const dt = new Date(d);
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  };
  const diffDays = (a, b) => Math.floor((a.getTime() - b.getTime()) / dayMs);

  const weeklyNoStudy = useMemo(() => {
    const lastMap = {};
    (quickStudies || []).forEach(q => {
      if (!q.student_id) return;
      const d = q.study_date || q.created_at;
      if (!d) return;
      const dt = new Date(d);
      if (!lastMap[q.student_id] || dt > lastMap[q.student_id]) lastMap[q.student_id] = dt;
    });
    const list = (students || []).map(s => {
      const last = lastMap[s.__backendId] || null;
      const days = last ? diffDays(now, last) : 999;
      return {
        id: s.__backendId,
        name: (s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim() || 'Ã–ÄŸrenci'),
        days
      };
    }).filter(s => s.days >= 7);
    return list.sort((a, b) => b.days - a.days);
  }, [students, quickStudies]);

  const declineStudents = useMemo(() => {
    const map = {};
    (ortakExams || []).forEach(e => {
      if (!e.student_id) return;
      if (!map[e.student_id]) map[e.student_id] = [];
      const d = new Date(e.exam_date || e.created_at || '');
      map[e.student_id].push({ ...e, dateObj: d });
    });
    const list = [];
    Object.keys(map).forEach(id => {
      const exams = map[id].sort((a, b) => a.dateObj - b.dateObj);
      if (exams.length < 2) return;
      const last = exams[exams.length - 1];
      const prev = exams[exams.length - 2];
      const prev2 = exams.length >= 3 ? exams[exams.length - 3] : null;
      const drop = parseFloat(last.exam_total_net || 0) - parseFloat(prev.exam_total_net || 0);
      if (drop <= -5) {
        if (prev2) {
          const drop2 = parseFloat(prev.exam_total_net || 0) - parseFloat(prev2.exam_total_net || 0);
          if (drop2 > 0) return;
        }
        const student = students.find(s => s.__backendId === id);
        list.push({
          id,
          name: (student?.ad_soyad || `${student?.student_name || ''} ${student?.student_surname || ''}`.trim() || 'Ã–ÄŸrenci'),
          drop
        });
      }
    });
    return list.sort((a, b) => a.drop - b.drop);
  }, [ortakExams, students]);

  const studentNameById = useMemo(() => {
    const map = {};
    (students || []).forEach(s => {
      map[String(s.__backendId)] = (s.ad_soyad || `${s.student_name || ''} ${s.student_surname || ''}`.trim() || 'Ã–ÄŸrenci');
    });
    return map;
  }, [students]);

  const formatAgo = (date) => {
    const diffMs = now.getTime() - date.getTime();
    const diffMin = Math.floor(diffMs / (60 * 1000));
    const diffHr = Math.floor(diffMs / (60 * 60 * 1000));
    const diffDay = Math.floor(diffMs / dayMs);
    if (diffMin <= 1) return 'Az Ã¶nce';
    if (diffMin < 60) return `${diffMin} dk Ã¶nce`;
    if (diffHr < 24) return `${diffHr} saat Ã¶nce`;
    if (diffDay === 1) return 'DÃ¼n';
    return `${diffDay} gÃ¼n Ã¶nce`;
  };

  const recentActivities = useMemo(() => {
    const items = [];
    (exams || []).forEach(e => {
      const d = new Date(e.created_at || e.exam_date || '');
      const sid = String(e.student_id || e.student_backend_id || '');
      const name = studentNameById[sid] || 'Bilinmeyen Ã¶ÄŸrenci';
      items.push({
        type: 'exam',
        date: d,
        text: `${name} - Deneme giriÅŸi (${e.exam_name || 'Deneme'})`,
        ago: formatAgo(d)
      });
    });
    (quickStudies || []).forEach(q => {
      const d = new Date(q.created_at || q.study_date || '');
      const total = (q.tur_d||0)+(q.tur_y||0)+(q.tur_b||0)+
        (q.mat_d||0)+(q.mat_y||0)+(q.mat_b||0)+
        (q.fen_d||0)+(q.fen_y||0)+(q.fen_b||0)+
        (q.ink_d||0)+(q.ink_y||0)+(q.ink_b||0)+
        (q.ing_d||0)+(q.ing_y||0)+(q.ing_b||0)+
        (q.din_d||0)+(q.din_y||0)+(q.din_b||0);
      const name = studentNameById[String(q.student_id || '')] || 'Bilinmeyen Ã¶ÄŸrenci';
      items.push({
        type: 'study',
        date: d,
        text: `${name} - GÃ¼nlÃ¼k Ã§alÄ±ÅŸma (${total} soru)`,
        ago: formatAgo(d)
      });
    });
    return items.sort((a, b) => b.date - a.date).slice(0, 6);
  }, [exams, quickStudies, studentNameById]);

  const renderValue = (val, emptyText) => {
    if (!hasStudents) return 'HenÃ¼z Ã¶ÄŸrenci eklenmemiÅŸ';
    if (!hasOrtak) return 'HenÃ¼z ortak deneme girilmemiÅŸ';
    return val ?? emptyText;
  };

  const cards = [
    {
      title: 'Genel Ortalama Net',
      icon: 'ðŸ“Š',
      color: '#3498db',
      value: hasOrtak ? lastAvg.toFixed(1) : null,
      sub: lastGroup && prevGroup
        ? (avgTrend > 0 ? `â¬† +${avgTrend.toFixed(1)}` : avgTrend < 0 ? `â¬‡ ${avgTrend.toFixed(1)}` : 'â†’ 0.0')
        : 'Trend iÃ§in daha fazla deneme gerekli',
      subColor: avgTrend > 0 ? '#16a34a' : avgTrend < 0 ? '#ef4444' : '#64748b',
      clickable: false
    },
    {
      title: 'GeliÅŸim Trendi',
      icon: 'ðŸ“ˆ',
      color: growthPercent !== null && growthPercent < 0 ? '#e74c3c' : '#2ecc71',
      value: growthPercent !== null ? `%${Math.abs(growthPercent).toFixed(1)} ${growthPercent >= 0 ? 'artÄ±ÅŸ' : 'dÃ¼ÅŸÃ¼ÅŸ'}` : null,
      sub: '(son 3 deneme ortalamasÄ±)',
      subColor: '#94a3b8',
      clickable: false
    },
    {
      title: 'Risk Grubu',
      icon: 'âš ï¸',
      color: '#f39c12',
      value: hasOrtak ? `${riskStudents.length} Ã¶ÄŸrenci` : null,
      sub: 'son 2 denemede dÃ¼ÅŸÃ¼ÅŸ',
      subColor: '#d97706',
      clickable: true,
      onClick: () => setShowRiskModal(true)
    },
    {
      title: 'En ZayÄ±f Alan',
      icon: 'ðŸ§ ',
      color: '#9b59b6',
      value: weakestSubject ? weakestSubject.name : null,
      sub: weakestSubject ? `Ort: ${weakestSubject.avg.toFixed(1)} net` : 'Veri yok',
      subColor: '#7c3aed',
      clickable: false
    },
    {
      title: 'Bu AyÄ±n YÃ¼kseleni',
      icon: 'ðŸ”¥',
      color: '#27ae60',
      value: bestImprover ? bestImprover.name : null,
      sub: bestImprover ? `+${bestImprover.diff.toFixed(1)} net` : 'Veri yok',
      subColor: '#16a34a',
      clickable: true,
      onClick: () => bestImprover && onSelectStudent && onSelectStudent(bestImprover.studentId)
    },
    {
      title: 'BÃ¼yÃ¼k DÃ¼ÅŸÃ¼ÅŸ',
      icon: 'ðŸ“‰',
      color: '#e74c3c',
      value: hasOrtak ? `${bigDropStudents.length} Ã¶ÄŸrenci` : null,
      sub: 'son denemede -5 net ve Ã¼zeri',
      subColor: '#ef4444',
      clickable: true,
      onClick: () => setShowDropModal(true)
    }
  ];

  const lastExamMeta = useMemo(() => {
    if (!lastGroup) return null;
    const title = `${lastGroup.name} - ${new Date(lastGroup.dateStr).toLocaleDateString('tr-TR')}`;
    const total = students.length || 0;
    const count = lastGroup.records.length;
    return { title, count, total };
  }, [lastGroup, students.length]);

  const chartData = useMemo(() => {
    if (!lastGroup) return null;
    // Filter out records where student doesn't exist in studentMap (deleted students)
    const rows = lastGroup.records
      .filter(r => studentMap[r.student_id]) // Only include records where student exists
      .map(r => {
        let subj = {};
        try { subj = typeof r.exam_subjects === 'string' ? JSON.parse(r.exam_subjects) : r.exam_subjects || {}; } catch {}
        const net = parseFloat(r.exam_total_net || 0);
        const student = studentMap[r.student_id];
        const name = (student?.ad_soyad || '').trim() || (student?.student_name || '') + ' ' + (student?.student_surname || '');
        const trimmedName = name.trim() || 'Bilinmeyen Ã–ÄŸrenci';
        const parts = trimmedName.split(' ');
        const shortName = parts.length > 1 ? `${parts[0]} ${parts[1][0]}.` : parts[0];
        const details = {
          turkce: calcNet(subj.turkce),
          matematik: calcNet(subj.matematik),
          fen: calcNet(subj.fen),
          inkilap: calcNet(subj.inkilap),
          ingilizce: calcNet(subj.ingilizce),
        };
        return { studentId: r.student_id, name: trimmedName, shortName, net, details };
      }).sort((a, b) => b.net - a.net);

    const avg = classAvg(lastGroup);
    const maxNet = rows.length ? Math.max(...rows.map(r => r.net)) : 0;

    return { rows, avg, maxNet };
  }, [lastGroup, studentMap]);

  const chartMinWidth = chartData ? Math.max(chartData.rows.length * 40, 700) : 700;

  const radarData = useMemo(() => {
    if (!ortakExams || ortakExams.length === 0) return null;
    const subjects = [
      { key: 'turkce', label: 'TÃ¼rkÃ§e' },
      { key: 'matematik', label: 'Matematik' },
      { key: 'fen', label: 'Fen Bilimleri' },
      { key: 'ingilizce', label: 'Ä°ngilizce' },
      { key: 'inkilap', label: 'Ä°nkÄ±lap Tarihi' },
      { key: 'din', label: 'Din KÃ¼ltÃ¼rÃ¼' },
    ];
    const totals = {};
    const counts = {};
    subjects.forEach(s => { totals[s.key] = 0; counts[s.key] = 0; });
    ortakExams.forEach(e => {
      // Filter: only include if student exists
      if (!studentMap[e.student_id]) return;
      let subj = {};
      try { subj = typeof e.exam_subjects === 'string' ? JSON.parse(e.exam_subjects) : e.exam_subjects || {}; } catch {}
      subjects.forEach(s => {
        if (subj[s.key]) {
          totals[s.key] += calcNet(subj[s.key]);
          counts[s.key] += 1;
        }
      });
    });
    const values = subjects.map(s => counts[s.key] ? (totals[s.key] / counts[s.key]) : 0);
    const validIndexes = subjects.map((s, i) => (counts[s.key] ? i : -1)).filter(i => i >= 0);
    const hasAny = validIndexes.length > 0;
    const maxIdx = hasAny ? validIndexes.reduce((best, i) => (values[i] > values[best] ? i : best), validIndexes[0]) : null;
    const minIdx = hasAny ? validIndexes.reduce((best, i) => (values[i] < values[best] ? i : best), validIndexes[0]) : null;
    const maxVal = hasAny ? values[maxIdx] : 0;
    const minVal = hasAny ? values[minIdx] : 0;
    return { subjects, values, maxIdx, minIdx, maxVal, minVal, hasAny };
  }, [ortakExams, studentMap]);

  useEffect(() => {
    if (!chartRef.current) return;
    if (!chartData || !chartData.rows || chartData.rows.length === 0) {
      if (chartInstanceRef.current) {
        chartInstanceRef.current.destroy();
        chartInstanceRef.current = null;
      }
      return;
    }

    const ctx = chartRef.current.getContext('2d');
    if (chartInstanceRef.current) {
      chartInstanceRef.current.destroy();
      chartInstanceRef.current = null;
    }

    const labels = chartData.rows.map(r => r.shortName);
    const nets = chartData.rows.map(r => r.net);
    const avg = chartData.avg;
    const maxNet = chartData.maxNet;

    const colors = chartData.rows.map(r => {
      if (r.net >= avg + 5) return '#2ecc71';
      if (Math.abs(r.net - avg) <= 5) return '#f39c12';
      return '#e74c3c';
    });

    const highlightIndex = chartData.rows.findIndex(r => r.net === maxNet);
    if (highlightIndex >= 0) {
      colors[highlightIndex] = '#16a34a';
    }

    const averageLinePlugin = {
      id: 'averageLine',
      afterDatasetsDraw(chart) {
        const { ctx, chartArea, scales } = chart;
        const y = scales.y.getPixelForValue(avg);
        ctx.save();
        ctx.setLineDash([6, 6]);
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(chartArea.left, y);
        ctx.lineTo(chartArea.right, y);
        ctx.stroke();
        ctx.setLineDash([]);

        const label = `SÄ±nÄ±f Ort: ${avg.toFixed(1)}`;
        ctx.fillStyle = '#fff';
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 1;
        const padding = 6;
        ctx.font = '12px Plus Jakarta Sans';
        const textWidth = ctx.measureText(label).width;
        const boxX = chartArea.right - textWidth - padding * 2 - 8;
        const boxY = y - 16;
        ctx.beginPath();
        ctx.roundRect(boxX, boxY, textWidth + padding * 2, 20, 6);
        ctx.fill();
        ctx.stroke();
        ctx.fillStyle = '#ef4444';
        ctx.fillText(label, boxX + padding, boxY + 14);
        ctx.restore();
      }
    };

    const starPlugin = {
      id: 'maxStar',
      afterDatasetsDraw(chart) {
        const { ctx, scales } = chart;
        const index = highlightIndex;
        if (index < 0) return;
        const x = scales.x.getPixelForValue(index);
        const y = scales.y.getPixelForValue(nets[index]) - 18;
        ctx.save();
        ctx.font = '16px Plus Jakarta Sans';
        ctx.fillText('â­', x - 8, y);
        ctx.restore();
      }
    };

    const valueLabelPlugin = {
      id: 'valueLabels',
      afterDatasetsDraw(chart) {
        const { ctx, scales } = chart;
        ctx.save();
        ctx.font = '12px Plus Jakarta Sans';
        ctx.fillStyle = '#0f172a';
        nets.forEach((v, i) => {
          const x = scales.x.getPixelForValue(i);
          const y = scales.y.getPixelForValue(v) - 6;
          ctx.fillText(v.toFixed(0), x - 8, y);
        });
        ctx.restore();
      }
    };

    const chart = new window.Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            data: nets,
            backgroundColor: colors,
            borderRadius: { topLeft: 4, topRight: 4 },
            borderSkipped: false,
            hoverBorderColor: '#0f172a',
            hoverBorderWidth: 1,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (items) => {
                const idx = items[0].dataIndex;
                return chartData.rows[idx].name;
              },
              label: (item) => {
                const idx = item.dataIndex;
                const r = chartData.rows[idx];
                const diff = r.net - avg;
                const diffText = diff >= 0 ? `Ort +${diff.toFixed(1)}` : `Ort ${diff.toFixed(1)}`;
                return `Toplam Net: ${r.net.toFixed(1)} (${diffText})`;
              },
              afterBody: (items) => {
                const idx = items[0].dataIndex;
                const d = chartData.rows[idx].details;
                return [
                  `TÃ¼rkÃ§e: ${d.turkce.toFixed(1)}`,
                  `Matematik: ${d.matematik.toFixed(1)}`,
                  `Fen: ${d.fen.toFixed(1)}`,
                  `Sosyal: ${d.inkilap.toFixed(1)}`,
                  `Ä°ngilizce: ${d.ingilizce.toFixed(1)}`,
                ];
              }
            }
          }
        },
        scales: {
          y: {
            min: 0,
            max: 90,
            ticks: { stepSize: 10 },
            grid: { color: '#e0e0e0' }
          },
          x: {
            grid: { display: false },
            ticks: {
              maxRotation: 45,
              minRotation: 0
            }
          }
        },
        animation: {
          duration: 800,
          delay: (ctx) => ctx.dataIndex * 50
        },
        onHover: (evt, elements) => {
          const canvas = evt?.chart?.canvas;
          if (canvas) canvas.style.cursor = elements.length ? 'pointer' : 'default';
        },
        onClick: (evt, elements) => {
          if (!elements.length) return;
          const idx = elements[0].index;
          const studentId = chartData.rows[idx].studentId;
          if (onSelectStudent) onSelectStudent(studentId);
        }
      },
      plugins: [averageLinePlugin, starPlugin, valueLabelPlugin]
    });

    chartInstanceRef.current = chart;

    return () => {
      if (chartInstanceRef.current) {
        chartInstanceRef.current.destroy();
        chartInstanceRef.current = null;
      }
    };
  }, [chartData, onSelectStudent]);

  useEffect(() => {
    if (!radarRef.current) return;
    if (!radarData) {
      if (radarInstanceRef.current) {
        radarInstanceRef.current.destroy();
        radarInstanceRef.current = null;
      }
      return;
    }
    const ctx = radarRef.current.getContext('2d');
    if (radarInstanceRef.current) {
      radarInstanceRef.current.destroy();
      radarInstanceRef.current = null;
    }
    const labels = radarData.subjects.map(s => s.label);
    const values = radarData.values;
    const chart = new window.Chart(ctx, {
      type: 'radar',
      data: {
        labels,
        datasets: [
          {
            data: values,
            fill: true,
            backgroundColor: 'rgba(52, 152, 219, 0.3)',
            borderColor: '#2980b9',
            borderWidth: 2,
            pointBackgroundColor: '#2980b9',
            pointRadius: 4,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          r: {
            min: 0,
            max: 20,
            ticks: { stepSize: 5 },
            grid: { color: '#e0e0e0' },
            angleLines: { color: '#e0e0e0' },
            pointLabels: { color: '#334155', font: { size: 12 } }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (items) => items[0].label,
              label: (item) => {
                const val = item.raw || 0;
                return `Ortalama: ${val.toFixed(1)}`;
              }
            }
          }
        },
        animation: { duration: 1000, easing: 'easeOutQuart' }
      }
    });
    radarInstanceRef.current = chart;
    return () => {
      if (radarInstanceRef.current) {
        radarInstanceRef.current.destroy();
        radarInstanceRef.current = null;
      }
    };
  }, [radarData]);

  const lgsDate = new Date(2026, 5, 14, 9, 30, 0);
  const lgsDaysLeft = Math.max(0, Math.ceil((lgsDate.getTime() - now.getTime()) / dayMs));

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 fade-in">
      <div className="mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">
        <div>
          <h1 className="text-3xl sm:text-4xl font-extrabold" style={{ color: config.text_color }}>Genel BakÄ±ÅŸ</h1>
          <p className="text-sm sm:text-base mt-2" style={{ color: config.secondary_action_color }}>Ã–ÄŸrenci performans Ã¶zeti ve trend analizi</p>
        </div>
        <div className="rounded-2xl p-10 border border-gray-100 shadow-sm w-full text-center justify-self-center max-w-md" style={{ background: 'linear-gradient(135deg, #EFF6FF 0%, #F5F3FF 100%)' }}>
          <div className="text-lg font-semibold" style={{ color: '#3B82F6' }}>LGS 2026</div>
          <div className="text-xl font-bold" style={{ color: '#0F172A' }}>14 Haziran 2026</div>
          <div className="text-lg mt-2" style={{ color: '#64748B' }}>{lgsDaysLeft} gÃ¼n kaldÄ±</div>
        </div>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {loading ? (
          Array.from({ length: 6 }).map((_, i) => (
            <div key={i} className="rounded-2xl p-6 border border-gray-100 animate-pulse" style={{ background: config.surface_color }}>
              <div className="h-4 w-24 rounded bg-gray-200 mb-3"></div>
              <div className="h-8 w-32 rounded bg-gray-200 mb-2"></div>
              <div className="h-3 w-28 rounded bg-gray-200"></div>
            </div>
          ))
        ) : (
          cards.map((c, i) => (
            <div
              key={c.title}
              onClick={c.clickable ? c.onClick : undefined}
              className={`rounded-2xl p-6 border border-gray-100 transition-all ${c.clickable ? 'cursor-pointer hover:shadow-lg hover:scale-[1.03]' : ''} slide-up`}
              style={{ background: config.surface_color, animationDelay: `${i * 0.08}s` }}
            >
              <div className="flex items-start justify-between mb-2">
                <div className="text-sm font-semibold" style={{ color: '#64748b' }}>{c.title}</div>
                <div className="text-2xl">{c.icon}</div>
              </div>
              <div className="text-3xl font-bold" style={{ color: c.color }}>
                {renderValue(c.value, '?')}
              </div>
              <div className="text-xs mt-2" style={{ color: c.subColor || '#94a3b8' }}>{c.sub}</div>
            </div>
          ))
        )}
      </div>

      <div className="mt-8">
        <div className="flex items-center justify-between mb-2">
          <div>
            <h2 className="text-lg font-bold" style={{ color: config.text_color }}>ðŸ“Š Son Ortak Deneme PerformansÄ±</h2>
            <div className="text-sm" style={{ color: config.secondary_action_color }}>{lastExamMeta ? lastExamMeta.title : '?'}</div>
          </div>
          {lastExamMeta && (
            <div className="text-sm font-semibold" style={{ color: config.secondary_action_color }}>{lastExamMeta.count}/{lastExamMeta.total} Ã¶ÄŸrenci katÄ±ldÄ±</div>
          )}
        </div>

        {!hasOrtak ? (
          <div className="rounded-2xl p-6 border border-dashed text-center" style={{ background: config.surface_color, borderColor: '#E2E8F0' }}>
            <p className="text-sm" style={{ color: config.secondary_action_color }}>Hen?z ortak deneme girilmemi?</p>
            <button
              onClick={() => onNavigate && onNavigate('deneme-girisi')}
              className="mt-3 px-4 py-2 rounded-lg text-sm font-semibold text-white"
              style={{ background: config.primary_action_color }}
            >
              Deneme Tan?mla
            </button>
          </div>
        ) : (
          <div className="rounded-2xl p-6 shadow-lg" style={{ background: config.surface_color }}>
            <div className="overflow-x-auto">
              <div style={{ height: 440, minWidth: chartMinWidth }}>
                <canvas ref={chartRef}></canvas>
              </div>
            </div>
          </div>
        )}
      
      <div className="mt-8">
        <div className="rounded-2xl p-8 shadow-lg" style={{ background: config.surface_color, maxWidth: 600, margin: '0 auto' }}>
          <h3 className="text-lg font-bold" style={{ color: config.text_color }}>ðŸŽ¯ Ders BazlÄ± SÄ±nÄ±f OrtalamasÄ±</h3>
          <div className="text-sm mt-1" style={{ color: config.secondary_action_color }}>TÃ¼m ortak denemelerin genel ortalamasÄ±</div>
          <div className="mt-5 flex justify-center">
            {radarData ? (
              <div className="w-full flex justify-center">
                <div style={{ width: '100%', maxWidth: 450, height: 450 }}>
                  <canvas ref={radarRef}></canvas>
                </div>
              </div>
            ) : (
              <div className="w-full text-center py-10 rounded-xl border border-dashed" style={{ color: config.secondary_action_color }}>Ders analizi iÃ§in ortak deneme verisi gerekli</div>
            )}
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-6">
            <div className="rounded-xl p-4 border" style={{ background: '#d5f4e6', borderColor: '#27ae60' }}>
              <div className="text-xs font-semibold" style={{ color: '#14532d' }}>ðŸ† En gÃ¼Ã§lÃ¼</div>
              <div className="text-sm font-bold mt-1" style={{ color: '#14532d' }}>
                {radarData && radarData.hasAny && radarData.subjects[radarData.maxIdx] ? radarData.subjects[radarData.maxIdx].label : 'â€”'}
              </div>
              <div className="text-xs" style={{ color: '#14532d' }}>{radarData && radarData.hasAny ? `${radarData.maxVal.toFixed(1)} net` : ''}</div>
            </div>
            <div className="rounded-xl p-4 border" style={{ background: '#fef5e7', borderColor: '#f39c12' }}>
              <div className="text-xs font-semibold" style={{ color: '#7c2d12' }}>âš ï¸ En zayÄ±f</div>
              <div className="text-sm font-bold mt-1" style={{ color: '#7c2d12' }}>
                {radarData && radarData.hasAny && radarData.subjects[radarData.minIdx] ? radarData.subjects[radarData.minIdx].label : 'â€”'}
              </div>
              <div className="text-xs" style={{ color: '#7c2d12' }}>{radarData && radarData.hasAny ? `${radarData.minVal.toFixed(1)} net` : ''}</div>
            </div>
            <div className="rounded-xl p-4 border" style={{ background: '#EEF2FF', borderColor: '#6366F1' }}>
              <div className="text-xs font-semibold" style={{ color: '#3730A3' }}>ðŸ“Š SÄ±ralama</div>
              <div className="mt-2 space-y-1 text-xs" style={{ color: '#3730A3' }}>
                {radarData && radarData.hasAny ? (
                  [...radarData.subjects.map((s, i) => ({ label: s.label, val: radarData.values[i] }))]
                    .sort((a, b) => b.val - a.val)
                    .map((s, i) => (
                      <div key={i} className="flex items-center justify-between">
                        <span>{s.label}</span>
                        <span className="font-semibold">{s.val.toFixed(1)}</span>
                      </div>
                    ))
                ) : (
                  <div>â€”</div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div className="rounded-2xl p-6 shadow-lg" style={{ background: config.surface_color }}>
          <div className="mb-4">
            <h3 className="text-lg font-bold" style={{ color: config.text_color }}>ðŸš¨ Dikkat Gerekli Ã–ÄŸrenciler</h3>
            <div className="text-sm" style={{ color: config.secondary_action_color }}>Son denemelerde performans dÃ¼ÅŸÃ¼ÅŸÃ¼</div>
          </div>

          {(weeklyNoStudy.length === 0 && declineStudents.length === 0) ? (
            <div className="rounded-xl p-4 text-sm" style={{ background: '#e8f8f5', color: '#0f766e' }}>
              âœ… Harika! TÃ¼m Ã¶ÄŸrenciler aktif ve baÅŸarÄ±lÄ±
            </div>
          ) : (
            <div className="space-y-4">
              <div className="rounded-xl p-4" style={{ background: '#fff9e6' }}>
                <div className="text-xs font-semibold mb-2" style={{ color: '#8a6d3b' }}>
                  âš ï¸ Bu Hafta Ã‡alÄ±ÅŸma Getirmeyen ({weeklyNoStudy.length} Ã¶ÄŸrenci)
                </div>
                <div className="space-y-2">
                  {weeklyNoStudy.slice(0, 5).map(s => (
                    <div key={s.id} onClick={() => onSelectStudent && onSelectStudent(s.id)} className="flex items-center justify-between text-sm cursor-pointer hover:bg-white/60 px-2 py-1 rounded">
                      <span>{s.name}</span>
                      <span style={{ color: '#6b7280' }}>{s.days} gÃ¼ndÃ¼r Ã§alÄ±ÅŸma yok</span>
                    </div>
                  ))}
                  {weeklyNoStudy.length > 5 && (
                    <div className="text-xs" style={{ color: '#6b7280' }}>+{weeklyNoStudy.length - 5} Ã¶ÄŸrenci daha</div>
                  )}
                </div>
              </div>

              <div className="rounded-xl p-4" style={{ background: '#ffe6e6' }}>
                <div className="text-xs font-semibold mb-2" style={{ color: '#b91c1c' }}>
                  ðŸ“‰ Son 2-3 Denemede Net DÃ¼ÅŸÃ¼ÅŸÃ¼ ({declineStudents.length} Ã¶ÄŸrenci)
                </div>
                <div className="space-y-2">
                  {declineStudents.slice(0, 5).map(s => (
                    <div key={s.id} onClick={() => onSelectStudent && onSelectStudent(s.id)} className="flex items-center justify-between text-sm cursor-pointer hover:bg-white/60 px-2 py-1 rounded">
                      <span>{s.name}</span>
                      <span className="font-semibold" style={{ color: '#ef4444' }}>{s.drop.toFixed(1)} net</span>
                    </div>
                  ))}
                  {declineStudents.length > 5 && (
                    <div className="text-xs" style={{ color: '#6b7280' }}>+{declineStudents.length - 5} Ã¶ÄŸrenci daha</div>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>

        <div className="rounded-2xl p-6 shadow-lg" style={{ background: config.surface_color }}>
          <div className="mb-4">
            <h3 className="text-lg font-bold" style={{ color: config.text_color }}>ðŸ“ Son Aktiviteler</h3>
            <div className="text-sm" style={{ color: config.secondary_action_color }}>Son veri giriÅŸleri</div>
          </div>
          <div className="relative pl-6">
            <div className="absolute left-2 top-0 bottom-0 w-px" style={{ background: '#e2e8f0' }}></div>
            <div className="space-y-4">
              {recentActivities.length === 0 ? (
                <div className="text-sm" style={{ color: config.secondary_action_color }}>HenÃ¼z aktivite yok</div>
              ) : recentActivities.map((a, i) => {
                const timeText = a.ago || 'Az Ã¶nce';
                return (
                  <div key={i} className="relative">
                    <div className="absolute -left-[18px] top-1.5 w-3 h-3 rounded-full" style={{ background: a.type === 'exam' ? '#3B82F6' : '#10B981' }}></div>
                    <div className="text-xs" style={{ color: '#94a3b8' }}>{timeText}</div>
                    <div className="text-sm" style={{ color: config.text_color }}>
                      {a.type === 'exam' ? 'ðŸ“Š ' : 'âœï¸ '}{a.text}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      </div>
</div>

      {showRiskModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 fade-in" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>Riskli Ã–ÄŸrenciler</h3>
              <button onClick={() => setShowRiskModal(false)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            {riskStudents.length === 0 ? (
              <div className="text-sm" style={{ color: config.secondary_action_color }}>Riskli Ã¶ÄŸrenci bulunamadÄ±</div>
            ) : (
              <div className="space-y-2">
                {riskStudents.map(s => (
                  <div key={s.studentId} className="flex items-center justify-between px-3 py-2 rounded-lg" style={{ background: '#F8FAFC' }}>
                    <div className="text-sm" style={{ color: config.text_color }}>{s.name}</div>
                    <div className="text-xs" style={{ color: '#ef4444' }}>{s.prevNet.toFixed(1)} ? {s.lastNet.toFixed(1)} ({s.diff.toFixed(1)})</div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {showDropModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style={{background:'rgba(0,0,0,0.4)'}}>
          <div className="rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 fade-in" style={{background: config.surface_color}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: config.text_color }}>BÃ¼yÃ¼k DÃ¼ÅŸÃ¼ÅŸ YaÅŸayanlar</h3>
              <button onClick={() => setShowDropModal(false)} className="p-1.5 rounded-lg hover:bg-gray-100"><Icons.X size={18}/></button>
            </div>
            {bigDropStudents.length === 0 ? (
              <div className="text-sm" style={{ color: config.secondary_action_color }}>BÃ¼yÃ¼k dÃ¼ÅŸÃ¼ÅŸ yaÅŸayan Ã¶ÄŸrenci yok</div>
            ) : (
              <div className="space-y-2">
                {bigDropStudents.map(s => (
                  <div key={s.studentId} className="flex items-center justify-between px-3 py-2 rounded-lg" style={{ background: '#F8FAFC' }}>
                    <div className="text-sm" style={{ color: config.text_color }}>{s.name}</div>
                    <div className="text-xs" style={{ color: '#ef4444' }}>{s.prevNet.toFixed(1)} ? {s.lastNet.toFixed(1)} ({s.diff.toFixed(1)})</div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
function App() {
  const { route, navigate } = useRouter();
  const config = useConfig();
  const [selectedStudentId, setSelectedStudentId] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(() => {
    return localStorage.getItem('appAuthenticated') === 'true';
  });

  const handleLogin = () => {
    setIsAuthenticated(true);
  };

  const handleLogout = () => {
    localStorage.removeItem('appAuthenticated');
    setIsAuthenticated(false);
  };

  if (!isAuthenticated) {
    return <LoginPage onLogin={handleLogin} config={config} />;
  }

  const fontStack = `${config.font_family}, 'Plus Jakarta Sans', sans-serif`;
  const baseFontSize = config.font_size || 16;

  const renderPage = () => {
    switch(route) {
      case 'ogrenciler': return <StudentsPage config={config} onSelectStudent={(id) => { setSelectedStudentId(id); navigate('ogrenci-detay'); }} />;
      case 'ogrenci-detay': return <StudentDetailPage config={config} studentId={selectedStudentId} onBack={() => navigate('ogrenciler')} />;
      case 'gunluk-calisma': return <StudyPage config={config}/>;
      case 'deneme-girisi': return <ExamPage config={config}/>;
      case 'dashboard': return <DashboardPage config={config} onSelectStudent={(id) => { setSelectedStudentId(id); navigate('ogrenci-detay'); }} onNavigate={navigate} />;
      default: return <HomePage navigate={navigate} config={config}/>;
    }
  };

  return (
    <div className="h-full w-full flex flex-col overflow-auto" style={{ background: config.background_color, fontFamily: fontStack, fontSize: `${baseFontSize}px` }}>
      <Header route={route} navigate={navigate} config={config} onLogout={handleLogout}/>
      <main className="flex-1">
        {renderPage()}
      </main>
      <footer className="text-center py-4 border-t border-gray-100" style={{background: config.surface_color}}>
        <p className="text-xs" style={{color: config.secondary_action_color}}>Â© 2024 {config.app_title}</p>
      </footer>
    </div>
  );
}
function LoginPage({ onLogin, config }) {
  const [password, setPassword] = useState('');
  const [err, setErr] = useState('');

  const handleSubmit = (e) => {
    if (e && e.preventDefault) e.preventDefault();
    const real = (window.__APP_CONFIG && window.__APP_CONFIG.LOGIN_PASSWORD) || '';
    if (password === real) {
      localStorage.setItem('appAuthenticated', 'true');
      onLogin();
    } else {
      setErr('HatalÄ± ÅŸifre');
    }
  };

  return (
    <div className="h-full flex items-center justify-center" style={{ background: config.background_color }}>
      <div className="w-full max-w-md p-6 rounded-2xl" style={{ background: config.surface_color }}>
        <h2 className="text-xl font-bold mb-2" style={{ color: config.text_color }}>{config.welcome_title}</h2>
        <p className="text-sm mb-4" style={{ color: config.secondary_action_color }}>{config.welcome_subtitle}</p>
        <form onSubmit={handleSubmit} className="space-y-3">
          <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Åžifre" className="w-full px-4 py-3 rounded-lg border" style={{ borderColor: '#E2E8F0', color: config.text_color }} />
          {err ? <div className="text-sm text-red-500">{err}</div> : null}
          <div className="flex justify-end">
            <button type="submit" className="px-4 py-2 rounded-lg text-white" style={{ background: config.primary_action_color }}>GiriÅŸ</button>
          </div>
        </form>
      </div>
    </div>
  );
}

(async function init() {
  const dataHandler = {
    onDataChanged(data) {
      notifyDataChange(data);
    }
  };
  const dataResult = await window.dataSdk.init(dataHandler);
  if (!dataResult.isOk) {
    console.error('Data SDK init failed');
  }

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange: async (config) => {
        notifyConfigChange(config);
        const fontStack = `${config.font_family || defaultConfig.font_family}, 'Plus Jakarta Sans', sans-serif`;
        const baseSize = config.font_size || defaultConfig.font_size;
        document.body.style.fontFamily = fontStack;
        document.body.style.fontSize = `${baseSize}px`;
        const wrapper = document.getElementById('root');
        if (wrapper) wrapper.style.background = config.background_color || defaultConfig.background_color;
      },
      mapToCapabilities: (config) => ({
        recolorables: [
          { get: () => config.background_color || defaultConfig.background_color, set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
          { get: () => config.surface_color || defaultConfig.surface_color, set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); } },
          { get: () => config.text_color || defaultConfig.text_color, set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); } },
          { get: () => config.primary_action_color || defaultConfig.primary_action_color, set: (v) => { config.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); } },
          { get: () => config.secondary_action_color || defaultConfig.secondary_action_color, set: (v) => { config.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); } },
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (v) => { config.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (v) => { config.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
        },
      }),
      mapToEditPanelValues: (config) => new Map([
        ['app_title', config.app_title || defaultConfig.app_title],
        ['welcome_title', config.welcome_title || defaultConfig.welcome_title],
        ['welcome_subtitle', config.welcome_subtitle || defaultConfig.welcome_subtitle],
      ]),
    });
  }

  ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
})();
</script>
</body>
</html>
